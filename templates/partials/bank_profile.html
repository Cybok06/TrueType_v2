<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bank Profile - {{ bank.bank_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root{ --ink:#0b1320; --muted:#475569; --line:#e2e8f0; --soft:#f8fafc; --brand:#0d6efd; --ok:#198754; --warn:#d9480f }
    html,body{height:100%}
    body{
      background: radial-gradient(1200px 800px at 10% -10%, #eef2f7 0%, #ffffff 60%) no-repeat,
                  linear-gradient(to right, #f8f9fa 0%, #eef2f7 100%);
      font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
      color: var(--ink);
    }
    .section-header{font-weight:700;color:var(--brand); letter-spacing:.2px}
    .card-title{font-size:1.15rem;font-weight:650}
    .summary-value{font-size:1.05rem;color:var(--ok);font-weight:700}
    .summary-subvalue{font-size:1rem;font-weight:650;color:#0b7285}
    .summary-subvalue.negative{color:var(--warn)}
    .table-wrap{background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    table thead th{ background:#f8fafc; position:sticky; top:0; z-index:2; border-bottom:1px solid var(--line); }
    .pill{border-radius:999px;padding:.2rem .6rem;font-size:.8rem}
    .pill-warn{background:#fff4e6;color:var(--warn)}
    .spinner-row td{padding:1.25rem !important}
    @media print{ .no-print{display:none !important} body{background:#fff} .container{max-width:100% !important} }
  </style>
</head>
<body>
<!-- Root carries ALL values as data-* (NO tojson in scripts) -->
<div class="container py-4" id="bank-root"
     data-bank-id="{{ bank._id }}"
     data-bank="{{ bank.bank_name|e }}"
     data-branch="{{ bank.branch|e }}"
     data-acc="{{ bank.account_number|e }}"
     data-account-name="{{ bank.account_name|e }}"
     data-start="{{ start_date or '' }}"
     data-end="{{ end_date or '' }}"
     data-manual-in="{{ '%.2f'|format(manual_in_sum or 0) }}"
     data-manual-out="{{ '%.2f'|format(manual_out_sum or 0) }}"
     data-ptax-out-total="{{ '%.2f'|format(ptax_out_total or 0) }}"
     data-bdc-out-total="{{ '%.2f'|format(bdc_out_total or 0) }}"
     data-can-manage="{{ 1 if can_manage_txn else 0 }}">

  <!-- Top Bar -->
  <div class="d-flex align-items-center justify-content-between no-print">
    <button onclick="history.back()" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <div class="d-flex gap-2 flex-wrap">
      <button id="btnExportPDF" class="btn btn-danger"><i class="bi bi-filetype-pdf me-1"></i> Export PDF</button>
      <button id="btnExportXLSX" class="btn btn-success"><i class="bi bi-filetype-xlsx me-1"></i> Export Excel</button>
      <button id="btnExportCSV" class="btn btn-primary"><i class="bi bi-filetype-csv me-1"></i> Export CSV</button>
      <button id="btnPrint" class="btn btn-outline-dark"><i class="bi bi-printer me-1"></i> Print</button>
      {% if can_manage_txn %}
        <button id="btnManualDeposit" class="btn btn-outline-success"><i class="bi bi-plus-circle me-1"></i> Deposit</button>
        <button id="btnManualWithdraw" class="btn btn-outline-warning"><i class="bi bi-dash-circle me-1"></i> Withdraw</button>
        <button id="btnManualTransfer" class="btn btn-outline-primary"><i class="bi bi-arrow-left-right me-1"></i> Transfer</button>
      {% endif %}
    </div>
  </div>

  <!-- Header -->
  <div class="d-flex align-items-center mt-3 mb-3">
    <i class="bi bi-bank fs-3 text-primary me-2"></i>
    <h4 class="section-header mb-0">{{ bank.bank_name }} – {{ bank.branch }}</h4>
  </div>

  <!-- Bank Summary -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
      <div class="mb-3 mb-md-0">
        <h6 class="card-title mb-1"><i class="bi bi-person-vcard text-secondary me-1"></i> {{ bank.account_name }}</h6>
        <div class="text-muted"><strong>Account Number:</strong> {{ bank.account_number }}</div>
        <div class="text-muted"><strong>Branch:</strong> {{ bank.branch }}</div>
      </div>
      <div class="text-md-end">
        <div class="summary-value" id="summaryTotal" data-val="{{ '%.2f'|format(total_received) }}">Cash Ins: GHS {{ '%.2f'|format(total_received) }}</div>
        <div class="summary-subvalue mt-1" id="currentBalance">Current Balance: GHS 0.00</div>
        {% if start_date or end_date %}
        <div class="text-muted mt-1">
          Period:
          <span class="badge rounded-pill border px-3 py-2">{{ start_date or '—' }} → {{ end_date or '—' }}</span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- OMCs with S-Tax Debt -->
  <div class="table-wrap mb-4">
    <div class="d-flex justify-content-between align-items-center p-3 pb-2">
      <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-1 text-warning"></i> OMCs with P-Tax Debt</h6>
      <span class="pill pill-warn" id="debtSummary" style="display:none"></span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="omcDebtTable">
        <thead>
          <tr>
            <th>OMC</th>
            <th class="text-end">Outstanding (GHS)</th>
            <th class="text-end">Action</th> <!-- removed Orders Unpaid -->
          </tr>
        </thead>
        <tbody>
          <tr class="spinner-row"><td colspan="3" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- BDCs waiting bank payment -->
  <div class="table-wrap mb-4">
    <div class="d-flex justify-content-between align-items-center p-3 pb-2">
      <h6 class="mb-0"><i class="bi bi-exclamation-circle me-1 text-danger"></i> BDCs Waiting Bank Payment</h6>
      <span class="pill pill-warn" id="bdcDebtSummary" style="display:none"></span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="bdcDebtTable">
        <thead>
          <tr>
            <th>BDC</th>
            <th class="text-end">Outstanding (GHS)</th>
            <th class="text-end">Action</th> <!-- removed Unpaid Items -->
          </tr>
        </thead>
        <tbody>
          <tr class="spinner-row"><td colspan="3" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Confirmed inbound payments -->
  <div id="exportArea" class="table-wrap shadow-sm mb-5">
    <div class="d-flex justify-content-between align-items-center p-3 pb-0">
      <h6 class="mb-2"><i class="bi bi-cash-coin me-1"></i> Confirmed Payments</h6>
    </div>
    <div class="table-responsive">
      <table id="paymentsTable" class="table table-striped table-hover table-bordered mb-0">
        <thead>
          <tr>
            <th style="width:70px">#</th>
            <th>Date</th>
            <th>Amount (GHS)</th>
            <th>Last 4 Digits</th>
            <th>Proof</th>
          </tr>
        </thead>
        <tbody id="tbPayments">
          <tr class="spinner-row"><td colspan="5" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2" class="text-end">Total</th>
            <th id="tableTotal" data-total="{{ '%.2f'|format(total_received) }}">GHS {{ '%.2f'|format(total_received) }}</th>
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center p-2 border-top bg-light">
      <small class="text-muted" id="metaPayments">Showing 0 of 0</small>
      <button class="btn btn-sm btn-outline-primary" id="btnMorePayments" data-skip="0" style="display:none;">View more</button>
    </div>
  </div>

  <div class="table-wrap shadow-sm mb-4">
    <div class="p-3 pb-0">
      <h6 class="mb-2"><i class="bi bi-journal-check me-1"></i> P-Tax Payments From This Bank</h6>
    </div>
    <div class="table-responsive">
      <table id="bankTaxTable" class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>OMC</th>
            <th>Order ID</th>
            <th class="text-end">Qty (L)</th>
            <th class="text-end">S-TAX /L</th>
            <th class="text-end">Amount (GHS)</th>
            <th>Reference</th>
            <th>Paid By</th>
          </tr>
        </thead>
        <tbody id="tbPTax">
          <tr class="spinner-row"><td colspan="8" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center p-2 border-top bg-light">
      <small class="text-muted" id="metaPTax">Showing 0 of 0</small>
      <button class="btn btn-sm btn-outline-primary" id="btnMorePTax" data-skip="0" style="display:none;">View more</button>
    </div>
  </div>

  <!-- BDC Payments From This Bank -->
  <div class="table-wrap">
    <div class="p-3 pb-0">
      <h6 class="mb-2"><i class="bi bi-journal-text me-1"></i> BDC Payments From This Bank</h6>
    </div>
    <div class="table-responsive">
      <table id="bankBdcTable" class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>BDC</th>
            <th>Type</th>
            <th>Order ID</th>
            <th class="text-end">Qty (L)</th>
            <th class="text-end">S-BDC /L</th>
            <th class="text-end">Amount (GHS)</th>
            <th>Reference</th>
            <th>Paid By</th>
          </tr>
        </thead>
        <tbody id="tbBankBdc">
          <tr class="spinner-row"><td colspan="9" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center p-2 border-top bg-light">
      <small class="text-muted" id="metaBankBdc">Showing 0 of 0</small>
      <button class="btn btn-sm btn-outline-primary" id="btnMoreBankBdc" data-skip="0" style="display:none;">View more</button>
    </div>
  </div>

  <!-- Manual Transactions -->
  <div class="table-wrap mt-4">
    <div class="p-3 pb-0">
      <h6 class="mb-2"><i class="bi bi-arrow-left-right me-1"></i> Manual Transactions</h6>
    </div>
    <div class="table-responsive">
      <table id="manualTxnTable" class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Reference</th>
            <th>Narration</th>
            <th class="text-end">In (GHS)</th>
            <th class="text-end">Out (GHS)</th>
            <th>Counterparty</th>
            <th>Created By</th>
          </tr>
        </thead>
        <tbody id="tbManual">
          <tr class="spinner-row"><td colspan="8" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center p-2 border-top bg-light">
      <small class="text-muted" id="metaManual">Showing 0 of 0</small>
      <button class="btn btn-sm btn-outline-primary" id="btnMoreManual" data-skip="0" style="display:none;">View more</button>
    </div>
  </div>

  {% if can_manage_txn %}
  <!-- Confirm Transfer Modal -->
  <div class="modal fade" id="confirmTransferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Transfer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning small mb-3">
            Please confirm this transfer. This action will affect both bank balances.
          </div>

          <dl class="row small mb-0">
            <dt class="col-5 text-muted">From</dt><dd class="col-7" id="cfFrom"></dd>
            <dt class="col-5 text-muted">To</dt><dd class="col-7" id="cfTo"></dd>
            <dt class="col-5 text-muted">Amount</dt><dd class="col-7 fw-semibold" id="cfAmount"></dd>
            <dt class="col-5 text-muted">Date</dt><dd class="col-7" id="cfDate"></dd>
            <dt class="col-5 text-muted">Reference</dt><dd class="col-7" id="cfRef"></dd>
            <dt class="col-5 text-muted">Narration</dt><dd class="col-7" id="cfNar"></dd>
          </dl>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="btnEditTransfer">
            Back & Edit
          </button>
          <button type="button" class="btn btn-primary" id="btnConfirmTransfer">
            <span class="btn-label">Confirm Transfer</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Deposit Modal -->
  <div class="modal fade" id="manualDepositModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="manualDepositForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Manual Deposit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <div class="col-6">
            <label class="form-label">Amount (GHS)</label>
            <input type="number" step="0.01" class="form-control" id="manualDepositAmount" required>
          </div>
          <div class="col-6">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="manualDepositDate" required>
          </div>
          <div class="col-6">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" id="manualDepositRef">
          </div>
          <div class="col-6">
            <label class="form-label">Narration</label>
            <input type="text" class="form-control" id="manualDepositNarr">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="submit">Save Deposit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manual Withdraw Modal -->
  <div class="modal fade" id="manualWithdrawModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="manualWithdrawForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Manual Withdrawal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <div class="col-6">
            <label class="form-label">Amount (GHS)</label>
            <input type="number" step="0.01" class="form-control" id="manualWithdrawAmount" required>
          </div>
          <div class="col-6">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="manualWithdrawDate" required>
          </div>
          <div class="col-6">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" id="manualWithdrawRef">
          </div>
          <div class="col-6">
            <label class="form-label">Narration</label>
            <input type="text" class="form-control" id="manualWithdrawNarr">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-warning" type="submit">Save Withdrawal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div class="modal fade" id="manualTransferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="manualTransferForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Transfer Between Banks</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <div class="col-12">
            <label class="form-label">From Bank</label>
            <select class="form-select" id="transferFromBank" required>
              {% for b in bank_list %}
                <option value="{{ b._id }}" {% if b._id == bank._id %}selected{% endif %}>
                  {{ b.bank_name or b.account_name or 'Bank' }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">To Bank</label>
            <select class="form-select" id="transferToBank" required>
              {% for b in bank_list %}
                <option value="{{ b._id }}" {% if b._id == bank._id %}disabled{% endif %}>
                  {{ b.bank_name or b.account_name or 'Bank' }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6">
            <label class="form-label">Amount (GHS)</label>
            <input type="number" step="0.01" class="form-control" id="transferAmount" required>
          </div>
          <div class="col-6">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="transferDate" required>
          </div>
          <div class="col-6">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" id="transferRef">
          </div>
          <div class="col-6">
            <label class="form-label">Narration</label>
            <input type="text" class="form-control" id="transferNarr">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Review Transfer</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Pay OMC Modal -->
  <div class="modal fade" id="payOmcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="payOmcForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Pay OMC P-Tax (Partial Allowed)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <!-- Hidden not required by JS, but fine to keep -->
          <input type="hidden" id="bankId" value="{{ bank._id }}">
          <div class="col-12">
            <label class="form-label">OMC</label>
            <input type="text" class="form-control" id="omcName" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Outstanding (GHS)</label>
            <input type="text" class="form-control" id="omcOutstanding" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Orders Unpaid</label>
            <input type="text" class="form-control" id="omcOrders" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Amount (GHS)</label>
            <input type="number" step="0.01" class="form-control" id="payAmount" required>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Date</label>
            <input type="date" class="form-control" id="payDate" required>
          </div>
          <div class="col-6">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" id="payRef" placeholder="e.g. BANK-TXN-123">
          </div>
          <div class="col-6">
            <label class="form-label">Paid By</label>
            <input type="text" class="form-control" id="payBy" value="{{ bank.account_name }}" required>
          </div>
          <div class="col-12">
            <small class="text-muted">Allocation is automatic from oldest unpaid order to newest for this OMC.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="payOmcSubmit" class="btn btn-primary" type="submit"><i class="bi bi-check2-circle me-1"></i> Make Payment</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pay BDC Modal -->
  <div class="modal fade" id="payBdcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="payBdcForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Pay BDC</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <input type="hidden" id="bankId2" value="{{ bank._id }}">
          <input type="hidden" id="bdcId">
          <div class="col-12">
            <label class="form-label">BDC</label>
            <input type="text" class="form-control" id="bdcName" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Outstanding (GHS)</label>
            <input type="text" class="form-control" id="bdcOutstanding" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Unpaid Items</label>
            <input type="text" class="form-control" id="bdcItems" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Amount (GHS)</label>
            <input type="number" step="0.01" class="form-control" id="bdcPayAmount" required>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Date</label>
            <input type="date" class="form-control" id="bdcPayDate" required>
          </div>
          <div class="col-6">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" id="bdcPayRef" placeholder="e.g. BANK-TXN-456">
          </div>
          <div class="col-6">
            <label class="form-label">Paid By</label>
            <input type="text" class="form-control" id="bdcPayBy" value="{{ bank.account_name }}" required>
          </div>
          <div class="col-12">
            <small class="text-muted">Allocation is automatic from oldest unpaid item to newest for this BDC.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="payBdcSubmit" class="btn btn-primary" type="submit"><i class="bi bi-check2-circle me-1"></i> Make Payment</button>
        </div>
      </form>
    </div>
  </div>

</div> <!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // ====== Read all values from data-* (NO tojson) ======
  const root = document.getElementById('bank-root');
  const BANK_ID = (root.dataset.bankId || '').trim();
  const ACCOUNT_NAME = root.dataset.accountName || '';
  const MANUAL_IN = parseFloat(root.dataset.manualIn || '0') || 0;
  const MANUAL_OUT = parseFloat(root.dataset.manualOut || '0') || 0;
  const PTAX_OUT_TOTAL = parseFloat(root.dataset.ptaxOutTotal || '0') || 0;
  const BDC_OUT_TOTAL = parseFloat(root.dataset.bdcOutTotal || '0') || 0;
  const CAN_MANAGE = root.dataset.canManage === '1';
  const enc = s => encodeURIComponent(String(s || ''));

  function getMeta(){
    return {
      bank: root.dataset.bank || '',
      branch: root.dataset.branch || '',
      acc: root.dataset.acc || '',
      start: root.dataset.start || '',
      end: root.dataset.end || ''
    };
  }
  function buildUrl(base, params){
    const u = new URL(base, window.location.origin);
    Object.entries(params || {}).forEach(([k, v]) => {
      if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, v);
    });
    return u.toString();
  }

  // ---------- Helpers ----------
  function sanitizeFilename(s){ return (s||'export').toString().replace(/[\\\/:*?"<>|]/g,'-').replace(/\s+/g,'_'); }
  function tableToArray(tableId){
    const table = document.getElementById(tableId);
    if(!table) return {headers:[], rows:[]};
    const headers = Array.from(table.querySelectorAll('thead th')).map(th=>th.textContent.trim());
    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr=> Array.from(tr.children).map(td=> {
      const text = td.textContent.trim();
      const numAttr = td.getAttribute('data-num');
      if (numAttr !== null){
        const n = parseFloat(numAttr.replace(/,/g,'')); return isNaN(n) ? text : n;
      }
      return text;
    }));
    return { headers, rows };
  }
  function toCSV(headers, rows){
    const esc = v => { if (v==null) return ''; const s=(''+v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s; };
    return [headers.map(esc).join(','), ...rows.map(r=>r.map(esc).join(','))].join('\n');
  }
  function saveBlob(content, mime, filename){
    const blob = new Blob([content], {type: mime});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }
  const parseMoneyText = txt => { const n = parseFloat(String(txt||'').replace(/[^\d.-]/g,'')); return isNaN(n) ? 0 : n; };
  const fmt2 = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  function showToast(msg){
    const container = document.getElementById('toastContainer') || (function(){
      const c = document.createElement('div');
      c.id = 'toastContainer';
      c.className = 'position-fixed bottom-0 end-0 p-3';
      c.style.zIndex = '2000';
      document.body.appendChild(c);
      return c;
    })();
    const toastEl = document.createElement('div');
    toastEl.className = 'toast align-items-center text-bg-success border-0';
    toastEl.setAttribute('role','alert');
    toastEl.setAttribute('aria-live','assertive');
    toastEl.setAttribute('aria-atomic','true');
    toastEl.innerHTML = '<div class="d-flex"><div class="toast-body">' + msg +
      '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>';
    container.appendChild(toastEl);
    const bsToast = new bootstrap.Toast(toastEl, {delay: 2500});
    bsToast.show();
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
  }

  async function loadSection({ baseUrl, tbody, metaEl, btnEl, renderRow, batch = 10, first = false, extraParams = {} }) {
    const skip = parseInt(btnEl.dataset.skip || '0', 10);
    const limit = first ? 3 : batch;
    const url = buildUrl(baseUrl, { skip: skip, limit: limit, ...extraParams });

    btnEl.disabled = true;
    btnEl.textContent = 'Loading...';

    const res = await fetch(url, { cache: 'no-store' });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to load');

    if (first) tbody.innerHTML = '';

    (data.items || []).forEach((item, idx) => {
      tbody.insertAdjacentHTML('beforeend', renderRow(item, skip + idx + 1));
    });

    const newSkip = skip + (data.items || []).length;
    btnEl.dataset.skip = String(newSkip);

    const total = data.total || 0;
    const shown = Math.min(newSkip, total);
    metaEl.textContent = `Showing ${shown} of ${total}`;

    if (data.has_more) {
      btnEl.style.display = '';
      btnEl.disabled = false;
      btnEl.textContent = 'View more';
    } else {
      btnEl.style.display = 'none';
    }

    if (total === 0 && first) {
      tbody.innerHTML = `<tr><td colspan="99" class="text-center text-muted py-3">No records found.</td></tr>`;
      metaEl.textContent = 'Showing 0 of 0';
      btnEl.style.display = 'none';
    }
  }

  function renderPaymentRow(p, idx){
    const proof = p.proof_url
      ? `<a href="${p.proof_url}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-earmark-image"></i> View</a>`
      : `<span class="text-muted">None</span>`;
    return `
      <tr>
        <td>${idx}</td>
        <td>${p.date_str || '—'}</td>
        <td class="text-end">${fmt2(p.amount || 0)}</td>
        <td>${p.account_last4 || '—'}</td>
        <td>${proof}</td>
      </tr>
    `;
  }
  function renderPTaxRow(r){
    return `
      <tr>
        <td>${r.payment_date_str || '—'}</td>
        <td>${r.omc || '—'}</td>
        <td>${r.order_id || '—'}</td>
        <td class="text-end">${Number(r.quantity || 0).toLocaleString()}</td>
        <td class="text-end">${fmt2(r.s_tax_per_l || 0)}</td>
        <td class="text-end">${fmt2(r.amount || 0)}</td>
        <td>${r.reference || '—'}</td>
        <td>${r.paid_by || '—'}</td>
      </tr>
    `;
  }
  function renderBdcRow(r){
    return `
      <tr>
        <td>${r.payment_date_str || '—'}</td>
        <td>${r.bdc || '—'}</td>
        <td>${r.ptype || '—'}</td>
        <td>${r.order_id || '—'}</td>
        <td class="text-end">${Number(r.quantity || 0).toLocaleString()}</td>
        <td class="text-end">${fmt2(r.s_bdc_per_l || 0)}</td>
        <td class="text-end">${fmt2(r.amount || 0)}</td>
        <td>${r.reference || '—'}</td>
        <td>${r.paid_by || '—'}</td>
      </tr>
    `;
  }
  function renderManualRow(r){
    const t = r.type || '';
    const typeLabel = String(t).replaceAll('_',' ').replace(/\b\w/g, c => c.toUpperCase());
    return `
      <tr>
        <td>${r.txn_date_str || '—'}</td>
        <td>${typeLabel}</td>
        <td>${r.reference || '-'}</td>
        <td>${r.narration || '-'}</td>
        <td class="text-end">${['deposit','transfer_in'].includes(t) ? fmt2(r.amount || 0) : '-'}</td>
        <td class="text-end">${['withdrawal','transfer_out'].includes(t) ? fmt2(r.amount || 0) : '-'}</td>
        <td>${r.counterparty || '-'}</td>
        <td>${r.created_by || '-'}</td>
      </tr>
    `;
  }

  // ---------- Manual Transactions ----------
  if (CAN_MANAGE) {
    let transferPayload = null;
    document.getElementById('btnManualDeposit')?.addEventListener('click', () => {
      document.getElementById('manualDepositAmount').value = '';
      document.getElementById('manualDepositDate').value = new Date().toISOString().slice(0,10);
      document.getElementById('manualDepositRef').value = '';
      document.getElementById('manualDepositNarr').value = '';
      new bootstrap.Modal(document.getElementById('manualDepositModal')).show();
    });
    document.getElementById('btnManualWithdraw')?.addEventListener('click', () => {
      document.getElementById('manualWithdrawAmount').value = '';
      document.getElementById('manualWithdrawDate').value = new Date().toISOString().slice(0,10);
      document.getElementById('manualWithdrawRef').value = '';
      document.getElementById('manualWithdrawNarr').value = '';
      new bootstrap.Modal(document.getElementById('manualWithdrawModal')).show();
    });
    document.getElementById('btnManualTransfer')?.addEventListener('click', () => {
      document.getElementById('transferAmount').value = '';
      document.getElementById('transferDate').value = new Date().toISOString().slice(0,10);
      document.getElementById('transferRef').value = '';
      document.getElementById('transferNarr').value = '';
      new bootstrap.Modal(document.getElementById('manualTransferModal')).show();
    });

    document.getElementById('manualDepositForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        amount: document.getElementById('manualDepositAmount').value,
        txn_date: document.getElementById('manualDepositDate').value,
        reference: document.getElementById('manualDepositRef').value,
        narration: document.getElementById('manualDepositNarr').value
      };
      const res = await fetch(`/bank-accounts/${enc(BANK_ID)}/manual-deposit`, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok || !data.ok) return alert(data.error || 'Failed to save deposit.');
      location.reload();
    });

    document.getElementById('manualWithdrawForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        amount: document.getElementById('manualWithdrawAmount').value,
        txn_date: document.getElementById('manualWithdrawDate').value,
        reference: document.getElementById('manualWithdrawRef').value,
        narration: document.getElementById('manualWithdrawNarr').value
      };
      const res = await fetch(`/bank-accounts/${enc(BANK_ID)}/manual-withdraw`, {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok || !data.ok) return alert(data.error || 'Failed to save withdrawal.');
      location.reload();
    });

    document.getElementById('manualTransferForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fromBankId = document.getElementById('transferFromBank').value;
      const toBankId = document.getElementById('transferToBank').value;
      const amountVal = document.getElementById('transferAmount').value;
      const txnDate = document.getElementById('transferDate').value;
      const reference = document.getElementById('transferRef').value;
      const narration = document.getElementById('transferNarr').value;

      if (!fromBankId || !toBankId) return alert('Select both banks.');
      if (fromBankId === toBankId) return alert('From and To bank must be different.');
      const amount = parseFloat(amountVal || '0');
      if (!(amount > 0)) return alert('Amount must be greater than 0.');
      if (!txnDate) return alert('Date is required.');

      const fromName = document.getElementById('transferFromBank').selectedOptions[0]?.textContent.trim() || '';
      const toName = document.getElementById('transferToBank').selectedOptions[0]?.textContent.trim() || '';

      transferPayload = {
        from_bank_id: fromBankId,
        to_bank_id: toBankId,
        amount: amount,
        txn_date: txnDate,
        reference: reference,
        narration: narration
      };

      document.getElementById('cfFrom').textContent = fromName || '-';
      document.getElementById('cfTo').textContent = toName || '-';
      document.getElementById('cfAmount').textContent = 'GHS ' + amount.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      document.getElementById('cfDate').textContent = txnDate;
      document.getElementById('cfRef').textContent = reference ? reference : '(Auto-generated)';
      document.getElementById('cfNar').textContent = narration ? narration : '-';

      bootstrap.Modal.getInstance(document.getElementById('manualTransferModal')).hide();
      new bootstrap.Modal(document.getElementById('confirmTransferModal')).show();
    });

    document.getElementById('btnEditTransfer')?.addEventListener('click', () => {
      bootstrap.Modal.getInstance(document.getElementById('confirmTransferModal')).hide();
      new bootstrap.Modal(document.getElementById('manualTransferModal')).show();
    });

    document.getElementById('btnConfirmTransfer')?.addEventListener('click', async () => {
      if (!transferPayload) return;
      const btn = document.getElementById('btnConfirmTransfer');
      const spinner = btn.querySelector('.spinner-border');
      const label = btn.querySelector('.btn-label');
      btn.disabled = true;
      spinner.classList.remove('d-none');
      label.textContent = 'Processing...';

      try {
        const res = await fetch('/bank-accounts/transfer', {
          method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(transferPayload)
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to create transfer.');
        bootstrap.Modal.getInstance(document.getElementById('confirmTransferModal')).hide();
        showToast('Transfer completed successfully.');
        setTimeout(() => location.reload(), 600);
      } catch (err) {
        alert(err.message || 'Failed to create transfer.');
      } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
        label.textContent = 'Confirm Transfer';
      }
    });
  }

  // ---------- Load OMC debts ----------
  const omcBody = document.querySelector('#omcDebtTable tbody');
  const omcSum = document.getElementById('debtSummary');

  async function loadOmcDebts(){
    omcBody.innerHTML = `<tr class="spinner-row"><td colspan="3" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>`;
    try {
      const res = await fetch(`/bank-profile/${enc(BANK_ID)}/omc-debts`);
      const data = await res.json();
      if (data.status !== 'success') throw new Error(data.message || 'Failed to load debts');
      const rows = data.debts || [];
      if (!rows.length){
        omcBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No OMC has outstanding S-Tax at the moment.</td></tr>`;
        omcSum.style.display = 'none';
        return;
      }
      const total = rows.reduce((s,r)=> s + (r.outstanding || 0), 0);
      omcSum.textContent = `Total OMC S-Tax Outstanding: GHS ${fmt2(total)}`;
      omcSum.style.display = '';
      omcBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.omc}</td>
          <td class="text-end">GHS ${fmt2(r.outstanding)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-primary" type="button"
                    data-omc="${r.omc}" data-out="${r.outstanding}" data-orders="${r.unpaid_orders || 0}"
                    onclick="openPayOmcModal(this)">
              <i class="bi bi-cash-coin me-1"></i> Pay from this bank
            </button>
          </td>
        </tr>
      `).join('');
    } catch (e) {
      omcBody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">${e.message}</td></tr>`;
    }
  }

  function openPayOmcModal(btn){
    document.getElementById('omcName').value = btn.getAttribute('data-omc');
    document.getElementById('omcOutstanding').value = Number(btn.getAttribute('data-out')||0).toFixed(2);
    document.getElementById('omcOrders').value = btn.getAttribute('data-orders') || '0';
    document.getElementById('payAmount').value = '';
    document.getElementById('payDate').value = new Date().toISOString().slice(0,10);
    new bootstrap.Modal(document.getElementById('payOmcModal')).show();
  }

  // ---------- Pay OMC submit ----------
  let omcSubmitting = false;
  document.getElementById('payOmcForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (omcSubmitting) return; omcSubmitting = true;
    const amount = parseFloat(document.getElementById('payAmount').value || '0');
    const outstanding = parseFloat(document.getElementById('omcOutstanding').value || '0');
    if (!(amount > 0)){ omcSubmitting=false; return alert('Amount must be greater than 0'); }
    if (amount > outstanding){ omcSubmitting=false; return alert('Amount exceeds outstanding'); }

    const payload = {
      bank_id: BANK_ID,
      omc: document.getElementById('omcName').value,
      amount: amount,
      payment_date: document.getElementById('payDate').value,
      reference: document.getElementById('payRef').value,
      paid_by: document.getElementById('payBy').value
    };
    try {
      const res = await fetch('/bank-profile/pay-omc', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.status === 'success'){
        bootstrap.Modal.getInstance(document.getElementById('payOmcModal')).hide();
        await loadOmcDebts(); updateCurrentBalance(); location.reload();
      } else { alert(data.message || 'Payment failed'); }
    } catch { alert('Network error while submitting OMC payment.'); }
    finally { omcSubmitting = false; }
  });

  // ---------- Load BDC debts ----------
  const bdcBody = document.querySelector('#bdcDebtTable tbody');
  const bdcSum = document.getElementById('bdcDebtSummary');

  async function loadBdcDebts(){
    bdcBody.innerHTML = `<tr class="spinner-row"><td colspan="3" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>`;
    try {
      const res = await fetch(`/bank-profile/${enc(BANK_ID)}/bdc-debts`);
      const data = await res.json();
      if (data.status !== 'success') throw new Error(data.message || 'Failed to load BDC debts');
      const rows = data.debts || [];
      if (!rows.length){
        bdcBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No BDC has outstanding bank payments.</td></tr>`;
        bdcSum.style.display = 'none';
        return;
      }
      const total = rows.reduce((s,r)=> s + (r.outstanding || 0), 0);
      bdcSum.textContent = `Total BDC Outstanding: GHS ${fmt2(total)}`;
      bdcSum.style.display = '';
      bdcBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.bdc || '—'}</td>
          <td class="text-end">GHS ${fmt2(r.outstanding)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-primary" type="button"
                    data-bdc-id="${r.bdc_id}" data-bdc="${r.bdc || '—'}"
                    data-out="${r.outstanding}" data-items="${r.unpaid_items || 0}"
                    onclick="openPayBdcModal(this)">
              <i class="bi bi-cash-stack me-1"></i> Pay from this bank
            </button>
          </td>
        </tr>
      `).join('');
    } catch (e) {
      bdcBody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">${e.message}</td></tr>`;
    }
  }

  function openPayBdcModal(btn){
    document.getElementById('bdcId').value = btn.getAttribute('data-bdc-id');
    document.getElementById('bdcName').value = btn.getAttribute('data-bdc');
    document.getElementById('bdcOutstanding').value = Number(btn.getAttribute('data-out')||0).toFixed(2);
    document.getElementById('bdcItems').value = btn.getAttribute('data-items') || '0';
    document.getElementById('bdcPayAmount').value = '';
    document.getElementById('bdcPayDate').value = new Date().toISOString().slice(0,10);
    new bootstrap.Modal(document.getElementById('payBdcModal')).show();
  }

  // ---------- Pay BDC submit ----------
  let bdcSubmitting = false;
  document.getElementById('payBdcForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (bdcSubmitting) return; bdcSubmitting = true;

    const amount = parseFloat(document.getElementById('bdcPayAmount').value || '0');
    const outstanding = parseFloat(document.getElementById('bdcOutstanding').value || '0');
    if (!(amount > 0)){ bdcSubmitting=false; return alert('Amount must be greater than 0'); }
    if (amount > outstanding){ bdcSubmitting=false; return alert('Amount exceeds outstanding'); }

    const payload = {
      bank_id: BANK_ID,
      bdc_id: document.getElementById('bdcId').value,
      amount: amount,
      payment_date: document.getElementById('bdcPayDate').value,
      reference: document.getElementById('bdcPayRef').value,
      paid_by: document.getElementById('bdcPayBy').value
    };
    try {
      const res = await fetch('/bank-profile/pay-bdc', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.status === 'success'){
        bootstrap.Modal.getInstance(document.getElementById('payBdcModal')).hide();
        await loadBdcDebts(); updateCurrentBalance(); location.reload();
      } else { alert(data.message || 'Payment failed'); }
    } catch { alert('Network error while submitting BDC payment.'); }
    finally { bdcSubmitting = false; }
  });

  // ---------- Current Balance ----------
  function updateCurrentBalance(){
    const totalReceived = parseMoneyText(document.getElementById('summaryTotal')?.dataset.val || '0');
    const bal = totalReceived + MANUAL_IN - (PTAX_OUT_TOTAL + BDC_OUT_TOTAL + MANUAL_OUT);
    const el = document.getElementById('currentBalance');
    if (el){
      el.textContent = `Current Balance: GHS ${fmt2(bal)}`;
      el.classList.toggle('negative', bal < 0);
      el.title = `Total In: GHS ${fmt2(totalReceived)}  |  Manual In: GHS ${fmt2(MANUAL_IN)}  |  P-Tax Out: GHS ${fmt2(PTAX_OUT_TOTAL)}  |  BDC Out: GHS ${fmt2(BDC_OUT_TOTAL)}  |  Manual Out: GHS ${fmt2(MANUAL_OUT)}`;
    }
  }

  // ---------- Exports ----------
  async function fetchAllPayments(){
    const { start, end } = getMeta();
    const items = [];
    let skip = 0;
    const limit = 500;
    while (true){
      const url = buildUrl(`/bank-profile/${enc(BANK_ID)}/history/payments`, {
        skip: skip,
        limit: limit,
        start_date: start,
        end_date: end
      });
      const res = await fetch(url, { cache: 'no-store' });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to load payments.');
      const batch = data.items || [];
      items.push(...batch);
      if (!data.has_more) break;
      skip += batch.length;
      if (batch.length === 0) break;
    }
    return items;
  }

  async function exportPDF(){
    const { bank, branch, acc, start, end } = getMeta();
    const items = await fetchAllPayments();
    const headers = ['#', 'Date', 'Amount (GHS)', 'Last 4 Digits', 'Proof'];
    const rows = items.map((p, i) => ([
      i + 1,
      p.date_str || '—',
      fmt2(p.amount || 0),
      p.account_last4 || '—',
      p.proof_url || 'None'
    ]));
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4', compress: true, hotfixes: ["px_scaling"] });
    const title = `${bank} – ${branch}`, subtitle = `Account: ${acc}`, period = (start||end) ? `Period: ${start || '—'} → ${end || '—'}` : '';
    doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text(title, 40, 40);
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(subtitle, 40, 60); if (period) doc.text(period, 40, 78);
    const total = document.getElementById('tableTotal')?.getAttribute('data-total') || '';
    doc.autoTable({
      startY: 100, head: [headers], body: rows,
      styles: { fontSize: 9, cellPadding: 6, overflow: 'linebreak' },
      headStyles: { fillColor: [248,250,252], textColor: 20 },
      columnStyles: { 0:{halign:'right', cellWidth:40}, 1:{cellWidth:120}, 2:{halign:'right', cellWidth:110}, 3:{halign:'center', cellWidth:110}, 4:{cellWidth:120} },
      didDrawPage: (data) => {
        const pageCount = doc.getNumberOfPages(), pageSize = doc.internal.pageSize;
        doc.setFontSize(9); doc.setTextColor(120);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 40, pageSize.height - 24);
        doc.text(`Page ${data.pageNumber} / ${pageCount}`, pageSize.width - 100, pageSize.height - 24);
      }
    });
    if (total){
      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 6,
        body: [[ {content:`Total Received`, styles:{fontStyle:'bold'}},
                 {content:`GHS ${Number(total).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`, styles:{halign:'right', fontStyle:'bold'} } ]],
        theme: 'plain', styles:{fontSize:11, cellPadding:6}, tableWidth:'wrap', margin:{left:40}
      });
    }
    const fname = sanitizeFilename(`${bank}_${branch}_payments_${start || 'all'}_${end || 'all'}.pdf`);
    doc.save(fname);
  }
  async function exportXLSX(){
    const { bank, branch, start, end } = getMeta();
    const items = await fetchAllPayments();
    const headers = ['#', 'Date', 'Amount (GHS)', 'Last 4 Digits', 'Proof'];
    const rows = items.map((p, i) => ([
      i + 1,
      p.date_str || '—',
      fmt2(p.amount || 0),
      p.account_last4 || '—',
      p.proof_url || 'None'
    ]));
    const wsData = [headers, ...rows];
    const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(wsData);
    const colWidths = wsData[0].map((h,i)=> ({ wch: Math.min(Math.max(8, Math.max(...wsData.map(r=>(''+(r[i]||'')).length))+2), 40) }));
    ws['!cols'] = colWidths; XLSX.utils.book_append_sheet(wb, ws, 'Payments');
    XLSX.writeFile(wb, sanitizeFilename(`${bank}_${branch}_payments_${start || 'all'}_${end || 'all'}.xlsx`));
  }
  async function exportCSV(){
    const { bank, branch, start, end } = getMeta();
    const items = await fetchAllPayments();
    const headers = ['#', 'Date', 'Amount (GHS)', 'Last 4 Digits', 'Proof'];
    const rows = items.map((p, i) => ([
      i + 1,
      p.date_str || '—',
      fmt2(p.amount || 0),
      p.account_last4 || '—',
      p.proof_url || 'None'
    ]));
    saveBlob(toCSV(headers, rows), 'text/csv;charset=utf-8;', sanitizeFilename(`${bank}_${branch}_payments_${start || 'all'}_${end || 'all'}.csv`));
  }

  // ---------- Init ----------
  (async function init(){
    document.getElementById('btnExportPDF')?.addEventListener('click', () => exportPDF());
    document.getElementById('btnExportXLSX')?.addEventListener('click', () => exportXLSX());
    document.getElementById('btnExportCSV')?.addEventListener('click', () => exportCSV());
    document.getElementById('btnPrint')?.addEventListener('click', ()=>window.print());

    const summary = document.getElementById('summaryTotal');
    if(summary){
      const raw = parseFloat((summary.dataset.val||'0').replace(/,/g,''))||0;
      summary.textContent = 'Total Received: GHS ' + fmt2(raw);
    }
    const t = document.getElementById('tableTotal');
    if (t){
      const val = parseFloat((t.getAttribute('data-total')||'0').replace(/,/g,'')); 
      if(!isNaN(val)) t.textContent = 'GHS ' + fmt2(val);
    }

    const { start, end } = getMeta();
    const tbPayments = document.getElementById('tbPayments');
    const tbPTax = document.getElementById('tbPTax');
    const tbBankBdc = document.getElementById('tbBankBdc');
    const tbManual = document.getElementById('tbManual');
    const metaPayments = document.getElementById('metaPayments');
    const metaPTax = document.getElementById('metaPTax');
    const metaBankBdc = document.getElementById('metaBankBdc');
    const metaManual = document.getElementById('metaManual');
    const btnMorePayments = document.getElementById('btnMorePayments');
    const btnMorePTax = document.getElementById('btnMorePTax');
    const btnMoreBankBdc = document.getElementById('btnMoreBankBdc');
    const btnMoreManual = document.getElementById('btnMoreManual');

    const paymentsBase = `/bank-profile/${enc(BANK_ID)}/history/payments`;
    const ptaxBase = `/bank-profile/${enc(BANK_ID)}/history/ptax`;
    const bdcBase = `/bank-profile/${enc(BANK_ID)}/history/bdc`;
    const manualBase = `/bank-profile/${enc(BANK_ID)}/history/manual`;

    try {
      await loadSection({
        baseUrl: paymentsBase,
        tbody: tbPayments,
        metaEl: metaPayments,
        btnEl: btnMorePayments,
        renderRow: renderPaymentRow,
        first: true,
        extraParams: { start_date: start, end_date: end }
      });
      btnMorePayments?.addEventListener('click', () => loadSection({
        baseUrl: paymentsBase,
        tbody: tbPayments,
        metaEl: metaPayments,
        btnEl: btnMorePayments,
        renderRow: renderPaymentRow,
        batch: 10,
        extraParams: { start_date: start, end_date: end }
      }));
    } catch (e) {
      tbPayments.innerHTML = `<tr><td colspan="5" class="text-danger text-center">${e.message}</td></tr>`;
    }

    try {
      await loadSection({
        baseUrl: ptaxBase,
        tbody: tbPTax,
        metaEl: metaPTax,
        btnEl: btnMorePTax,
        renderRow: renderPTaxRow,
        first: true
      });
      btnMorePTax?.addEventListener('click', () => loadSection({
        baseUrl: ptaxBase,
        tbody: tbPTax,
        metaEl: metaPTax,
        btnEl: btnMorePTax,
        renderRow: renderPTaxRow,
        batch: 10
      }));
    } catch (e) {
      tbPTax.innerHTML = `<tr><td colspan="8" class="text-danger text-center">${e.message}</td></tr>`;
    }

    try {
      await loadSection({
        baseUrl: bdcBase,
        tbody: tbBankBdc,
        metaEl: metaBankBdc,
        btnEl: btnMoreBankBdc,
        renderRow: renderBdcRow,
        first: true
      });
      btnMoreBankBdc?.addEventListener('click', () => loadSection({
        baseUrl: bdcBase,
        tbody: tbBankBdc,
        metaEl: metaBankBdc,
        btnEl: btnMoreBankBdc,
        renderRow: renderBdcRow,
        batch: 10
      }));
    } catch (e) {
      tbBankBdc.innerHTML = `<tr><td colspan="9" class="text-danger text-center">${e.message}</td></tr>`;
    }

    try {
      await loadSection({
        baseUrl: manualBase,
        tbody: tbManual,
        metaEl: metaManual,
        btnEl: btnMoreManual,
        renderRow: renderManualRow,
        first: true,
        extraParams: { start_date: start, end_date: end }
      });
      btnMoreManual?.addEventListener('click', () => loadSection({
        baseUrl: manualBase,
        tbody: tbManual,
        metaEl: metaManual,
        btnEl: btnMoreManual,
        renderRow: renderManualRow,
        batch: 10,
        extraParams: { start_date: start, end_date: end }
      }));
    } catch (e) {
      tbManual.innerHTML = `<tr><td colspan="8" class="text-danger text-center">${e.message}</td></tr>`;
    }

    loadOmcDebts();
    loadBdcDebts();
    updateCurrentBalance();
  })();
</script>
</body>
</html>
