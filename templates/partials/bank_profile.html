<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bank Profile - {{ bank.bank_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root{ --ink:#0b1320; --muted:#475569; --line:#e2e8f0; --soft:#f8fafc; --brand:#0d6efd; --ok:#198754; --warn:#d9480f }
    html,body{height:100%}
    body{
      background: radial-gradient(1200px 800px at 10% -10%, #eef2f7 0%, #ffffff 60%) no-repeat,
                  linear-gradient(to right, #f8f9fa 0%, #eef2f7 100%);
      font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
      color: var(--ink);
    }
    .section-header{font-weight:700;color:var(--brand); letter-spacing:.2px}
    .card-title{font-size:1.15rem;font-weight:650}
    .summary-value{font-size:1.05rem;color:var(--ok);font-weight:700}
    .summary-subvalue{font-size:1rem;font-weight:650;color:#0b7285}
    .summary-subvalue.negative{color:var(--warn)}
    .table-wrap{background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    table thead th{ background:#f8fafc; position:sticky; top:0; z-index:2; border-bottom:1px solid var(--line); }
    .pill{border-radius:999px;padding:.2rem .6rem;font-size:.8rem}
    .pill-warn{background:#fff4e6;color:var(--warn)}
    .spinner-row td{padding:1.25rem !important}
    @media print{ .no-print{display:none !important} body{background:#fff} .container{max-width:100% !important} }
  </style>
</head>
<body>
<!-- Root carries ALL values as data-* (NO tojson in scripts) -->
<div class="container py-4" id="bank-root"
     data-bank-id="{{ bank._id }}"
     data-bank="{{ bank.bank_name|e }}"
     data-branch="{{ bank.branch|e }}"
     data-acc="{{ bank.account_number|e }}"
     data-account-name="{{ bank.account_name|e }}"
     data-start="{{ start_date or '' }}"
     data-end="{{ end_date or '' }}">

  <!-- Top Bar -->
  <div class="d-flex align-items-center justify-content-between no-print">
    <button onclick="history.back()" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <div class="d-flex gap-2 flex-wrap">
      <button id="btnExportPDF" class="btn btn-danger"><i class="bi bi-filetype-pdf me-1"></i> Export PDF</button>
      <button id="btnExportXLSX" class="btn btn-success"><i class="bi bi-filetype-xlsx me-1"></i> Export Excel</button>
      <button id="btnExportCSV" class="btn btn-primary"><i class="bi bi-filetype-csv me-1"></i> Export CSV</button>
      <button id="btnPrint" class="btn btn-outline-dark"><i class="bi bi-printer me-1"></i> Print</button>
    </div>
  </div>

  <!-- Header -->
  <div class="d-flex align-items-center mt-3 mb-3">
    <i class="bi bi-bank fs-3 text-primary me-2"></i>
    <h4 class="section-header mb-0">{{ bank.bank_name }} – {{ bank.branch }}</h4>
  </div>

  <!-- Bank Summary -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
      <div class="mb-3 mb-md-0">
        <h6 class="card-title mb-1"><i class="bi bi-person-vcard text-secondary me-1"></i> {{ bank.account_name }}</h6>
        <div class="text-muted"><strong>Account Number:</strong> {{ bank.account_number }}</div>
        <div class="text-muted"><strong>Branch:</strong> {{ bank.branch }}</div>
      </div>
      <div class="text-md-end">
        <div class="summary-value" id="summaryTotal" data-val="{{ '%.2f'|format(total_received) }}">Cash Ins: GHS {{ '%.2f'|format(total_received) }}</div>
        <div class="summary-subvalue mt-1" id="currentBalance">Current Balance: GHS 0.00</div>
        {% if start_date or end_date %}
        <div class="text-muted mt-1">
          Period:
          <span class="badge rounded-pill border px-3 py-2">{{ start_date or '—' }} → {{ end_date or '—' }}</span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- OMCs with S-Tax Debt -->
  <div class="table-wrap mb-4">
    <div class="d-flex justify-content-between align-items-center p-3 pb-2">
      <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-1 text-warning"></i> OMCs with P-Tax Debt</h6>
      <span class="pill pill-warn" id="debtSummary" style="display:none"></span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="omcDebtTable">
        <thead>
          <tr>
            <th>OMC</th>
            <th class="text-end">Outstanding (GHS)</th>
            <th class="text-end">Action</th> <!-- removed Orders Unpaid -->
          </tr>
        </thead>
        <tbody>
          <tr class="spinner-row"><td colspan="3" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- BDCs waiting bank payment -->
  <div class="table-wrap mb-4">
    <div class="d-flex justify-content-between align-items-center p-3 pb-2">
      <h6 class="mb-0"><i class="bi bi-exclamation-circle me-1 text-danger"></i> BDCs Waiting Bank Payment</h6>
      <span class="pill pill-warn" id="bdcDebtSummary" style="display:none"></span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="bdcDebtTable">
        <thead>
          <tr>
            <th>BDC</th>
            <th class="text-end">Outstanding (GHS)</th>
            <th class="text-end">Action</th> <!-- removed Unpaid Items -->
          </tr>
        </thead>
        <tbody>
          <tr class="spinner-row"><td colspan="3" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Confirmed inbound payments -->
  {% if payments %}
  <div id="exportArea" class="table-wrap shadow-sm mb-5">
    <div class="d-flex justify-content-between align-items-center p-3 pb-0">
      <h6 class="mb-2"><i class="bi bi-cash-coin me-1"></i> Confirmed Payments</h6>
      <div class="text-muted">Rows: <strong id="rowCount">{{ payments|length }}</strong></div>
    </div>
    <div class="table-responsive">
      <table id="paymentsTable" class="table table-striped table-hover table-bordered mb-0">
        <thead>
          <tr>
            <th style="width:70px">#</th>
            <th>Date</th>
            <th>Amount (GHS)</th>
            <th>Last 4 Digits</th>
            <th>Proof</th>
          </tr>
        </thead>
        <tbody>
          {% for pay in payments %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ pay.date.strftime('%Y-%m-%d %H:%M') }}</td>
            <td class="amt" data-num="{{ '%.2f'|format(pay.amount) }}">{{ '%.2f'|format(pay.amount) }}</td>
            <td>{{ pay.account_last4 }}</td>
            <td>
              {% if pay.proof_url %}
                <a href="{{ pay.proof_url }}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-earmark-image"></i> View</a>
              {% else %}<span class="text-muted">None</span>{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2" class="text-end">Total</th>
            <th id="tableTotal" data-total="{{ '%.2f'|format(total_received) }}">GHS {{ '%.2f'|format(total_received) }}</th>
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  {% else %}
  <div class="alert alert-warning text-center shadow-sm">
    No confirmed payments found for this account{% if start_date and end_date %} within the selected period{% endif %}.
  </div>
  {% endif %}

  <div class="table-wrap shadow-sm mb-4">
    <div class="p-3 pb-0">
      <h6 class="mb-2"><i class="bi bi-journal-check me-1"></i> P-Tax Payments From This Bank</h6>
    </div>
    <div class="table-responsive">
      <table id="bankTaxTable" class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>OMC</th>
            <th>Order ID</th>
            <th class="text-end">Qty (L)</th>
            <th class="text-end">S-TAX /L</th>
            <th class="text-end">Amount (GHS)</th>
            <th>Reference</th>
            <th>Paid By</th>
          </tr>
        </thead>
        <tbody>
          {% if bank_tax_rows %}
            {% for r in bank_tax_rows %}
            <tr>
              <td>{{ r.payment_date_str }}</td>
              <td>{{ r.omc }}</td>
              <td>{{ r.order_id }}</td>
              <td class="text-end">{{ '{:,.0f}'.format(r.quantity or 0) }}</td>
              <td class="text-end">{{ '%.2f'|format(r.s_tax_per_l or 0) }}</td>
              <td class="text-end bank-tax-amt">{{ '%.2f'|format(r.amount) }}</td>
              <td>{{ r.reference or '—' }}</td>
              <td>{{ r.paid_by or '—' }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="8" class="text-center text-muted py-3">No P-Tax payments recorded from this bank yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- BDC Payments From This Bank -->
  <div class="table-wrap">
    <div class="p-3 pb-0">
      <h6 class="mb-2"><i class="bi bi-journal-text me-1"></i> BDC Payments From This Bank</h6>
    </div>
    <div class="table-responsive">
      <table id="bankBdcTable" class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>BDC</th>
            <th>Type</th>
            <th>Order ID</th>
            <th class="text-end">Qty (L)</th>
            <th class="text-end">S-BDC /L</th>
            <th class="text-end">Amount (GHS)</th>
            <th>Reference</th>
            <th>Paid By</th>
          </tr>
        </thead>
        <tbody>
          {% if bank_bdc_rows %}
            {% for r in bank_bdc_rows %}
            <tr>
              <td>{{ r.payment_date_str }}</td>
              <td>{{ r.bdc or '—' }}</td>
              <td>{{ r.ptype or '—' }}</td>
              <td>{{ r.order_id or '—' }}</td>
              <td class="text-end">{{ '{:,.0f}'.format(r.quantity or 0) }}</td>
              <td class="text-end">{{ '%.2f'|format(r.s_bdc_per_l or 0) }}</td>
              <td class="text-end bank-bdc-amt" data-num="{{ '%.2f'|format(r.amount) }}">{{ '%.2f'|format(r.amount) }}</td>
              <td>{{ r.reference or '—' }}</td>
              <td>{{ r.paid_by or '—' }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="9" class="text-center text-muted py-3">No BDC payments recorded from this bank yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pay OMC Modal -->
  <div class="modal fade" id="payOmcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="payOmcForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Pay OMC P-Tax (Partial Allowed)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <!-- Hidden not required by JS, but fine to keep -->
          <input type="hidden" id="bankId" value="{{ bank._id }}">
          <div class="col-12">
            <label class="form-label">OMC</label>
            <input type="text" class="form-control" id="omcName" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Outstanding (GHS)</label>
            <input type="text" class="form-control" id="omcOutstanding" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Orders Unpaid</label>
            <input type="text" class="form-control" id="omcOrders" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Amount (GHS)</label>
            <input type="number" step="0.01" class="form-control" id="payAmount" required>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Date</label>
            <input type="date" class="form-control" id="payDate" required>
          </div>
          <div class="col-6">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" id="payRef" placeholder="e.g. BANK-TXN-123">
          </div>
          <div class="col-6">
            <label class="form-label">Paid By</label>
            <input type="text" class="form-control" id="payBy" value="{{ bank.account_name }}" required>
          </div>
          <div class="col-12">
            <small class="text-muted">Allocation is automatic from oldest unpaid order to newest for this OMC.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="payOmcSubmit" class="btn btn-primary" type="submit"><i class="bi bi-check2-circle me-1"></i> Make Payment</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pay BDC Modal -->
  <div class="modal fade" id="payBdcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="payBdcForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Pay BDC</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <input type="hidden" id="bankId2" value="{{ bank._id }}">
          <input type="hidden" id="bdcId">
          <div class="col-12">
            <label class="form-label">BDC</label>
            <input type="text" class="form-control" id="bdcName" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Outstanding (GHS)</label>
            <input type="text" class="form-control" id="bdcOutstanding" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Unpaid Items</label>
            <input type="text" class="form-control" id="bdcItems" readonly>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Amount (GHS)</label>
            <input type="number" step="0.01" class="form-control" id="bdcPayAmount" required>
          </div>
          <div class="col-6">
            <label class="form-label">Payment Date</label>
            <input type="date" class="form-control" id="bdcPayDate" required>
          </div>
          <div class="col-6">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" id="bdcPayRef" placeholder="e.g. BANK-TXN-456">
          </div>
          <div class="col-6">
            <label class="form-label">Paid By</label>
            <input type="text" class="form-control" id="bdcPayBy" value="{{ bank.account_name }}" required>
          </div>
          <div class="col-12">
            <small class="text-muted">Allocation is automatic from oldest unpaid item to newest for this BDC.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="payBdcSubmit" class="btn btn-primary" type="submit"><i class="bi bi-check2-circle me-1"></i> Make Payment</button>
        </div>
      </form>
    </div>
  </div>

</div> <!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // ====== Read all values from data-* (NO tojson) ======
  const root = document.getElementById('bank-root');
  const BANK_ID = (root.dataset.bankId || '').trim();
  const ACCOUNT_NAME = root.dataset.accountName || '';
  const enc = s => encodeURIComponent(String(s || ''));

  function getMeta(){
    return {
      bank: root.dataset.bank || '',
      branch: root.dataset.branch || '',
      acc: root.dataset.acc || '',
      start: root.dataset.start || '',
      end: root.dataset.end || ''
    };
  }

  // ---------- Helpers ----------
  function sanitizeFilename(s){ return (s||'export').toString().replace(/[\\\/:*?"<>|]/g,'-').replace(/\s+/g,'_'); }
  function tableToArray(tableId){
    const table = document.getElementById(tableId);
    if(!table) return {headers:[], rows:[]};
    const headers = Array.from(table.querySelectorAll('thead th')).map(th=>th.textContent.trim());
    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr=> Array.from(tr.children).map(td=> {
      const text = td.textContent.trim();
      const numAttr = td.getAttribute('data-num');
      if (numAttr !== null){
        const n = parseFloat(numAttr.replace(/,/g,'')); return isNaN(n) ? text : n;
      }
      return text;
    }));
    return { headers, rows };
  }
  function toCSV(headers, rows){
    const esc = v => { if (v==null) return ''; const s=(''+v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s; };
    return [headers.map(esc).join(','), ...rows.map(r=>r.map(esc).join(','))].join('\n');
  }
  function saveBlob(content, mime, filename){
    const blob = new Blob([content], {type: mime});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }
  const parseMoneyText = txt => { const n = parseFloat(String(txt||'').replace(/[^\d.-]/g,'')); return isNaN(n) ? 0 : n; };
  const fmt2 = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});

  // ---------- Load OMC debts ----------
  const omcBody = document.querySelector('#omcDebtTable tbody');
  const omcSum = document.getElementById('debtSummary');

  async function loadOmcDebts(){
    omcBody.innerHTML = `<tr class="spinner-row"><td colspan="3" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>`;
    try {
      const res = await fetch(`/bank-profile/${enc(BANK_ID)}/omc-debts`);
      const data = await res.json();
      if (data.status !== 'success') throw new Error(data.message || 'Failed to load debts');
      const rows = data.debts || [];
      if (!rows.length){
        omcBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No OMC has outstanding S-Tax at the moment.</td></tr>`;
        omcSum.style.display = 'none';
        return;
      }
      const total = rows.reduce((s,r)=> s + (r.outstanding || 0), 0);
      omcSum.textContent = `Total OMC S-Tax Outstanding: GHS ${fmt2(total)}`;
      omcSum.style.display = '';
      omcBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.omc}</td>
          <td class="text-end">GHS ${fmt2(r.outstanding)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-primary" type="button"
                    data-omc="${r.omc}" data-out="${r.outstanding}" data-orders="${r.unpaid_orders || 0}"
                    onclick="openPayOmcModal(this)">
              <i class="bi bi-cash-coin me-1"></i> Pay from this bank
            </button>
          </td>
        </tr>
      `).join('');
    } catch (e) {
      omcBody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">${e.message}</td></tr>`;
    }
  }

  function openPayOmcModal(btn){
    document.getElementById('omcName').value = btn.getAttribute('data-omc');
    document.getElementById('omcOutstanding').value = Number(btn.getAttribute('data-out')||0).toFixed(2);
    document.getElementById('omcOrders').value = btn.getAttribute('data-orders') || '0';
    document.getElementById('payAmount').value = '';
    document.getElementById('payDate').value = new Date().toISOString().slice(0,10);
    new bootstrap.Modal(document.getElementById('payOmcModal')).show();
  }

  // ---------- Pay OMC submit ----------
  let omcSubmitting = false;
  document.getElementById('payOmcForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (omcSubmitting) return; omcSubmitting = true;
    const amount = parseFloat(document.getElementById('payAmount').value || '0');
    const outstanding = parseFloat(document.getElementById('omcOutstanding').value || '0');
    if (!(amount > 0)){ omcSubmitting=false; return alert('Amount must be greater than 0'); }
    if (amount > outstanding){ omcSubmitting=false; return alert('Amount exceeds outstanding'); }

    const payload = {
      bank_id: BANK_ID,
      omc: document.getElementById('omcName').value,
      amount: amount,
      payment_date: document.getElementById('payDate').value,
      reference: document.getElementById('payRef').value,
      paid_by: document.getElementById('payBy').value
    };
    try {
      const res = await fetch('/bank-profile/pay-omc', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.status === 'success'){
        bootstrap.Modal.getInstance(document.getElementById('payOmcModal')).hide();
        await loadOmcDebts(); updateCurrentBalance(); location.reload();
      } else { alert(data.message || 'Payment failed'); }
    } catch { alert('Network error while submitting OMC payment.'); }
    finally { omcSubmitting = false; }
  });

  // ---------- Load BDC debts ----------
  const bdcBody = document.querySelector('#bdcDebtTable tbody');
  const bdcSum = document.getElementById('bdcDebtSummary');

  async function loadBdcDebts(){
    bdcBody.innerHTML = `<tr class="spinner-row"><td colspan="3" class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading…</td></tr>`;
    try {
      const res = await fetch(`/bank-profile/${enc(BANK_ID)}/bdc-debts`);
      const data = await res.json();
      if (data.status !== 'success') throw new Error(data.message || 'Failed to load BDC debts');
      const rows = data.debts || [];
      if (!rows.length){
        bdcBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">No BDC has outstanding bank payments.</td></tr>`;
        bdcSum.style.display = 'none';
        return;
      }
      const total = rows.reduce((s,r)=> s + (r.outstanding || 0), 0);
      bdcSum.textContent = `Total BDC Outstanding: GHS ${fmt2(total)}`;
      bdcSum.style.display = '';
      bdcBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.bdc || '—'}</td>
          <td class="text-end">GHS ${fmt2(r.outstanding)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-primary" type="button"
                    data-bdc-id="${r.bdc_id}" data-bdc="${r.bdc || '—'}"
                    data-out="${r.outstanding}" data-items="${r.unpaid_items || 0}"
                    onclick="openPayBdcModal(this)">
              <i class="bi bi-cash-stack me-1"></i> Pay from this bank
            </button>
          </td>
        </tr>
      `).join('');
    } catch (e) {
      bdcBody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">${e.message}</td></tr>`;
    }
  }

  function openPayBdcModal(btn){
    document.getElementById('bdcId').value = btn.getAttribute('data-bdc-id');
    document.getElementById('bdcName').value = btn.getAttribute('data-bdc');
    document.getElementById('bdcOutstanding').value = Number(btn.getAttribute('data-out')||0).toFixed(2);
    document.getElementById('bdcItems').value = btn.getAttribute('data-items') || '0';
    document.getElementById('bdcPayAmount').value = '';
    document.getElementById('bdcPayDate').value = new Date().toISOString().slice(0,10);
    new bootstrap.Modal(document.getElementById('payBdcModal')).show();
  }

  // ---------- Pay BDC submit ----------
  let bdcSubmitting = false;
  document.getElementById('payBdcForm')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (bdcSubmitting) return; bdcSubmitting = true;

    const amount = parseFloat(document.getElementById('bdcPayAmount').value || '0');
    const outstanding = parseFloat(document.getElementById('bdcOutstanding').value || '0');
    if (!(amount > 0)){ bdcSubmitting=false; return alert('Amount must be greater than 0'); }
    if (amount > outstanding){ bdcSubmitting=false; return alert('Amount exceeds outstanding'); }

    const payload = {
      bank_id: BANK_ID,
      bdc_id: document.getElementById('bdcId').value,
      amount: amount,
      payment_date: document.getElementById('bdcPayDate').value,
      reference: document.getElementById('bdcPayRef').value,
      paid_by: document.getElementById('bdcPayBy').value
    };
    try {
      const res = await fetch('/bank-profile/pay-bdc', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.status === 'success'){
        bootstrap.Modal.getInstance(document.getElementById('payBdcModal')).hide();
        await loadBdcDebts(); updateCurrentBalance(); location.reload();
      } else { alert(data.message || 'Payment failed'); }
    } catch { alert('Network error while submitting BDC payment.'); }
    finally { bdcSubmitting = false; }
  });

  // ---------- Current Balance ----------
  function sumCells(sel){ let t=0; document.querySelectorAll(sel).forEach(td=> t+=parseMoneyText(td.textContent)); return t; }
  function updateCurrentBalance(){
    const totalReceived = parseMoneyText(document.getElementById('summaryTotal')?.dataset.val || '0');
    const sTaxPaid = sumCells('#bankTaxTable tbody td.bank-tax-amt');
    const bdcPaid  = sumCells('#bankBdcTable tbody td.bank-bdc-amt');
    const bal = totalReceived - sTaxPaid - bdcPaid;
    const el = document.getElementById('currentBalance');
    if (el){
      el.textContent = `Current Balance: GHS ${fmt2(bal)}`;
      el.classList.toggle('negative', bal < 0);
      el.title = `Total In: GHS ${fmt2(totalReceived)}  |  P-Tax Out: GHS ${fmt2(sTaxPaid)}  |  BDC Out: GHS ${fmt2(bdcPaid)}`;
    }
  }

  // ---------- Exports ----------
  async function exportPDF(){
    const { bank, branch, acc, start, end } = getMeta();
    const { headers, rows } = tableToArray('paymentsTable');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4', compress: true, hotfixes: ["px_scaling"] });
    const title = `${bank} – ${branch}`, subtitle = `Account: ${acc}`, period = (start||end) ? `Period: ${start || '—'} → ${end || '—'}` : '';
    doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text(title, 40, 40);
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(subtitle, 40, 60); if (period) doc.text(period, 40, 78);
    const total = document.getElementById('tableTotal')?.getAttribute('data-total') || '';
    doc.autoTable({
      startY: 100, head: [headers], body: rows,
      styles: { fontSize: 9, cellPadding: 6, overflow: 'linebreak' },
      headStyles: { fillColor: [248,250,252], textColor: 20 },
      columnStyles: { 0:{halign:'right', cellWidth:40}, 1:{cellWidth:120}, 2:{halign:'right', cellWidth:110}, 3:{halign:'center', cellWidth:110}, 4:{cellWidth:120} },
      didDrawPage: (data) => {
        const pageCount = doc.getNumberOfPages(), pageSize = doc.internal.pageSize;
        doc.setFontSize(9); doc.setTextColor(120);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 40, pageSize.height - 24);
        doc.text(`Page ${data.pageNumber} / ${pageCount}`, pageSize.width - 100, pageSize.height - 24);
      }
    });
    if (total){
      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 6,
        body: [[ {content:`Total Received`, styles:{fontStyle:'bold'}},
                 {content:`GHS ${Number(total).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`, styles:{halign:'right', fontStyle:'bold'} } ]],
        theme: 'plain', styles:{fontSize:11, cellPadding:6}, tableWidth:'wrap', margin:{left:40}
      });
    }
    const fname = sanitizeFilename(`${bank}_${branch}_payments_${start || 'all'}_${end || 'all'}.pdf`);
    doc.save(fname);
  }
  function exportXLSX(){
    const { bank, branch, start, end } = getMeta();
    const { headers, rows } = tableToArray('paymentsTable');
    const wsData = [headers, ...rows];
    const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(wsData);
    const colWidths = wsData[0].map((h,i)=> ({ wch: Math.min(Math.max(8, Math.max(...wsData.map(r=>(''+(r[i]||'')).length))+2), 40) }));
    ws['!cols'] = colWidths; XLSX.utils.book_append_sheet(wb, ws, 'Payments');
    XLSX.writeFile(wb, sanitizeFilename(`${bank}_${branch}_payments_${start || 'all'}_${end || 'all'}.xlsx`));
  }
  function exportCSV(){
    const { bank, branch, start, end } = getMeta();
    const { headers, rows } = tableToArray('paymentsTable');
    saveBlob(toCSV(headers, rows), 'text/csv;charset=utf-8;', sanitizeFilename(`${bank}_${branch}_payments_${start || 'all'}_${end || 'all'}.csv`));
  }

  // ---------- Init ----------
  (function init(){
    document.getElementById('btnExportPDF')?.addEventListener('click', exportPDF);
    document.getElementById('btnExportXLSX')?.addEventListener('click', exportXLSX);
    document.getElementById('btnExportCSV')?.addEventListener('click', exportCSV);
    document.getElementById('btnPrint')?.addEventListener('click', ()=>window.print());

    const summary = document.getElementById('summaryTotal');
    if(summary){
      const raw = parseFloat((summary.dataset.val||'0').replace(/,/g,''))||0;
      summary.textContent = 'Total Received: GHS ' + fmt2(raw);
    }
    document.querySelectorAll('#paymentsTable tbody td.amt').forEach(td=>{
      const raw = parseFloat((td.getAttribute('data-num')||td.textContent).replace(/,/g,'')); if(!isNaN(raw)) td.textContent = fmt2(raw);
    });
    const t = document.getElementById('tableTotal'); if(t){ const val = parseFloat((t.getAttribute('data-total')||'0').replace(/,/g,'')); if(!isNaN(val)) t.textContent = 'GHS ' + fmt2(val); }

    loadOmcDebts();
    loadBdcDebts();
    updateCurrentBalance();
  })();

  // Format BDC payment history numbers
  document.querySelectorAll('#bankBdcTable tbody td.bank-bdc-amt').forEach(td=>{
    const raw = parseFloat((td.getAttribute('data-num')||td.textContent).replace(/,/g,''));
    if(!isNaN(raw)) td.textContent = fmt2(raw);
  });
</script>
</body>
</html>
