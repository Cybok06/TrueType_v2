<div class="container py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
    <h4 class="mb-0"><i class="fas fa-money-check-alt me-2 text-primary"></i>Received Payments</h4>

    <div class="d-flex align-items-center gap-2">
      <!-- Server-side search (one fetch; pagination is client-side) -->
      <form class="d-flex" method="get" action="{{ url_for('payments_bp.view_payments') }}">
        <input name="q" value="{{ q or '' }}" type="text" class="form-control form-control-sm shadow-sm"
               placeholder="üîç Search by client name, phone or ID" style="min-width: 260px;">
        <button class="btn btn-sm btn-outline-primary ms-2" type="submit"><i class="fas fa-search"></i></button>
      </form>

      <button class="btn btn-success btn-sm" onclick="exportToExcel()">
        <i class="fas fa-file-excel me-1"></i> Export to Excel
      </button>
    </div>
  </div>

  <!-- Results meta (updated by JS) -->
  <div class="small text-muted mb-2">
    Showing <strong id="rangeStart">0</strong>‚Äì<strong id="rangeEnd">0</strong> of
    <strong id="totalCount">{{ total_count }}</strong>{% if q %} for ‚Äú{{ q }}‚Äù{% endif %}.
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-nowrap table-striped" id="paymentDataTable">
      <thead class="table-primary text-center">
        <tr>
          <th><i class="far fa-calendar-alt"></i> Date</th>
          <th><i class="fas fa-user"></i> Client</th>
          <th><i class="fas fa-phone"></i> Phone</th>
          <th><i class="fas fa-coins"></i> Amount</th>
          <th><i class="fas fa-receipt"></i> Order</th>             <!-- NEW -->
          <th><i class="fas fa-arrow-up-right-dots"></i> Paid</th>  <!-- NEW -->
          <th><i class="fas fa-scale-unbalanced"></i> Left</th>     <!-- NEW -->
          <th><i class="fas fa-university"></i> Bank</th>
          <th><i class="fas fa-check-circle"></i> Status</th>
          <th><i class="fas fa-file-alt"></i> Proof</th>
          <th><i class="fas fa-cogs"></i> Action</th>
        </tr>
      </thead>

      <!-- ALL rows rendered; JS shows only current page -->
      <tbody id="paymentsTable">
        {% for payment in payments %}
        <tr data-payment-id="{{ payment._id }}">
          <td class="col-date">{{ payment.date_str }}</td>

          <td class="col-client">
            <strong class="client-name">{{ payment.client_name }}</strong><br>
            <small class="text-muted client-id">{{ payment.client_id_str }}</small>
          </td>

          <td class="col-phone">{{ payment.phone }}</td>

          <td class="col-amount">
            <span class="fw-bold text-success amount" data-raw="{{ payment.amount or 0 }}">
              GHS {{ "{:,.2f}".format(payment.amount or 0) }}
            </span>
          </td>

          <!-- NEW: Order / Paid / Left -->
          <td class="col-order text-center">
            {% if payment.has_order %}
              <span class="badge bg-info-subtle text-info-emphasis order-code">{{ payment.order_code }}</span>
            {% else %}
              <span class="text-muted order-code">‚Äî</span>
            {% endif %}
          </td>

          <td class="col-paid text-end">
            {% if payment.has_order %}
              <span class="text-success fw-semibold total-paid" data-raw="{{ payment.order_total_paid }}">
                GHS {{ "{:,.2f}".format(payment.order_total_paid or 0) }}
              </span>
            {% else %}
              <span class="text-muted total-paid" data-raw="0">‚Äî</span>
            {% endif %}
          </td>

          <td class="col-left text-end">
            {% if payment.has_order %}
              <span class="text-danger fw-semibold amount-left" data-raw="{{ payment.order_amount_left }}">
                GHS {{ "{:,.2f}".format(payment.order_amount_left or 0) }}
              </span>
            {% else %}
              <span class="text-muted amount-left" data-raw="0">‚Äî</span>
            {% endif %}
          </td>
          <!-- /NEW -->

          <td class="col-bank">
            <span class="bank-name">{{ payment.bank_name }}</span>
            {% if payment.account_last4 %}
              <span class="text-muted last4">(****{{ payment.account_last4 }})</span>
            {% endif %}
          </td>

          <td class="col-status text-center">
            {% if payment.status == 'confirmed' %}
              <span class="badge bg-success"><i class="fas fa-check-circle"></i> Confirmed</span>
            {% else %}
              <span class="badge bg-warning text-dark"><i class="fas fa-hourglass-half"></i> Pending</span>
            {% endif %}
          </td>

          <td class="col-proof text-center">
            {% if payment.proof_url and payment.proof_url != '#' %}
              <a href="{{ payment.proof_url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-eye"></i> View
              </a>
            {% else %}
              <span class="text-muted">None</span>
            {% endif %}
          </td>

          <td class="col-action text-center">
            {% if payment.status != 'confirmed' %}
              <button class="btn btn-primary btn-sm" onclick="openConfirmModal('{{ payment._id }}')">
                <i class="fas fa-check"></i> Confirm
              </button>
            {% else %}
              <span class="text-muted"><i class="fas fa-check-double"></i> Done</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Client-side Pagination -->
  <div class="d-flex flex-wrap justify-content-end align-items-center gap-2 mt-3">
    <div class="d-flex align-items-center gap-1">
      <label for="pageSize" class="small text-muted me-1">Rows:</label>
      <select id="pageSize" class="form-select form-select-sm" style="width:auto; min-width: 80px;"
              data-default-page-size="{{ default_page_size }}">
        <option value="5"  {% if default_page_size == 5  %}selected{% endif %}>5</option>
        <option value="10" {% if default_page_size == 10 %}selected{% endif %}>10</option>
        <option value="20" {% if default_page_size == 20 %}selected{% endif %}>20</option>
        <option value="50" {% if default_page_size == 50 %}selected{% endif %}>50</option>
      </select>
    </div>

    <nav aria-label="Payments pagination">
      <ul id="pagination" class="pagination pagination-sm mb-0"></ul>
    </nav>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <form id="confirmForm">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Confirm Payment</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modalPaymentId">
          <div class="mb-3">
            <label for="feedback" class="form-label">Feedback to Client (optional):</label>
            <textarea id="feedback" class="form-control" rows="3" placeholder="e.g., Your payment has been received successfully. Thank you!"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Confirm Payment
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Libs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  // ‚Äî‚Äî‚Äî Client-side pagination (no Jinja in JS) ‚Äî‚Äî‚Äî
  var tableBody   = document.getElementById('paymentsTable');
  var pagination  = document.getElementById('pagination');
  var rangeStart  = document.getElementById('rangeStart');
  var rangeEnd    = document.getElementById('rangeEnd');
  var totalCount  = document.getElementById('totalCount');
  var pageSizeSel = document.getElementById('pageSize');

  var pageSize    = Number(pageSizeSel.value) || 10;
  var currentPage = 1;

  function getAllRows() {
    return Array.prototype.slice.call(tableBody.querySelectorAll('tr'));
  }

  function renderPagination(total, totalPages) {
    var win = 2;
    function btn(label, page, disabled, active) {
      return '' +
        '<li class="page-item ' + (disabled ? 'disabled ' : '') + (active ? 'active' : '') + '">' +
          '<a class="page-link" href="#" data-page="' + page + '">' + label + '</a>' +
        '</li>';
    }

    var html = '';
    html += btn('¬´ First', 1, currentPage === 1, false);
    html += btn('Prev', Math.max(1, currentPage - 1), currentPage === 1, false);

    var start = Math.max(1, currentPage - win);
    var end   = Math.min(totalPages, currentPage + win);

    if (start > 1) {
      html += btn('1', 1, false, false);
      if (start > 2) html += '<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>';
    }
    for (var p = start; p <= end; p++) {
      html += btn(String(p), p, false, p === currentPage);
    }
    if (end < totalPages) {
      if (end < totalPages - 1) html += '<li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>';
      html += btn(String(totalPages), totalPages, false, false);
    }

    html += btn('Next', Math.min(totalPages, currentPage + 1), currentPage === totalPages, false);
    html += btn('Last ¬ª', totalPages, currentPage === totalPages, false);

    pagination.innerHTML = html;
    Array.prototype.forEach.call(pagination.querySelectorAll('a.page-link[data-page]'), function(a) {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        var target = Number(a.getAttribute('data-page'));
        if (!isNaN(target) && target !== currentPage) {
          currentPage = target;
          renderPage();
        }
      });
    });
  }

  function renderPage() {
    var rows = getAllRows();
    var total = rows.length;
    totalCount.textContent = String(total);

    var totalPages = Math.max(Math.ceil(total / pageSize), 1);
    if (currentPage > totalPages) currentPage = totalPages;

    var startIdx = (currentPage - 1) * pageSize;
    var endIdx   = Math.min(startIdx + pageSize, total);

    for (var i = 0; i < rows.length; i++) {
      rows[i].style.display = (i >= startIdx && i < endIdx) ? '' : 'none';
    }

    rangeStart.textContent = total ? (startIdx + 1) : 0;
    rangeEnd.textContent   = endIdx;
    renderPagination(total, totalPages);
  }

  document.addEventListener('DOMContentLoaded', function () {
    renderPage();
  });

  pageSizeSel.addEventListener('change', function () {
    pageSize = Number(pageSizeSel.value) || 10;
    currentPage = 1;
    renderPage();
  });

  // ‚Äî‚Äî‚Äî Confirm Modal ‚Äî‚Äî‚Äî
  function openConfirmModal(paymentId) {
    document.getElementById('modalPaymentId').value = paymentId;
    document.getElementById('feedback').value = '';
    var modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
  }
  window.openConfirmModal = openConfirmModal;

  document.getElementById('confirmForm').addEventListener('submit', function (e) {
    e.preventDefault();
    var paymentId = document.getElementById('modalPaymentId').value;
    var feedback  = document.getElementById('feedback').value;

    fetch('/confirm_payment/' + encodeURIComponent(paymentId), {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: new URLSearchParams({feedback: feedback})
    })
    .then(function(r){ return r.json(); })
    .then(function(res){
      if (res.success) {
        var row = document.querySelector('tr[data-payment-id="' + paymentId + '"]');
        if (!row) {
          // fallback (older selector)
          var btn = document.querySelector('button[onclick="openConfirmModal(\'' + paymentId + '\')"]');
          if (btn) row = btn.closest('tr');
        }
        if (row) {
          var statusCell = row.querySelector('.col-status');
          var actionCell = row.querySelector('.col-action');
          if (statusCell) statusCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Confirmed</span>';
          if (actionCell) actionCell.innerHTML = '<span class="text-muted"><i class="fas fa-check-double"></i> Done</span>';

          // If backend sent aggregates, refresh Order / Paid / Left
          if (res.order_code) {
            var codeEl = row.querySelector('.order-code');
            if (codeEl) codeEl.textContent = res.order_code;
          }
          if (typeof res.total_paid !== 'undefined') {
            var paidEl = row.querySelector('.total-paid');
            if (paidEl) {
              paidEl.setAttribute('data-raw', String(res.total_paid || 0));
              paidEl.textContent = 'GHS ' + Number(res.total_paid || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            }
          }
          if (typeof res.amount_left !== 'undefined') {
            var leftEl = row.querySelector('.amount-left');
            if (leftEl) {
              leftEl.setAttribute('data-raw', String(res.amount_left || 0));
              leftEl.textContent = 'GHS ' + Number(res.amount_left || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            }
          }
        }
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
      } else {
        alert('Error: ' + (res.error || 'Unknown error'));
      }
    })
    .catch(function(){ alert('Network error. Please try again.'); });
  });

  // ‚Äî‚Äî‚Äî Export current (visible) page to Excel ‚Äî‚Äî‚Äî
  function exportToExcel() {
    var rows = [];
    rows.push([
      'Date','Client','Client ID','Phone',
      'Amount (GHS)','Order','Total Paid (GHS)','Amount Left (GHS)',
      'Bank','Account Last4','Status','Proof URL'
    ]);

    Array.prototype.forEach.call(document.querySelectorAll('#paymentsTable tr'), function(tr){
      if (tr.style.display === 'none') return; // only current page
      var tds = tr.querySelectorAll('td');

      var date = (tds[0] && tds[0].textContent || '').trim();
      var clientName = (tds[1] && tds[1].querySelector('.client-name') && tds[1].querySelector('.client-name').textContent || '').trim();
      var clientId   = (tds[1] && tds[1].querySelector('.client-id') && tds[1].querySelector('.client-id').textContent || '').trim();
      var phone = (tds[2] && tds[2].textContent || '').trim();

      var amtEl = tds[3] && tds[3].querySelector('.amount');
      var amount = Number((amtEl && amtEl.getAttribute('data-raw')) || 0);

      var orderCode = (tds[4] && tds[4].querySelector('.order-code') && tds[4].querySelector('.order-code').textContent || '').trim();

      var paidEl = tds[5] && tds[5].querySelector('.total-paid');
      var totalPaid = Number((paidEl && paidEl.getAttribute('data-raw')) || 0);

      var leftEl = tds[6] && tds[6].querySelector('.amount-left');
      var amountLeft = Number((leftEl && leftEl.getAttribute('data-raw')) || 0);

      var bankText = (tds[7] && tds[7].textContent || '').trim();
      var m = bankText.match(/\*{4}(\d{4})/);
      var last4 = m ? m[1] : '';
      var bank  = bankText.replace(/\(.*\)$/, '').trim();

      var status = (tds[8] && tds[8].textContent || '').trim();
      var proofLink = (tds[9] && tds[9].querySelector('a')) ? tds[9].querySelector('a').getAttribute('href') : '';

      rows.push([date, clientName, clientId, phone, amount, orderCode, totalPaid, amountLeft, bank, last4, status, proofLink]);
    });

    var ws = XLSX.utils.aoa_to_sheet(rows);
    var range = XLSX.utils.decode_range(ws['!ref']);
    // Format numeric money columns
    ['E','G','H'].forEach(function(col){
      for (var r = 1; r <= range.e.r; r++) {
        var addr = col + (r+1);
        if (ws[addr]) { ws[addr].t = 'n'; ws[addr].z = '#,##0.00'; }
      }
    });
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Payments');
    var today = new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb, 'Payments_' + today + '.xlsx');
  }
  window.exportToExcel = exportToExcel;
</script>
