<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cancel Orders | TrueType</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
<style>
  :root{
    --bg:#f6f8fb; --ok:#16a34a; --warn:#f59e0b; --err:#dc3545; --muted:#6b7280;
    --ink:#0b1320; --line:#e5e7eb; --soft:#ffffff;
  }
  body{background:var(--bg)}
  .card{border-radius:14px}
  .step{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .step .dot{width:14px;height:14px;border-radius:50%;background:#e2e8f0}
  .step.done .dot{background:var(--ok)}
  .code{font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
  .dim{opacity:.6}
  .skeleton{position:relative;overflow:hidden;background:#e9ecef;border-radius:8px;min-height:18px}
  .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);
    background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.6) 50%, rgba(255,255,255,0) 100%);
    animation:shimmer 1.1s infinite;}
  @keyframes shimmer{100%{transform:translateX(100%)}}
  .btn-loading{position:relative;pointer-events:none;opacity:.8}
  .btn-loading .spinner-border{width:1rem;height:1rem;border-width:.15em}
  .right-badge{font-size:.75rem}
  .sticky-actions{position:sticky;bottom:0;background:#fff;border-top:1px solid #eee;padding-top:12px}
  @media (max-width: 576px){ .header-row{gap:.5rem} }

  /* History table */
  .table thead th{font-size:.8rem; color:#334155; text-transform:uppercase; letter-spacing:.02em}
  .table td{vertical-align:middle}
  .badge-soft{background:#f1f5f9; color:#0f172a; border:1px solid #e2e8f0}
  .filters .form-control, .filters .form-select{border-radius:10px}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .5rem;border-radius:999px;background:#eef2ff;font-size:.75rem}
  .loading-overlay{
  position: absolute; inset: 0; display:flex; align-items:center; justify-content:center;
  gap:.75rem; background:rgba(255,255,255,.75); z-index:5; border-radius:12px;
}
.loading-overlay .spinner-border{ width:1.4rem; height:1.4rem; border-width:.18rem }

</style>
</head>
<body class="p-3 p-md-4">
<div class="container">
  <div class="mb-4">
    <div class="d-flex align-items-center justify-content-between header-row flex-wrap">
      <h3 class="fw-semibold mb-0"><i class="bi bi-x-octagon me-2"></i>Cancel Orders</h3>
      <span class="text-muted small">Select client → pick order → refund (optional) → cancel</span>
    </div>
  </div>

  <div class="row g-3">
    <!-- Left: Client & Recent Orders -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <label class="form-label">Client</label>
          <div class="input-group">
            <select id="clientSelect" class="form-select">
              <option value="">— Choose client —</option>
              {% for c in clients %}
                <option value="{{ c._id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
            <span id="clientLoad" class="input-group-text d-none">
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            </span>
          </div>

          <div id="ordersWrap" class="mt-3 d-none">
            <label class="form-label">Recent Orders</label>
            <div class="input-group">
              <select id="orderSelect" class="form-select"></select>
              <span id="ordersLoad" class="input-group-text d-none">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </span>
            </div>
            <div id="noOrders" class="text-muted small mt-2 d-none">No recent orders for this client.</div>
          </div>

          <div id="impactWrap" class="mt-3 d-none">
            <div class="small text-muted">Impact preview (dry‑run)</div>
            <div class="mt-2" id="impactSkeleton">
              <div class="skeleton mb-2"></div>
              <div class="skeleton mb-2"></div>
              <div class="skeleton mb-2"></div>
            </div>
            <ul class="list-group small mt-2 d-none" id="impactList">
              <li class="list-group-item d-flex justify-content-between">
                Client payments <span id="impPay" class="code">0 / GHS 0.00</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                Central BDC payments <span id="impSBDC" class="code">0</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                BDC payment_details (legacy) <span id="impBDCPull" class="code">0</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                BDC transactions <span id="impBDCTxn" class="code">0</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                Tax records (NPA/TTS) <span id="impTax" class="code">0</span>
              </li>
            </ul>
            <div id="impWarnings" class="mt-2 small d-none"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Order Details & Actions -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div id="orderDetails" class="d-none">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
              <h5 class="fw-semibold mb-0">Order details</h5>
              <span id="orderBadge" class="badge bg-secondary right-badge"></span>
              <div id="detailLoader" class="loading-overlay d-none">
  <div class="spinner-border" role="status" aria-hidden="true"></div>
  <span class="small">Loading details…</span>
</div>

            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-4">
                <div class="text-muted small">Product</div>
                <div id="odProduct" class="fw-semibold skeleton"></div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">Region</div>
                <div id="odRegion" class="fw-semibold skeleton"></div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">Quantity</div>
                <div id="odQty" class="fw-semibold skeleton"></div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">Status</div>
                <div id="odStatus" class="fw-semibold skeleton"></div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">Delivery</div>
                <div id="odDelivery" class="fw-semibold skeleton"></div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">Debt</div>
                <div id="odDebt" class="fw-semibold skeleton"></div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">NPA</div>
                <div id="odNPA" class="fw-semibold skeleton"></div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">TTS</div>
                <div id="odTTS" class="fw-semibold skeleton"></div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">Total Paid</div>
                <div id="odPaid" class="fw-semibold skeleton"></div>
              </div>
            </div>

            <div class="sticky-actions mt-3">
              <div class="d-flex gap-2 flex-wrap">
                <button id="btnRefund" class="btn btn-outline-warning">
                  <span class="spinner-border d-none me-2" role="status" aria-hidden="true"></span>
                  <i class="bi bi-cash-coin me-1"></i> Refund client payments
                </button>
                <button id="btnCancel" class="btn btn-danger">
                  <span class="spinner-border d-none me-2" role="status" aria-hidden="true"></span>
                  <i class="bi bi-x-octagon me-1"></i> Cancel order
                </button>
              </div>

              <div class="mt-3">
                <label class="form-label small">Reason</label>
                <input id="cancelReason" class="form-control" placeholder="Why are we cancelling? (required)" />
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="forceCancel">
                  <label class="form-check-label small" for="forceCancel">Force (allow if delivered or confirmed payments remain)</label>
                </div>
              </div>

              <hr>
              <div>
                <div class="step" id="st1"><span class="dot"></span><span>Verify order & load impact</span></div>
                <div class="step" id="st2"><span class="dot"></span><span>Refund client payments (optional)</span></div>
                <div class="step" id="st3"><span class="dot"></span><span>Delete side‑effects (BDC / tax)</span></div>
                <div class="step" id="st4"><span class="dot"></span><span>Mark order / NPA / TTS cancelled, zero debt</span></div>
                <div class="step" id="st5"><span class="dot"></span><span>Done</span></div>
              </div>

              <div id="msg" class="mt-3 small text-muted"></div>
            </div>
          </div>

          <div id="placeholder" class="text-muted">Choose a client to begin.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Cancellation History ===== -->
  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="mb-0"><i class="bi bi-journal-x me-2"></i>Cancellation History</h5>
        <div class="d-flex align-items-center gap-2 filters">
          <input id="histSearch" class="form-control form-control-sm" placeholder="Search reason / product / order / client">
          <select id="histClient" class="form-select form-select-sm" style="min-width:180px">
            <option value="">All clients</option>
            {% for c in clients %}
              <option value="{{ c._id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
          <input id="histFrom" type="date" class="form-control form-control-sm">
          <input id="histTo" type="date" class="form-control form-control-sm">
          <button id="histFilterBtn" class="btn btn-sm btn-outline-primary"><i class="bi bi-funnel me-1"></i>Filter</button>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Order</th>
              <th>Client</th>
              <th>Product / Qty</th>
              <th>Paid</th>
              <th>Reason</th>
              <th>By</th>
              <th>Removed</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="histBody">
            <!-- rows injected -->
          </tbody>
        </table>
      </div>

      <div id="histEmpty" class="text-center text-muted py-4 d-none">
        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
        No cancellations found for the selected filters.
      </div>

      <div id="histLoading" class="py-2">
        <div class="skeleton mb-2"></div>
        <div class="skeleton mb-2"></div>
        <div class="skeleton mb-2"></div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-2">
        <div class="small text-muted" id="histMeta"></div>
        <div class="btn-group">
          <button id="histPrev" class="btn btn-sm btn-outline-secondary" disabled>Prev</button>
          <button id="histNext" class="btn btn-sm btn-outline-secondary" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
  <div id="toastStack" class="toast-container"></div>
</div>

<!-- Confirm Modals (existing) -->
<div class="modal fade" id="confirmRefund" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title"><i class="bi bi-cash-coin me-2"></i>Confirm refund</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        This will set <span class="fw-semibold">feedback="refunded"</span> and <span class="fw-semibold">amount=0</span> for all confirmed payments on this order. Proceed?
      </div>
      <div class="modal-footer">
        <button class="btn btn-link" data-bs-dismiss="modal">Close</button>
        <button id="confirmRefundYes" class="btn btn-warning">Refund</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmCancel" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title"><i class="bi bi-x-octagon me-2"></i>Confirm cancellation</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        This will remove side‑effects (BDC/tax), zero debt, and mark the order/NPA/TTS as <span class="fw-semibold text-danger">cancelled</span>. Continue?
      </div>
      <div class="modal-footer">
        <button class="btn btn-link" data-bs-dismiss="modal">Close</button>
        <button id="confirmCancelYes" class="btn btn-danger">Cancel order</button>
      </div>
    </div>
  </div>
</div>

<!-- History detail modal -->
<div class="modal fade" id="histDetail" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title"><i class="bi bi-card-text me-2"></i>Cancellation details</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3" id="histDetailBody">
          <!-- filled dynamically -->
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ---------- Utilities (compat-safe) ----------
function fmt(n){
  var v = Number(n||0);
  return new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v);
}
var toastStack = document.getElementById('toastStack');
function makeToast(msg, type){
  if(!type){ type = "info"; }
  var icons = {success:"check-circle", info:"info-circle", warning:"exclamation-triangle", danger:"x-octagon"};
  var t = document.createElement('div');
  t.className = "toast align-items-center text-bg-light border-0 show";
  t.setAttribute('role','alert'); t.setAttribute('aria-live','assertive'); t.setAttribute('aria-atomic','true');
  t.innerHTML =
    '<div class="d-flex">' +
      '<div class="toast-body"><i class="bi bi-'+(icons[type]||'info-circle')+' me-2"></i>'+ String(msg||'') +'</div>' +
      '<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>' +
    '</div>';
  toastStack.appendChild(t);
  new bootstrap.Toast(t, { delay: 3500 }).show();
  t.addEventListener('hidden.bs.toast', function(){ t.remove(); });
}

// Safe DOM helpers
function el(id){ return document.getElementById(id); }
function setText(id, val){
  var d = el(id); if(!d) return;
  d.classList.remove('skeleton'); d.textContent = (val==null?'-':String(val));
}
function setBadgeText(id, val){
  var d = el(id); if(!d) return;
  d.textContent = (val==null?'':String(val));
}

// Very defensive getter: get(x, "a.b.c")
function get(obj, path, fallback){
  try{
    var parts = path.split('.');
    var cur = obj;
    for(var i=0;i<parts.length;i++){
      if(cur==null){ return fallback; }
      cur = cur[parts[i]];
    }
    return (typeof cur==='undefined' ? fallback : cur);
  }catch(e){ return fallback; }
}

// Button loading wrapper
function withBtnLoading(btn, fn){
  var spin = btn ? btn.querySelector('.spinner-border') : null;
  if(btn){
    btn.classList.add('btn-loading');
    if(spin) spin.classList.remove('d-none');
    btn.disabled = true;
  }
  var finalize = function(){
    if(btn){
      btn.classList.remove('btn-loading');
      if(spin) spin.classList.add('d-none');
      btn.disabled = false;
    }
  };
  return Promise.resolve().then(fn).then(function(r){ finalize(); return r; }, function(err){ finalize(); throw err; });
}

// Fetch wrapper with timeout + abort (fast UX)
var lastController = null;
function api(url, opts){
  if(!opts) opts = {};
  // cancel previous same-kind request for snappiness when switching fast
  if(lastController){ try{ lastController.abort(); }catch(e){} }
  var controller = new AbortController();
  opts.signal = controller.signal;
  lastController = controller;

  // 6s timeout
  var to = setTimeout(function(){ try{ controller.abort(); }catch(e){} }, 6000);

  return fetch(url, opts).then(function(r){
    clearTimeout(to);
    return r.json().catch(function(){ return {}; }).then(function(j){
      if(!r.ok || !j || !j.success){
        var msg = (j && (j.error || j.message)) || ('Request failed ('+r.status+')');
        throw new Error(msg);
      }
      return j;
    });
  });
}

// ---------- State & static refs ----------
var selectedOrderId = null, lastImpact = null;

function mark(id){ var s = el(id); if(s) s.classList.add('done'); }
function clearSteps(){
  var nodes = document.querySelectorAll('.step');
  for(var i=0;i<nodes.length;i++){ nodes[i].classList.remove('done'); }
}

// ---------- Elements ----------
var clientSelect = el('clientSelect');
var clientLoad   = el('clientLoad');
var ordersWrap   = el('ordersWrap');
var orderSelect  = el('orderSelect');
var ordersLoad   = el('ordersLoad');
var impactWrap   = el('impactWrap');
var impactSkeleton = el('impactSkeleton');
var impactList   = el('impactList');
var impWarnings  = el('impWarnings');
var detailLoader = el('detailLoader'); // overlay

var fields = ['odProduct','odRegion','odQty','odStatus','odDelivery','odDebt','odNPA','odTTS','odPaid'];

// ---------- Client change ----------
if(clientSelect){
  clientSelect.addEventListener('change', function(e){
    var cid = e.target.value;
    ordersWrap.classList.add('d-none'); impactWrap.classList.add('d-none');
    el('orderDetails').classList.add('d-none'); el('placeholder').classList.remove('d-none');
    el('noOrders').classList.add('d-none'); clearSteps(); orderSelect.innerHTML = '';
    if(!cid) return;

    clientLoad.classList.remove('d-none');
    api('/orders/cancel/client/'+cid+'/recent').then(function(j){
      orderSelect.innerHTML = '';
      if(!j.orders || !j.orders.length){
        el('noOrders').classList.remove('d-none');
      }else{
        for(var i=0;i<j.orders.length;i++){
          var o = j.orders[i];
          var opt = document.createElement('option');
          opt.value = o.order_id;
          opt.setAttribute('data-json', JSON.stringify(o));
          var txt = new Date(o.date).toLocaleDateString() + ' — ' + (o.product||'-') + ' — ' +
                    Number(o.quantity||0).toLocaleString() + 'L — ' + (o.status||'-') +
                    ' — Paid GHS ' + fmt(o.paid_total||0);
          opt.textContent = txt;
          orderSelect.appendChild(opt);
        }
      }
      ordersWrap.classList.remove('d-none');
      makeToast('Client loaded. Choose an order.', 'info');
    }).catch(function(err){
      makeToast(err.message, 'danger');
    }).finally(function(){
      clientLoad.classList.add('d-none');
    });
  });
}

// ---------- Order change ----------
if(orderSelect){
  orderSelect.addEventListener('change', function(e){
    var opt = e.target.options[e.target.selectedIndex];
    if(!opt) return;
    var json = opt.getAttribute('data-json');
    var o = {};
    try{ o = JSON.parse(json||'{}'); }catch(e2){ o = {}; }

    selectedOrderId = o.order_id;

    // Show details area with skeletons & overlay
    el('placeholder').classList.add('d-none');
    var details = el('orderDetails');
    details.classList.remove('d-none');
    for(var i=0;i<fields.length;i++){
      var d = el(fields[i]);
      if(d){ d.textContent = ''; d.classList.add('skeleton'); }
    }
    if(detailLoader){ detailLoader.classList.remove('d-none'); }

    // Fill quick facts immediately
    setTimeout(function(){
      setText('odProduct', o.product||'-');
      setText('odRegion',  o.region||'-');
      setText('odQty',     Number(o.quantity||0).toLocaleString());
      setText('odStatus',  o.status||'-');
      setText('odDelivery',o.delivery_status||'-');
      setText('odDebt',    'GHS '+fmt(o.total_debt||0));
      setText('odNPA',     o.npa_status||'-');
      setText('odTTS',     o.tts_status||'-');
      setText('odPaid',    'GHS '+fmt(o.paid_total||0));
      setBadgeText('orderBadge', o.status||'');
    }, 30);

    clearSteps(); mark('st1');

    // Show impact area & start fetch
    impactWrap.classList.remove('d-none');
    impactSkeleton.classList.remove('d-none'); impactList.classList.add('d-none');
    impWarnings.classList.add('d-none'); impWarnings.textContent = '';

    ordersLoad.classList.remove('d-none');
    api('/orders/cancel/impact/'+selectedOrderId).then(function(j){
      lastImpact = j.impact || {};
      el('impPay').textContent  = String(get(lastImpact,'payments.count',0)) + ' / GHS ' + fmt(get(lastImpact,'payments.sum',0));
      el('impSBDC').textContent = String(get(lastImpact,'s_bdc_payment',0));
      el('impBDCPull').textContent = String(get(lastImpact,'bdc_payment_details_hits',0));
      el('impBDCTxn').textContent  = String(get(lastImpact,'bdc_transactions',0));
      el('impTax').textContent     = String(get(lastImpact,'tax_records',0));
      setText('odPaid', 'GHS '+fmt(get(lastImpact,'payments.sum',0)));

      var warn = [];
      if(get(lastImpact,'delivered',false)) warn.push('Order is already delivered.');
      if(get(lastImpact,'has_confirmed_payments',false)) warn.push('Confirmed client payments exist (refund or force).');
      if(warn.length){
        impWarnings.classList.remove('d-none');
        // just pick a color class; no template expressions
        impWarnings.classList.remove('text-danger'); impWarnings.classList.remove('text-warning');
        impWarnings.classList.add(get(lastImpact,'has_confirmed_payments',false) ? 'text-warning' : 'text-danger');
        impWarnings.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>'+ warn.join(' ');
      }

      impactSkeleton.classList.add('d-none'); impactList.classList.remove('d-none');
      makeToast('Impact loaded.', 'success');
    }).catch(function(err){
      impactSkeleton.classList.add('d-none'); impactList.classList.add('d-none');
      makeToast(err.message, 'danger');
    }).finally(function(){
      ordersLoad.classList.add('d-none');
      if(detailLoader){ detailLoader.classList.add('d-none'); }
    });
  });
}

// ---------- Refund ----------
var refundModal = new bootstrap.Modal('#confirmRefund');
el('btnRefund').addEventListener('click', function(){
  if(!selectedOrderId){ makeToast('Pick an order first.', 'warning'); return; }
  refundModal.show();
});
el('confirmRefundYes').addEventListener('click', function(){
  var btn = el('btnRefund');
  refundModal.hide();
  withBtnLoading(btn, function(){
    return api('/orders/cancel/refund/'+selectedOrderId, {method:'POST'}).then(function(j){
      makeToast('Refunded '+ (j.refunded_count||0) +' payment(s).', 'success');
      mark('st2');
      return api('/orders/cancel/impact/'+selectedOrderId).then(function(k){
        el('impPay').textContent = String(get(k,'impact.payments.count',0)) + ' / GHS ' + fmt(get(k,'impact.payments.sum',0));
        setText('odPaid', 'GHS '+fmt(get(k,'impact.payments.sum',0)));
      });
    }).catch(function(err){ makeToast(err.message, 'danger'); });
  });
});

// ---------- Cancel ----------
var cancelModal = new bootstrap.Modal('#confirmCancel');
el('btnCancel').addEventListener('click', function(){
  if(!selectedOrderId){ makeToast('Pick an order first.', 'warning'); return; }
  var reason = el('cancelReason').value; reason = reason ? String(reason).trim() : '';
  if(!reason){ makeToast('Reason is required.', 'warning'); return; }
  cancelModal.show();
});
el('confirmCancelYes').addEventListener('click', function(){
  var btn = el('btnCancel');
  cancelModal.hide();
  withBtnLoading(btn, function(){
    var reason = el('cancelReason').value; reason = reason ? String(reason).trim() : '';
    var force  = !!el('forceCancel').checked;
    return api('/orders/cancel/execute/'+selectedOrderId, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({reason:reason, force:force})
    }).then(function(j){
      makeToast(j.message || 'Order cancelled.', 'success');
      mark('st3'); mark('st4'); mark('st5');
      setText('odDebt', 'GHS 0.00');
      setText('odStatus', 'cancelled');
      setText('odDelivery', 'cancelled');
      setText('odNPA', 'cancelled');
      setText('odTTS', 'cancelled');
      setBadgeText('orderBadge', 'cancelled');
      el('msg').textContent = 'Order updated and postings removed.';
      histPage = 1; return loadHistory();
    }).catch(function(err){ makeToast(err.message, 'danger'); });
  });
});

// ---------- History (compat) ----------
var histBody = el('histBody');
var histLoading = el('histLoading');
var histEmpty = el('histEmpty');
var histMeta = el('histMeta');
var histPrev = el('histPrev');
var histNext = el('histNext');
var histSearch = el('histSearch');
var histClient = el('histClient');
var histFrom = el('histFrom');
var histTo = el('histTo');
var histFilterBtn = el('histFilterBtn');

var histPage = 1, histSize = 10, histTotal = 0;

function esc(s){
  return String(s==null?'-':s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function rowHTML(x){
  var whenDate = new Date(x.at || x.cancelled_at || get(x,'order.cancelled_at', Date.now()));
  var when = whenDate.toLocaleString();
  var product = get(x,'snapshot.product', get(x,'order.product','-'));
  var qty = get(x,'snapshot.quantity', get(x,'order.quantity',0));
  var clientName = get(x,'client.name', get(x,'snapshot.client_name','-'));
  var paid = get(x,'snapshot.paid_sum', x.paid_sum||0);

  var removed = [];
  if(get(x,'deleted.s_bdc_payment_count',0)) removed.push('<span class="pill"><i class="bi bi-bank2"></i> '+esc(get(x,'deleted.s_bdc_payment_count',0))+' SBDC</span>');
  if(get(x,'deleted.bdc_transactions_deleted',0)) removed.push('<span class="pill"><i class="bi bi-cash"></i> '+esc(get(x,'deleted.bdc_transactions_deleted',0))+' BDC TXN</span>');
  if(get(x,'deleted.tax_records_deleted',0)) removed.push('<span class="pill"><i class="bi bi-receipt"></i> '+esc(get(x,'deleted.tax_records_deleted',0))+' Tax</span>');
  if(get(x,'deleted.bdc_payment_details_updates',0)) removed.push('<span class="pill"><i class="bi bi-diagram-3"></i> '+esc(get(x,'deleted.bdc_payment_details_updates',0))+' Legacy</span>');

  return ''+
  '<tr>'+
    '<td class="small">'+esc(when)+'</td>'+
    '<td><span class="code">'+esc(x.order_id)+'</span></td>'+
    '<td>'+esc(clientName)+'</td>'+
    '<td><div class="fw-semibold">'+esc(product)+'</div><div class="text-muted small">'+esc(Number(qty||0).toLocaleString())+' L</div></td>'+
    '<td>GHS '+fmt(paid||0)+'</td>'+
    '<td class="text-wrap" style="max-width:260px">'+esc(x.reason||'-')+'</td>'+
    '<td class="small">'+esc(x.by_user||'-')+'</td>'+
    '<td class="small">'+(removed.length? removed.join(' ') : '<span class="badge badge-soft">—</span>')+'</td>'+
    '<td class="text-end">'+
      '<button class="btn btn-sm btn-outline-secondary" data-view="'+esc(x._id)+'"><i class="bi bi-eye"></i></button>'+
    '</td>'+
  '</tr>';
}

function bindDetailButtons(){
  var btns = histBody.querySelectorAll('button[data-view]');
  for(var i=0;i<btns.length;i++){
    (function(b){
      b.addEventListener('click', function(){
        openDetail(b.getAttribute('data-view'));
      });
    })(btns[i]);
  }
}

function loadHistory(){
  histLoading.classList.remove('d-none');
  histEmpty.classList.add('d-none');
  histBody.innerHTML = '';

  var params = new URLSearchParams();
  params.set('page', String(histPage));
  params.set('size', String(histSize));
  params.set('q', (histSearch.value||'').trim());
  params.set('client_id', histClient.value||'');
  params.set('from', histFrom.value||'');
  params.set('to', histTo.value||'');

  return api('/orders/cancel/history?'+params.toString()).then(function(j){
    histTotal = j.total || 0;
    var items = j.items || [];
    if(!items.length){ histEmpty.classList.remove('d-none'); }
    var html = '';
    for(var i=0;i<items.length;i++){ html += rowHTML(items[i]); }
    histBody.innerHTML = html;

    var shown = items.length ? (((histPage-1)*histSize)+1) + '–' + (((histPage-1)*histSize)+items.length) : '0';
    histMeta.textContent = items.length ? ('Showing '+shown+' of '+histTotal) : 'No results';
    histPrev.disabled = histPage<=1;
    histNext.disabled = (histPage*histSize) >= histTotal;

    bindDetailButtons();
  }).catch(function(err){
    makeToast(err.message, 'danger');
  }).finally(function(){
    histLoading.classList.add('d-none');
  });
}

function openDetail(id){
  api('/orders/cancel/history/item/'+id).then(function(j){
    var x = j.item||{};
    var d = new Date(x.at || x.cancelled_at || get(x,'order.cancelled_at', Date.now()));
    var product = get(x,'snapshot.product', get(x,'order.product','-'));
    var client = get(x,'client.name', get(x,'snapshot.client_name','-'));
    var qty = get(x,'snapshot.quantity', get(x,'order.quantity',0));
    var paid = get(x,'snapshot.paid_sum', x.paid_sum||0);

    var removed = ''+
      '<span class="pill"><i class="bi bi-bank2"></i> '+esc(get(x,'deleted.s_bdc_payment_count',0))+' SBDC</span> '+
      '<span class="pill"><i class="bi bi-cash"></i> '+esc(get(x,'deleted.bdc_transactions_deleted',0))+' BDC TXN</span> '+
      '<span class="pill"><i class="bi bi-receipt"></i> '+esc(get(x,'deleted.tax_records_deleted',0))+' Tax</span> '+
      '<span class="pill"><i class="bi bi-diagram-3"></i> '+esc(get(x,'deleted.bdc_payment_details_updates',0))+' Legacy</span>';

    var body = el('histDetailBody');
    body.innerHTML =
      '<div class="col-md-6"><div class="text-muted small">Date</div><div class="fw-semibold">'+esc(d.toLocaleString())+'</div></div>'+
      '<div class="col-md-6"><div class="text-muted small">Order ID</div><div class="code">'+esc(x.order_id)+'</div></div>'+
      '<div class="col-md-6"><div class="text-muted small">Client</div><div class="fw-semibold">'+esc(client)+'</div></div>'+
      '<div class="col-md-6"><div class="text-muted small">Cancelled by</div><div class="fw-semibold">'+esc(x.by_user||'-')+'</div></div>'+
      '<div class="col-md-6"><div class="text-muted small">Product</div><div class="fw-semibold">'+esc(product)+'</div></div>'+
      '<div class="col-md-6"><div class="text-muted small">Quantity</div><div class="fw-semibold">'+esc(Number(qty||0).toLocaleString())+' L</div></div>'+
      '<div class="col-md-6"><div class="text-muted small">Paid at cancel</div><div class="fw-semibold">GHS '+fmt(paid||0)+'</div></div>'+
      '<div class="col-md-6"><div class="text-muted small">Reason</div><div class="fw-semibold">'+esc(x.reason||'-')+'</div></div>'+
      '<div class="col-12"><div class="text-muted small">Removed postings</div><div>'+ removed +'</div></div>';
    new bootstrap.Modal('#histDetail').show();
  }).catch(function(err){
    makeToast(err.message, 'danger');
  });
}

// History paging & filters
histPrev.addEventListener('click', function(){ if(histPage>1){ histPage--; loadHistory(); } });
histNext.addEventListener('click', function(){ if(histPage*histSize < histTotal){ histPage++; loadHistory(); } });
histFilterBtn.addEventListener('click', function(){ histPage=1; loadHistory(); });
histSearch.addEventListener('keydown', function(e){ if(e.key==='Enter'){ histPage=1; loadHistory(); } });

// initial history load
loadHistory();
</script>

</body>
</html>
