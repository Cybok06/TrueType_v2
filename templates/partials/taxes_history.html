<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Taxes Payment History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card { border-radius: 1rem; }
    .small-muted { font-size: .9rem; color: #6c757d; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table thead th { white-space: nowrap; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Taxes Payment History</h3>
    <span class="small-muted">Filter OMC P-Tax and BDC allocations by bank, counterparty, date, and order.</span>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label class="form-label">Kind</label>
          <select id="flt_kind" class="form-select">
            <option value="omc">OMC (P-Tax)</option>
            <option value="bdc">BDC</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Bank</label>
          <select id="flt_bank" class="form-select">
            <option value="">— Any Bank —</option>
            {% for b in banks %}
              <option value="{{ b._id }}">{{ b.bank_name }} — {{ b.account_name }} (…{{ (b.account_number or '')[-4:] }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">OMC</label>
          <select id="flt_omc" class="form-select">
            <option value="">— Any OMC —</option>
            {% for o in omcs %}
              <option value="{{ o.name }}">{{ o.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">BDC</label>
          <select id="flt_bdc" class="form-select">
            <option value="">— Any BDC —</option>
            {% for b in bdcs %}
              <option value="{{ b._id }}">{{ b.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Start Date</label>
          <input type="date" id="flt_start" class="form-control">
        </div>

        <div class="col-md-2">
          <label class="form-label">End Date</label>
          <input type="date" id="flt_end" class="form-control">
        </div>

        <div class="col-md-3">
          <label class="form-label">Order ID</label>
          <input type="text" id="flt_order" class="form-control" placeholder="e.g. JJRRA">
        </div>

        <div class="col-md-2">
          <button id="btn_filter" class="btn btn-dark w-100">Filter</button>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm table-striped align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Party</th>
              <th>Order ID</th>
              <th class="text-end">Amount (GHS)</th>
              <th class="text-end">Per-Litre</th>
              <th>Reference</th>
              <th>Paid By</th>
              <th>Bank</th>
            </tr>
          </thead>
          <tbody id="hist_tbody">
            <tr><td colspan="8" class="text-muted">Use the filters and click “Filter”.</td></tr>
          </tbody>
          <tfoot>
            <tr>
              <th colspan="3" class="text-end">Total</th>
              <th id="hist_total" class="text-end mono">0.00</th>
              <th colspan="4"></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div id="hist_msg" class="small mt-2"></div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
(function(){
  const fmt = n => (Number(n || 0)).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

  function togglePartyControls(){
    const k = $("#flt_kind").val();
    if(k === "omc"){
      $("#flt_omc").prop("disabled", false);
      $("#flt_bdc").prop("disabled", true).val("");
    } else {
      $("#flt_omc").prop("disabled", true).val("");
      $("#flt_bdc").prop("disabled", false);
    }
  }

  async function runFilter(){
    $("#hist_msg").removeClass().text("");
    $("#hist_tbody").html(`<tr><td colspan="8" class="text-muted">Loading…</td></tr>`);
    $("#hist_total").text("0.00");

    const params = new URLSearchParams();
    params.set("kind", $("#flt_kind").val());
    if($("#flt_bank").val())  params.set("bank_id",  $("#flt_bank").val());
    if($("#flt_omc").val())   params.set("omc_name", $("#flt_omc").val());
    if($("#flt_bdc").val())   params.set("bdc_id",   $("#flt_bdc").val());
    if($("#flt_start").val()) params.set("start_date", $("#flt_start").val());
    if($("#flt_end").val())   params.set("end_date",   $("#flt_end").val());
    if($("#flt_order").val()) params.set("order_id",   $("#flt_order").val().trim());

    try{
      const r = await fetch(`/taxes-history/data?${params.toString()}`);
      const j = await r.json();
      if(j.status !== "success") throw new Error(j.message || "Failed");

      const rows = j.rows || [];
      if(!rows.length){
        $("#hist_tbody").html(`<tr><td colspan="8" class="text-muted">No payments found.</td></tr>`);
      } else {
        $("#hist_tbody").empty();
        rows.forEach(x=>{
          $("#hist_tbody").append(`
            <tr>
              <td>${x.date}</td>
              <td>${x.party || "—"}</td>
              <td>${x.order_id || "—"}</td>
              <td class="text-end mono">${fmt(x.amount)}</td>
              <td class="text-end mono">${fmt(x.per_litre)} <span class="text-muted">(${x.per_litre_label})</span></td>
              <td>${x.reference || "—"}</td>
              <td>${x.paid_by || "—"}</td>
              <td>${x.bank || "—"}</td>
            </tr>
          `);
        });
      }
      $("#hist_total").text(fmt(j.total));
    }catch(e){
      $("#hist_tbody").html(`<tr><td colspan="8" class="text-danger">Error: ${e.message}</td></tr>`);
      $("#hist_msg").addClass("text-danger").text(`Error: ${e.message}`);
    }
  }

  $("#flt_kind").on("change", togglePartyControls);
  $("#btn_filter").on("click", runFilter);

  // init
  togglePartyControls();
})();
</script>
</body>
</html>
