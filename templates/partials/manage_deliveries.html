<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Deliveries</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --info:#3b82f6;
      --bg:#f6f8fb; --card:#ffffff;
    }
    body{background:var(--bg); color:var(--ink);}
    .page-head{display:flex; gap:1rem; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .kpi{border:1px solid var(--line); background:linear-gradient(180deg,#fff, #fafafa); border-radius:14px}
    .kpi .big{font-variant-numeric: tabular-nums; font-size:2rem}

    .toolbar{border:1px solid var(--line); background:#fff; border-radius:12px; padding:.75rem}
    .toolbar .form-select,.toolbar .form-control{border-radius:10px}

    .table-wrap{border:1px solid var(--line); border-radius:12px; background:#fff; overflow:hidden}
    .table-responsive{margin:0;} /* keep borders tidy */
    table thead th{position:sticky; top:0; background:#0b1220; color:#fff; z-index:2}
    .table td, .table th{vertical-align:middle}

    .badge-k{font-weight:600; letter-spacing:.02em}
    .status-badge{font-weight:600}
    .status-good{background:#dcfce7; color:#166534}
    .status-mid{background:#fef9c3; color:#854d0e}
    .status-none{background:#e2e8f0; color:#334155}

    .search-icon{position:absolute; left:.75rem; top:50%; transform:translateY(-50%); opacity:.6}
    .search-input{padding-left:2rem}

    /* Action column sizing */
    th.actions { white-space: nowrap; }
    .actions { min-width: 320px; }

    /* Sticky Action column DESKTOP ONLY */
    .sticky-actions { position: static; right: auto; background: transparent; box-shadow: none; }
    @media (min-width: 1200px){
      .sticky-actions{
        position: sticky;
        right: 0;
        background: #fff;
        box-shadow: -6px 0 8px rgba(0,0,0,.03);
      }
    }

    /* Tablet & Phone behavior: stack controls, no sticky, fluid width */
    @media (max-width: 1199.98px){
      .actions{ min-width: unset; width: auto; }
      .update-status-form{
        flex-direction: column !important;
        align-items: stretch !important;
      }
      .update-status-form .d-flex{ flex-wrap: wrap; }
      .update-status-form select,
      .update-status-form input,
      .update-status-form button{
        width: 100%;
      }
      .view-history-btn{ width:100%; }
    }

    /* Very small screens: unstick head to avoid header/body sticky conflicts */
    @media (max-width: 575.98px){
      table thead th{ position: static; }
    }

    /* Optional: slightly slimmer action column on large laptops */
    @media (min-width: 1200px) and (max-width: 1400px){
      .actions{ min-width: 280px; }
    }
  </style>
</head>
<body>

<div class="container py-4">

  <!-- Page header -->
  <div class="page-head mb-3">
    <div>
      <h3 class="fw-bold mb-1">ðŸšš Manage Deliveries</h3>
      <div class="text-muted small">Track TTS/NPA status, drivers, depots, and destinations</div>
    </div>
    <a href="/deliveries/share/new" class="btn btn-dark">
      Share Page
    </a>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-sm-6">
      <div class="kpi p-3 h-100 text-center">
        <div class="text-muted">Not Delivered</div>
        <div class="big fw-bold text-warning">{{ summary.pending }}</div>
      </div>
    </div>
    <div class="col-sm-6">
      <div class="kpi p-3 h-100 text-center">
        <div class="text-muted">Delivered</div>
        <div class="big fw-bold text-success">{{ summary.delivered }}</div>
      </div>
    </div>
  </div>

  <!-- Toolbar (filters + keyword + per-page) -->
  <form class="toolbar mb-3" method="get" action="/deliveries" id="filterForm">
    <div class="row g-2 align-items-center">
      <div class="col-lg-2 col-6">
        <label class="visually-hidden" for="fRegion">Region</label>
        <select id="fRegion" class="form-select" name="region" onchange="this.form.submit()">
          <option value="">All Regions</option>
          {% for r in regions %}
          <option value="{{ r }}" {% if request.args.get('region') == r %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-2 col-6">
        <label class="visually-hidden" for="fBdc">BDC</label>
        <select id="fBdc" class="form-select" name="bdc" onchange="this.form.submit()">
          <option value="">All BDCs</option>
          {% for b in bdcs %}
          <option value="{{ b }}" {% if request.args.get('bdc') == b %}selected{% endif %}>{{ b }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-2 col-6">
        <label class="visually-hidden" for="fTts">TTS</label>
        <select id="fTts" class="form-select" name="tts" onchange="this.form.submit()">
          <option value="">All TTS Status</option>
          {% for s in status_options %}<option value="{{ s }}" {% if request.args.get('tts') == s %}selected{% endif %}>{{ s }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-lg-2 col-6">
        <label class="visually-hidden" for="fNpa">NPA</label>
        <select id="fNpa" class="form-select" name="npa" onchange="this.form.submit()">
          <option value="">All NPA Status</option>
          {% for s in status_options %}<option value="{{ s }}" {% if request.args.get('npa') == s %}selected{% endif %}>{{ s }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-lg-2 col-6">
        <label class="visually-hidden" for="fPerPage">Per Page</label>
        <select id="fPerPage" class="form-select" name="per_page" onchange="this.form.submit()">
          {% set curpp = pagination.per_page or 20 %}
          {% for opt in [20,50,100,150,200] %}
            <option value="{{ opt }}" {% if curpp == opt %}selected{% endif %}>Show {{ opt }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="page" value="1">
      </div>
      <div class="col-lg-2">
        <div class="position-relative">
          <label class="visually-hidden" for="keyword">Search</label>
          <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 14 15.5l.27.28v.79L20 21l1-1zm-6 0A4.5 4.5 0 1 1 14 9.5A4.5 4.5 0 0 1 9.5 14"/></svg>
          <input type="text" id="keyword" class="form-control search-input" placeholder="Quick filter (client, product, driver, depot, region)â€¦" autocomplete="off">
        </div>
      </div>
    </div>
  </form>

  <!-- Table -->
  <div class="table-wrap">
    <div class="table-responsive">
      <table class="table table-hover table-striped align-middle mb-0" id="deliveriesTable">
        <thead class="text-center">
          <tr>
            <th>BDC</th>
            <th>Client</th>
            <th>Product</th>
            <th>Vehicle #</th>
            <th>Driver</th>
            <th>Depot</th>
            <th>Phone</th>
            <th>Qty</th>
            <th>Destination</th>
            <th>Order Date</th>
            <th>TTS Status</th>
            <th>NPA Status</th>
            <th class="actions sticky-actions">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for d in deliveries %}
          <tr class="data-row">
            <td>{{ d.bdc_name }}</td>
            <td>{{ d.client_name }}</td>
            <td>{{ d.product }}</td>
            <td><span class="badge bg-light text-dark badge-k">{{ d.vehicle_number }}</span></td>
            <td>{{ d.driver_name }}</td>
            <td>{{ d.depot or d.depot_name or 'â€”' }}</td>
            <td>
              {% if d.driver_phone %}
                <a class="text-decoration-none" href="tel:{{ d.driver_phone }}">{{ d.driver_phone }}</a>
              {% else %}â€”{% endif %}
            </td>
            <td>{{ d.quantity }}</td>
            <td>{{ d.region }}</td>
            <td>{{ d.date.strftime('%Y-%m-%d') if d.date }}</td>

            <td class="text-center">
              {% set tts = (d.tts_status or 'â€”') %}
              <span class="badge status-badge {% if tts|lower in ['released','loaded','approved','goodstanding'] %}status-good{% elif tts=='â€”' %}status-none{% else %}status-mid{% endif %}">
                {{ tts }}
              </span>
            </td>
            <td class="text-center">
              {% set npa = (d.npa_status or 'â€”') %}
              <span class="badge status-badge {% if npa|lower in ['released','loaded','approved','goodstanding'] %}status-good{% elif npa=='â€”' %}status-none{% else %}status-mid{% endif %}">
                {{ npa }}
              </span>
            </td>

            <td class="sticky-actions bg-white">
              <form class="update-status-form d-flex flex-column flex-lg-row gap-1 align-items-stretch" data-id="{{ d.order_id }}">
                <div class="d-flex gap-1">
                  <select name="tts_select" class="form-select form-select-sm status-select-tts" aria-label="Set TTS status">
                    <option value="">TTS Statusâ€¦</option>
                    {% for s in status_options %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                    <option value="custom">Otherâ€¦</option>
                  </select>
                  <input type="text" name="tts_custom" class="form-control form-control-sm d-none tts-custom" placeholder="Custom TTS" aria-label="Custom TTS">
                </div>
                <div class="d-flex gap-1">
                  <select name="npa_select" class="form-select form-select-sm status-select-npa" aria-label="Set NPA status">
                    <option value="">NPA Statusâ€¦</option>
                    {% for s in status_options %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
                    <option value="custom">Otherâ€¦</option>
                  </select>
                  <input type="text" name="npa_custom" class="form-control form-control-sm d-none npa-custom" placeholder="Custom NPA" aria-label="Custom NPA">
                </div>

                <button type="submit" class="btn btn-sm btn-primary">Update</button>
              </form>

              <div class="d-grid mt-1">
                <button class="btn btn-sm btn-outline-secondary view-history-btn" data-id="{{ d.order_id }}">
                  ðŸ“œ History
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination bar -->
  <div class="d-flex align-items-center justify-content-between mt-3 flex-wrap gap-2">
    <div class="text-muted small">
      Showing {{ pagination.first_item }}â€“{{ pagination.last_item }} of {{ pagination.total }}
      â€¢ Page {{ pagination.page }} / {{ pagination.pages }}
    </div>

    <nav aria-label="Pagination">
      <ul class="pagination mb-0">
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ pagination.first_url if pagination.has_prev else '#' }}">&laquo; First</a>
        </li>
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ pagination.prev_url if pagination.has_prev else '#' }}">&lsaquo; Prev</a>
        </li>

        {% for p in pagination.page_numbers %}
          <li class="page-item {% if p == pagination.page %}active{% endif %}">
            <a class="page-link" href="{{ pagination.page_url(p) }}">{{ p }}</a>
          </li>
        {% endfor %}

        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ pagination.next_url if pagination.has_next else '#' }}">Next &rsaquo;</a>
        </li>
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ pagination.last_url if pagination.has_next else '#' }}">Last &raquo;</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Delivery History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historyModalLabel">ðŸ“œ Delivery History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group" id="historyList">
          <li class="list-group-item text-muted">Loading...</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ---------- Quick keyword filter (client-side) ----------
  const $kw = $('#keyword');
  $kw.on('input', function(){
    const term = (this.value || '').trim().toLowerCase();
    $('#deliveriesTable tbody tr.data-row').each(function(){
      const txt = $(this).text().toLowerCase();
      $(this).toggle(!term || txt.indexOf(term) !== -1);
    });
  });

  // TTS custom toggle
  $(document).on('change', '.status-select-tts', function () {
    const form = $(this).closest('form');
    const input = form.find('.tts-custom');
    if ($(this).val() === 'custom') {
      input.removeClass('d-none').attr('required', true);
    } else {
      input.addClass('d-none').val('').removeAttr('required');
    }
  });

  // NPA custom toggle
  $(document).on('change', '.status-select-npa', function () {
    const form = $(this).closest('form');
    const input = form.find('.npa-custom');
    if ($(this).val() === 'custom') {
      input.removeClass('d-none').attr('required', true);
    } else {
      input.addClass('d-none').val('').removeAttr('required');
    }
  });

  // Submit update
  $(document).on('submit', '.update-status-form', function (e) {
    e.preventDefault();
    const form = $(this);
    const orderId = form.data('id');

    const ttsSel = form.find('select[name="tts_select"]').val();
    const ttsCustom = form.find('input[name="tts_custom"]').val().trim();
    const tts = (ttsSel === 'custom') ? ttsCustom : ttsSel;

    const npaSel = form.find('select[name="npa_select"]').val();
    const npaCustom = form.find('input[name="npa_custom"]').val().trim();
    const npa = (npaSel === 'custom') ? npaCustom : npaSel;

    if (!tts && !npa) return alert("Select or enter a TTS and/or NPA status.");

    $.post(`/deliveries/update_status/${orderId}`, { tts_status: tts, npa_status: npa }, function (response) {
      if (response.success) location.reload();
      else alert(response.message || 'Failed to update status.');
    });
  });

  // View history
  $(document).on('click', '.view-history-btn', function () {
    const orderId = $(this).data('id');
    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
    $('#historyList').html('<li class="list-group-item text-muted">Loading...</li>');

    $.get(`/deliveries/history/${orderId}`, function (response) {
      if (response.success && response.history.length > 0) {
        const list = response.history.map(h =>
          `<li class="list-group-item d-flex justify-content-between">
            <div>
              <div><strong>TTS:</strong> ${h.tts_status || 'â€”'}</div>
              <div><strong>NPA:</strong> ${h.npa_status || 'â€”'}</div>
              ${h.depot ? `<div><strong>Depot:</strong> ${h.depot}</div>` : ``}
              ${h.driver_name ? `<div><strong>Driver:</strong> ${h.driver_name}</div>` : ``}
            </div>
            <small class="text-muted">${h.timestamp}</small>
          </li>`
        ).join('');
        $('#historyList').html(list);
      } else {
        $('#historyList').html('<li class="list-group-item text-danger">No history found.</li>');
      }
      modal.show();
    });
  });
</script>

</body>
</html>
