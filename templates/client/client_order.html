<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit Order | Oil ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" />

  <style>
    body {
      background: linear-gradient(to bottom right, #f4f6f9, #e9ecef);
      font-family: "Segoe UI", sans-serif;
    }
    .navbar-brand img { height: 40px; }
    .form-container {
      max-width: 900px; margin: 60px auto; background: #ffffff;
      padding: 40px 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.05);
    }
    .form-title { font-weight: 700; margin-bottom: 30px; color: #0d6efd; text-align: center; }
    label.form-label { font-weight: 500; }
    .btn-primary { background-color: #0d6efd; border: none; font-weight: 600; }
    .btn-primary:hover { background-color: #0b5ed7; }
    .back-link { display: inline-flex; align-items: center; margin-bottom: 20px; color: #0d6efd; text-decoration: none; }
    .back-link i { margin-right: 6px; }
    .alert { font-size: .95rem; }

    /* Autocomplete dropdown */
    .ac-wrap { position: relative; }
    .ac-list {
      position: absolute;
      inset: auto 0 0 0;
      transform: translateY(100%);
      z-index: 1050;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 .5rem .5rem;
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      max-height: 280px;
      overflow: auto;
      display: none;
    }
    .ac-item {
      padding: .55rem .75rem;
      cursor: pointer;
      display: flex;
      gap: .5rem;
      align-items: start;
    }
    .ac-item:hover, .ac-item.active {
      background: #f1f5ff;
    }
    .ac-title { font-weight: 600; }
    .ac-meta { font-size: .85rem; color: #6b7280; }
    .ac-empty, .ac-loading { padding: .65rem .75rem; color: #6b7280; }
    .form-control.is-loading {
      background-image: linear-gradient(90deg, #f2f4f8 0px, #eef2f7 40px, #f2f4f8 80px);
      background-size: 200% 100%;
      animation: pulse 1.2s infinite linear;
    }
    @keyframes pulse { to { background-position: -200% 0; } }

    @media (max-width: 575.98px){
      .ac-list { max-height: 60vh; }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm px-3">
  <a class="navbar-brand d-flex align-items-center" href="#">
    <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Logo">
    <span class="ms-2 fw-bold text-primary">Oil ERP</span>
  </a>
</nav>

<!-- Main Content -->
<div class="container">
  <div class="form-container">
    <a href="/client/dashboard" class="back-link"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
    <h3 class="form-title">Submit New Order</h3>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" autocomplete="off">
      <div class="row g-3">

        <!-- Product (names only; no prices shown) -->
        <div class="col-md-6">
          <label class="form-label">Product</label>
          <select class="form-select" name="product" id="productSelect" required>
            <option value="">Select Product</option>
            {% for product in products %}
              <option value="{{ product.name }}">
                {{ product.name }}{% if product.description %} - {{ product.description }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Order Type -->
        <div class="col-md-6">
          <label class="form-label">Order Type</label>
          <select class="form-select" name="order_type" id="order_type" required>
            <option value="">Select Order Type</option>
            <option value="s_tax">Tax</option>
            <option value="s_bdc">BDC</option>
            <option value="combo">Combo</option>
          </select>
          <small class="text-muted">Choose how this order should be processed.</small>
        </div>

        <!-- Quantity -->
        <div class="col-md-6">
          <label class="form-label">Quantity</label>
          <select class="form-select" name="quantity" id="quantity" required>
            <option value="">Select Quantity</option>
            <option value="54000">7,500</option>
            <option value="13500">13,500</option>
            <option value="18000">18,000</option>
            <option value="27000">27,000</option>
            <option value="36000">36,000</option>
            <option value="40500">40,500</option>
            <option value="45000">45,000</option>
            <option value="54000">54,000</option>
          </select>
        </div>

        <!-- Hire Truck (admin pool, optional) -->
        <div class="col-md-12">
          <label class="form-label">Hire Truck (Optional)</label>
          <select class="form-select" id="truck_selector">
            <option value="">-- Select Available Truck (Optional) --</option>
            {% for truck in trucks %}
              <option
                value="{{ truck.truck_number }}"
                data-driver="{{ truck.driver_name }}"
                data-phone="{{ truck.driver_phone }}"
                data-capacity="{{ truck.capacity }}"
              >
                {{ truck.truck_number }} - {{ truck.driver_name }} ({{ truck.capacity }}L)
              </option>
            {% endfor %}
          </select>
          <small class="text-muted">You may also enter truck details manually below.</small>
        </div>

        <!-- Recent Trucks (per client) -->
        <div class="col-md-12">
          <label class="form-label">Recent Trucks</label>
          <select id="recent_trucks" class="form-select">
            <option value="">-- Select from your recent trucks --</option>
            {% for t in recent_trucks %}
              <option
                value="{{ t.vehicle_number }}"
                data-destination="{{ t.destination or '' }}"
                data-driver="{{ t.driver_name or '' }}"
                data-phone="{{ t.driver_phone or '' }}"
              >
                {{ t.vehicle_number }}{% if t.driver_name %} — {{ t.driver_name }}{% endif %}{% if t.destination %} ({{ t.destination }}){% endif %}
              </option>
            {% endfor %}
          </select>
          <small class="text-muted">Pick a saved truck to auto-fill details.</small>
        </div>

        <!-- Vehicle Number + Autocomplete (still supported) -->
        <div class="col-md-6">
          <label class="form-label">Vehicle Number</label>
          <div class="ac-wrap">
            <input type="text" class="form-control" name="vehicle_number" id="vehicle_number"
                   placeholder="Enter or select above" required
                   aria-autocomplete="list" aria-expanded="false" aria-haspopup="listbox" aria-owns="ac-list">
            <div id="ac-list" class="ac-list" role="listbox" aria-label="Vehicle suggestions"></div>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Destination</label>
          <input type="text" class="form-control" name="region" id="region" placeholder="e.g. Western Region" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Driver's Name</label>
          <input type="text" class="form-control" name="driver_name" id="driver_name" placeholder="Enter or auto-filled from truck" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Driver's Phone</label>
          <input type="tel" class="form-control" name="driver_phone" id="driver_phone" placeholder="Enter or auto-filled from truck" required>
        </div>

        <div class="d-grid mt-4">
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-circle me-1"></i>Submit Order
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // ---------- Truck -> autofill fields + quantity ----------
  const truckSel = document.getElementById('truck_selector');
  const vehicleEl = document.getElementById('vehicle_number');
  const driverEl  = document.getElementById('driver_name');
  const phoneEl   = document.getElementById('driver_phone');
  const qtySel    = document.getElementById('quantity');
  const regionEl  = document.getElementById('region');
  const recentSel = document.getElementById('recent_trucks');

  function parseCapacity(raw){
    if (!raw) return null;
    const num = String(raw).replace(/[^\d]/g, '');
    const n = parseInt(num, 10);
    return Number.isFinite(n) && n > 0 ? n : null;
  }

  function selectQuantityByCapacity(cap){
    if (!cap) return;
    const capStr = String(cap);
    const prior = qtySel.querySelector('option[data-dyn="1"]');
    if (prior) prior.remove();
    const has = Array.from(qtySel.options).some(o => o.value === capStr);
    if (has){ qtySel.value = capStr; return; }
    const label = cap.toLocaleString() + ' (from truck)';
    const opt = new Option(label, capStr, true, true);
    opt.setAttribute('data-dyn', '1');
    qtySel.add(opt);
  }

  truckSel.addEventListener('change', function(){
    const opt = this.options[this.selectedIndex];
    if (!opt || !opt.value){
      vehicleEl.value = '';
      driverEl.value  = '';
      phoneEl.value   = '';
      qtySel.value    = '';
      const prior = qtySel.querySelector('option[data-dyn="1"]');
      if (prior) prior.remove();
      return;
    }
    vehicleEl.value = opt.value || '';
    driverEl.value  = opt.getAttribute('data-driver') || '';
    phoneEl.value   = opt.getAttribute('data-phone')  || '';
    const cap = parseCapacity(opt.getAttribute('data-capacity'));
    selectQuantityByCapacity(cap);
  });

  // ---------- Recent Trucks -> autofill ----------
  recentSel?.addEventListener('change', () => {
    const opt = recentSel.options[recentSel.selectedIndex];
    if (!opt || !opt.value) return;
    vehicleEl.value = opt.value || vehicleEl.value;
    regionEl.value  = opt.getAttribute('data-destination') || regionEl.value;
    driverEl.value  = opt.getAttribute('data-driver') || driverEl.value;
    phoneEl.value   = opt.getAttribute('data-phone') || phoneEl.value;
    // Optional focus progression
    document.getElementById('quantity')?.focus();
  });

  // ---------- Vehicle Number Autocomplete (truck_numbers) ----------
  const acList = document.getElementById('ac-list');
  let acItems = [];
  let acIndex = -1; // keyboard highlight
  let acAbort = null;
  let debounceTimer = null;

  function showList(){
    if (acList.children.length > 0){
      acList.style.display = 'block';
      vehicleEl.setAttribute('aria-expanded', 'true');
    }
  }
  function hideList(){
    acList.style.display = 'none';
    vehicleEl.setAttribute('aria-expanded', 'false');
    acIndex = -1;
  }

  function setLoading(state){
    vehicleEl.classList.toggle('is-loading', !!state);
  }

  function renderItems(items){
    acList.innerHTML = '';
    acItems = [];
    if (!items || items.length === 0){
      const div = document.createElement('div');
      div.className = 'ac-empty';
      div.textContent = 'No matches';
      acList.appendChild(div);
      return;
    }
    items.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'ac-item';
      row.setAttribute('role', 'option');
      row.dataset.index = idx;

      const icon = document.createElement('i');
      icon.className = 'bi bi-truck';
      icon.style.marginTop = '2px';

      const textWrap = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'ac-title';
      title.textContent = it.vehicle_number || '';

      const meta = document.createElement('div');
      meta.className = 'ac-meta';
      const dest = it.destination ? ` • ${it.destination}` : '';
      const dname = it.driver_name ? ` • ${it.driver_name}` : '';
      const dphone = it.driver_phone ? ` • ${it.driver_phone}` : '';
      meta.textContent = `${dest}${dname}${dphone}`.replace(/^ • /,'');

      textWrap.appendChild(title);
      textWrap.appendChild(meta);

      row.appendChild(icon);
      row.appendChild(textWrap);
      row.addEventListener('mousedown', (e) => {
        e.preventDefault(); // avoid blur hiding list too early
        chooseItem(idx);
      });

      acList.appendChild(row);
      acItems.push(it);
    });
  }

  function chooseItem(idx){
    const it = acItems[idx];
    if (!it) return;
    vehicleEl.value = it.vehicle_number || '';
    regionEl.value  = it.destination || regionEl.value;
    driverEl.value  = it.driver_name || driverEl.value;
    phoneEl.value   = it.driver_phone || phoneEl.value;
    hideList();
    vehicleEl.focus();
  }

  function highlight(idx){
    const rows = acList.querySelectorAll('.ac-item');
    rows.forEach(r => r.classList.remove('active'));
    if (idx >= 0 && rows[idx]){
      rows[idx].classList.add('active');
      rows[idx].scrollIntoView({ block: 'nearest' });
    }
  }

  function debounce(fn, wait){
    return (...args) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => fn(...args), wait);
    }
  }

  async function fetchSuggest(q){
    if (acAbort){ acAbort.abort(); }
    acAbort = new AbortController();
    const { signal } = acAbort;

    try{
      setLoading(true);
      const res = await fetch(`/client/truck_suggest?q=${encodeURIComponent(q)}`, { signal });
      if (!res.ok) throw new Error('Network');
      const data = await res.json();
      return (data && data.success && Array.isArray(data.items)) ? data.items : [];
    }catch(e){
      return [];
    }finally{
      setLoading(false);
    }
  }

  async function doSuggest(q){
    if (!q || q.trim().length < 2){
      hideList();
      return;
    }
    const items = await fetchSuggest(q.trim());
    renderItems(items);
    showList();
  }

  const debouncedSuggest = debounce(doSuggest, 200);

  vehicleEl.addEventListener('input', (e) => {
    const v = e.target.value;
    if (!v){ hideList(); return; }
    debouncedSuggest(v);
  });

  vehicleEl.addEventListener('focus', () => {
    const v = vehicleEl.value.trim();
    if (v.length >= 2 && acList.children.length > 0){
      showList();
    }
  });

  vehicleEl.addEventListener('blur', async () => {
    setTimeout(hideList, 100);
    // On blur, attempt a direct lookup to auto-fill if exact plate exists
    const plate = vehicleEl.value.trim();
    if (!plate) return;

    try{
      const res = await fetch(`/client/truck_lookup?vehicle_number=${encodeURIComponent(plate)}`);
      if (res.ok){
        const data = await res.json();
        if (data && data.success && data.data){
          const it = data.data;
          regionEl.value = it.destination || regionEl.value;
          driverEl.value = it.driver_name || driverEl.value;
          phoneEl.value  = it.driver_phone || phoneEl.value;
        }
      }
    }catch(_){}
  });

  vehicleEl.addEventListener('keydown', (e) => {
    const visible = acList.style.display === 'block';
    if (!visible) return;

    const rows = acList.querySelectorAll('.ac-item');
    const max = rows.length - 1;
    if (e.key === 'ArrowDown'){
      e.preventDefault();
      acIndex = Math.min(max, acIndex + 1);
      highlight(acIndex);
    } else if (e.key === 'ArrowUp'){
      e.preventDefault();
      acIndex = Math.max(0, acIndex - 1);
      highlight(acIndex);
    } else if (e.key === 'Enter'){
      e.preventDefault();
      if (acIndex >= 0){ chooseItem(acIndex); }
    } else if (e.key === 'Escape'){
      e.preventDefault();
      hideList();
    }
  });

  // Optional: simple phone normalization (keeps digits and +)
  phoneEl.addEventListener('blur', () => {
    const raw = phoneEl.value || '';
    const cleaned = raw.replace(/[^\d+]/g, '');
    phoneEl.value = cleaned;
  });

  // No pricing logic/UI included intentionally
</script>

</body>
</html>

