<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Make Payment | Oil ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png" />

  <style>
    :root{
      --brand:#0d6efd;
      --ok:#16a34a;
      --ink:#0f172a;
    }
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .navbar-brand img { height: 40px; }
    .page-wrapper { animation: fadeInSlide .5s ease-in; }
    @keyframes fadeInSlide { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }
    .form-container { max-width: 760px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 14px; box-shadow: 0 4px 24px rgba(15,23,42,.08); }
    #preview_image { max-width: 160px; max-height: 160px; object-fit: cover; border-radius: 10px; border: 1px solid #e5e7eb; margin-top: 10px; display: block; }
    #upload-status { font-size: 0.9em; color: #086b2e; }
    .history-title { margin-top: 40px; font-weight: 600; }
    .badge-feedback { font-size: 0.85em; background-color: #e1f5fe; color: #0277bd; }
    .back-link { display: inline-flex; align-items: center; margin-bottom: 16px; color: var(--brand); text-decoration: none; font-weight: 600; }
    .back-link i { margin-right: 6px; }
    .hint { font-size: .875rem; color: #6c757d; }

    /* Submit spinner overlay */
    .submit-overlay{
      position: fixed; inset: 0; background: rgba(15,23,42,.35);
      display: none; align-items: center; justify-content: center; z-index: 1055;
      backdrop-filter: blur(2px);
    }
    .submit-overlay.show{ display:flex; }
    .submit-card{
      background:#fff; padding:22px 26px; border-radius:14px;
      box-shadow: 0 10px 45px rgba(0,0,0,.15);
      display:flex; align-items:center; gap:12px; min-width: 260px;
    }

    /* Confirmation modal animations */
    .celebrate-wrap{ position: relative; overflow: visible; }
    .big-check{
      width: 110px; height:110px; border-radius:50%;
      display:grid; place-items:center; margin:0 auto 10px auto;
      background: radial-gradient(ellipse at center, rgba(22,163,74,.25), rgba(22,163,74,.08));
      border: 2px solid rgba(22,163,74,.35);
      animation: popIn .6s ease-out forwards, glow 2.2s ease-in-out infinite;
    }
    .big-check i{ font-size: 64px; color: var(--ok); }
    @keyframes popIn{ 0%{transform: scale(.6); opacity:0} 60%{transform: scale(1.05); opacity:1} 100%{transform: scale(1)} }
    @keyframes glow{ 0%,100%{ box-shadow: 0 0 0 0 rgba(22,163,74,.35)} 50%{ box-shadow: 0 0 0 12px rgba(22,163,74,.0)} }

    /* Confetti */
    .confetti{
      position:absolute; inset: -20px; pointer-events:none; overflow:visible;
    }
    .confetti > i{
      position:absolute; width:10px; height:14px; border-radius:2px;
      animation: fall 1.6s ease-in forwards;
    }
    @keyframes fall{
      0%{ transform: translate(var(--x,0), -30px) rotate(0deg); opacity:1 }
      100%{ transform: translate(calc(var(--x,0) * 1.4), 260px) rotate(540deg); opacity:0 }
    }

    /* Responsive tweaks */
    @media (max-width: 576px){
      .form-container{ margin:20px auto; padding:18px; border-radius:12px; }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm px-3">
  <a class="navbar-brand d-flex align-items-center" href="#">
    <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Oil ERP Logo" />
    <span class="ms-2 fw-bold text-primary"></span>
  </a>
</nav>

<div class="container page-wrapper">
  <a href="/client/dashboard" class="back-link mt-3"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>

  <!-- Payment Form -->
  <div class="form-container">
    <h4 class="text-center mb-3"><i class="bi bi-credit-card-2-back"></i> Make a Payment</h4>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" id="paymentForm">
      <!-- Payment Type -->
      <div class="mb-3">
        <label for="payment_type" class="form-label">Payment Type</label>
        <select name="payment_type" id="payment_type" class="form-select" required>
          <option value="">Select payment type</option>
          <option value="order">Order Payment</option>
          <option value="truck">Truck Payment</option>
        </select>
      </div>

      <!-- Orders with outstanding debt (Order Payment only) -->
      <div class="mb-3 d-none" id="order_field">
        <label for="order_id" class="form-label">Select Order (with outstanding)</label>
        <select name="order_id" id="order_id" class="form-select">
          <option value="">-- Select an order --</option>
          {% for o in orders_with_debt %}
            <option value="{{ o._id }}" data-outstanding="{{ o.outstanding }}">
              {{ o.code }} — {{ o.product }} — {{ o.date.strftime('%Y-%m-%d') if o.date }}
              — Outstanding: GHS {{ "{:,.2f}".format(o.outstanding) }}
            </option>
          {% endfor %}
        </select>
        {% if not orders_with_debt %}
          <div class="hint mt-1">You currently have no orders with outstanding debt.</div>
        {% endif %}
      </div>

      <!-- Quick full payment helper -->
      <div class="mb-3 d-flex align-items-center gap-2 flex-wrap">
        <button type="button" id="fullPayBtn" class="btn btn-outline-dark btn-sm" title="Auto-fill total outstanding">
          <i class="bi bi-lightning-charge"></i> Full payment
        </button>
        <span class="hint">
          Total outstanding across your orders:
          <strong id="fullTotalText">GHS {{ "{:,.2f}".format(full_outstanding_total or 0) }}</strong>
        </span>
      </div>

      <!-- Amount -->
      <div class="mb-3">
        <label for="amount" class="form-label">Amount (GHS)</label>
        <input type="number" step="0.01" name="amount" id="amount" class="form-control" required>
        <div class="hint mt-1">Select an order to auto-fill its outstanding, or click <em>Full payment</em> to fill the total outstanding.</div>
      </div>

      <!-- Bank Select -->
      <div class="mb-3">
        <label for="bank_name" class="form-label">Bank Name</label>
        <select name="bank_name" id="bank_name" class="form-select" required>
          <option value="">Select a bank</option>
          {% for bank in bank_accounts %}
            <option value="{{ bank.bank_name }}" data-last4="{{ bank.account_number[-4:] }}">
              {{ bank.bank_name }} - {{ bank.account_name }} (****{{ bank.account_number[-4:] }})
            </option>
          {% endfor %}
        </select>
        <input type="hidden" name="account_last4" id="account_last4">
      </div>

      <!-- Proof Upload -->
      <div class="mb-3">
        <label for="image" class="form-label">Upload Payment Proof</label>
        <input type="file" id="image" accept="image/*" required class="form-control">
        <input type="hidden" name="proof_url" id="proof_url">
        <div id="upload-status" class="text-muted mt-2 d-flex align-items-center"></div>
        <img id="preview_image" src="" class="d-none mt-2">
      </div>

      <!-- Submit -->
      <div class="d-grid">
        <button type="submit" class="btn btn-success" id="submitBtn">
          <span class="btn-text"><i class="bi bi-upload"></i> Submit Payment</span>
          <span class="btn-spinner d-none">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Submitting…
          </span>
        </button>
      </div>
    </form>
  </div>

  <!-- Payment History -->
  {% if payments %}
  <div class="form-container mt-4">
    <h5 class="history-title"><i class="bi bi-clock-history"></i> Payment History</h5>
    <div class="table-responsive mt-3">
      <table class="table table-bordered table-hover table-sm align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>Type</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Bank</th>
            <th>Status</th>
            <th>Proof</th>
            <th>Feedback</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payments %}
          <tr>
            <td><span class="badge bg-secondary">{{ p.type }}</span></td>
            <td>{{ p.date }}</td>
            <td>GHS {{ "{:,.2f}".format(p.amount or 0) }}</td>
            <td>{{ p.bank_name }}</td>
            <td>
              {% if p.status == "confirmed" %}
                <span class="badge bg-success">Confirmed</span>
              {% else %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% endif %}
            </td>
            <td>
              {% if p.proof_url %}
                <a href="{{ p.proof_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-eye"></i> View
                </a>
              {% else %}
                <span class="text-muted">No File</span>
              {% endif %}
            </td>
            <td>
              {% if p.feedback %}
                <span class="badge badge-feedback">{{ p.feedback }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>

<!-- Submit overlay -->
<div class="submit-overlay" id="submitOverlay" aria-hidden="true">
  <div class="submit-card">
    <div class="spinner-border text-success" role="status" aria-live="polite" aria-label="Submitting"></div>
    <div class="ms-2">
      <div class="fw-semibold">Submitting payment…</div>
      <div class="text-muted small">Please wait</div>
    </div>
  </div>
</div>

<!-- Duplicate-warning Modal: “Send again?” -->
<div class="modal fade" id="dupWarnModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning-subtle">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Payment already submitted
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          You already submitted a payment for this order that is <strong>not confirmed</strong> yet.
        </p>
        <div class="border rounded p-2 mb-2">
          <div class="small text-muted mb-1">Last pending payment</div>
          <div><strong>Amount:</strong> <span id="dupLastAmount">—</span></div>
          <div><strong>Date:</strong> <span id="dupLastDate">—</span></div>
        </div>
        <p class="mb-0">Do you want to <strong>send another payment</strong> for this order now?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">No, cancel</button>
        <button type="button" class="btn btn-danger" id="dupConfirmBtn">
          <i class="bi bi-arrow-repeat me-1"></i> Send again
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Success Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">Payment Submitted</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-0">
        <div class="celebrate-wrap text-center position-relative">
          <div class="confetti" id="confettiHost" aria-hidden="true"></div>
          <div class="big-check">
            <i class="bi bi-check2-circle"></i>
          </div>
        </div>
        <p class="text-center mb-1">Thanks! Your payment has been received.</p>
        <div class="text-center text-muted small mb-3">We’ll notify you when it’s confirmed.</div>

        <div class="row g-2 text-center">
          <div class="col-6">
            <div class="border rounded p-2">
              <div class="text-muted small">Amount</div>
              <div class="fw-bold" id="modalAmount">—</div>
            </div>
          </div>
          <div class="col-6">
            <div class="border rounded p-2">
              <div class="text-muted small">Type</div>
              <div class="fw-bold" id="modalType">—</div>
            </div>
          </div>
          <div class="col-12 mt-2">
            <div class="border rounded p-2">
              <div class="text-muted small">Bank</div>
              <div class="fw-bold" id="modalBank">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0 d-flex justify-content-between">
        <a href="/client/dashboard" class="btn btn-outline-secondary w-50 me-2">
          <i class="bi bi-speedometer2 me-1"></i> Dashboard
        </a>
        <button type="button" class="btn btn-success w-50" data-bs-dismiss="modal">
          <i class="bi bi-check2 me-1"></i> Done
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Cloudinary Upload Script -->
<script>
  const imageInput = document.getElementById('image');
  const uploadStatus = document.getElementById('upload-status');
  const previewImage = document.getElementById('preview_image');
  const proofUrlInput = document.getElementById('proof_url');

  imageInput.addEventListener('change', async function (event) {
    const file = event.target.files[0];
    if (!file) return;

    uploadStatus.innerHTML = `Uploading... <div class="spinner-border text-success ms-2" role="status"><span class="visually-hidden">Loading...</span></div>`;
    previewImage.classList.add('d-none');

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'truetype');
    formData.append('folder', 'customer-images');

    try {
      const response = await fetch('https://api.cloudinary.com/v1_1/dl2ipzxyk/image/upload', { method: 'POST', body: formData });
      const data = await response.json();

      if (data.secure_url) {
        proofUrlInput.value = data.secure_url;
        previewImage.src = data.secure_url;
        previewImage.classList.remove('d-none');
        uploadStatus.innerHTML = '<i class="bi bi-check-circle-fill text-success me-2"></i> Upload successful.';
      } else {
        uploadStatus.innerHTML = '<i class="bi bi-x-circle-fill text-danger me-2"></i> Upload failed. Try again.';
      }
    } catch (error) {
      uploadStatus.innerHTML = '<i class="bi bi-x-circle-fill text-danger me-2"></i> Network error.';
      console.error(error);
    }
  });
</script>

<!-- Small helpers -->
<script>
  // Auto-fill last 4 digits
  document.getElementById('bank_name').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const last4 = selectedOption.getAttribute('data-last4') || '';
    document.getElementById('account_last4').value = last4;
  });
</script>

<!-- Form UX, duplicate check, spinner + confirmation modal -->
<script>
  // Toggle order/truck input
  const paymentType = document.getElementById('payment_type');
  const orderField  = document.getElementById('order_field');
  const orderSelect = document.getElementById('order_id');
  const truckField  = document.getElementById('truck_field'); // optional

  paymentType.addEventListener('change', () => {
    const selected = paymentType.value;
    if (selected === 'order') {
      orderField?.classList.remove('d-none');
      truckField?.classList.add('d-none');
    } else if (selected === 'truck') {
      truckField?.classList.remove('d-none');
      orderField?.classList.add('d-none');
    } else {
      truckField?.classList.add('d-none');
      orderField?.classList.add('d-none');
    }
  });

  // Outstanding helpers
  const amountInput   = document.getElementById('amount');
  const fullPayBtn    = document.getElementById('fullPayBtn');
  const fullTotalText = document.getElementById('fullTotalText');

  function parseNum(x) {
    const n = Number((x ?? '').toString().replace(/,/g, ''));
    return Number.isFinite(n) ? n : 0;
  }
  function getOrderOutstandingMap() {
    const map = {};
    if (!orderSelect) return map;
    [...orderSelect.options].forEach(opt => {
      if (!opt.value) return;
      map[opt.value] = parseNum(opt.getAttribute('data-outstanding'));
    });
    return map;
  }
  function getFullOutstanding() {
    if (!orderSelect) return 0;
    return [...orderSelect.options].reduce((sum, opt) => {
      if (!opt.value) return sum;
      return sum + parseNum(opt.getAttribute('data-outstanding'));
    }, 0);
  }
  function formatMoney(n) {
    return (Number(n) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  const orderMap       = getOrderOutstandingMap();
  let fullOutstanding  = getFullOutstanding();
  if (fullTotalText) fullTotalText.textContent = `GHS ${formatMoney(fullOutstanding)}`;

  if (orderSelect) {
    orderSelect.addEventListener('change', (e) => {
      const val = orderMap[e.target.value] || 0;
      amountInput.value = (val).toFixed(2);
    });
  }
  if (fullPayBtn) {
    fullPayBtn.addEventListener('click', () => {
      fullOutstanding = getFullOutstanding();
      amountInput.value = fullOutstanding.toFixed(2);
    });
  }

  // Submit UX
  const form = document.getElementById('paymentForm');
  const submitBtn = document.getElementById('submitBtn');
  const btnText = submitBtn.querySelector('.btn-text');
  const btnSpin = submitBtn.querySelector('.btn-spinner');
  const overlay = document.getElementById('submitOverlay');

  function setSubmitting(isOn){
    submitBtn.disabled = isOn;
    btnText.classList.toggle('d-none', isOn);
    btnSpin.classList.toggle('d-none', !isOn);
    overlay.classList.toggle('show', isOn);
  }

  function showToast(msg, type='danger'){
    const el = document.createElement('div');
    el.className = `alert alert-${type} mt-3`;
    el.textContent = msg;
    form.insertAdjacentElement('beforebegin', el);
    setTimeout(()=> el.remove(), 3500);
  }

  function fireConfetti(containerId){
    const host = document.getElementById(containerId);
    if(!host) return;
    host.innerHTML = '';
    const colors = ['#22c55e','#16a34a','#0ea5e9','#f59e0b','#ef4444','#a855f7','#0ea5e9'];
    const pieces = 80;
    for(let i=0;i<pieces;i++){
      const s = document.createElement('i');
      const left = Math.random()*100;  // %
      const x = (Math.random()*120 - 60) + 'px';
      const dur = 1100 + Math.random()*700;
      const delay = Math.random()*250;
      const color = colors[i % colors.length];
      s.style.left = `${left}%`;
      s.style.setProperty('--x', x);
      s.style.background = color;
      s.style.opacity = String(0.9 - Math.random()*0.5);
      s.style.animationDuration = dur+'ms';
      s.style.animationDelay = delay+'ms';
      host.appendChild(s);
    }
  }

  function openConfirmModal(amount, type, bank){
    document.getElementById('modalAmount').textContent = 'GHS ' + formatMoney(amount);
    document.getElementById('modalType').textContent   = type || '—';
    document.getElementById('modalBank').textContent   = bank || '—';

    const modal = new bootstrap.Modal(document.getElementById('confirmModal'), { backdrop:'static' });
    modal.show();

    setTimeout(()=> fireConfetti('confettiHost'), 120);
  }

  // Duplicate pre-check — calls backend if available
  async function checkPendingDuplicate(orderId){
    try{
      if(!orderId) return { has_pending:false };
      const r = await fetch(`/payment/check-pending?order_id=${encodeURIComponent(orderId)}`, {
        headers: { 'Accept':'application/json' }
      });
      if(!r.ok) return { has_pending:false, unknown:true };
      const d = await r.json();
      // expected shape: { has_pending: bool, last_amount: number, last_date: 'YYYY-MM-DD HH:mm:ss' }
      return d || { has_pending:false };
    }catch(e){
      return { has_pending:false, unknown:true };
    }
  }

  // Duplicate warning modal wiring
  const dupWarnModalEl = document.getElementById('dupWarnModal');
  const dupWarnModal = new bootstrap.Modal(dupWarnModalEl);
  const dupLastAmountEl = document.getElementById('dupLastAmount');
  const dupLastDateEl = document.getElementById('dupLastDate');
  const dupConfirmBtn = document.getElementById('dupConfirmBtn');

  let dupProceedResolver = null; // promise resolver for modal decision

  dupConfirmBtn.addEventListener('click', ()=>{
    dupWarnModal.hide();
    if(dupProceedResolver) dupProceedResolver(true);
  });
  dupWarnModalEl.addEventListener('hidden.bs.modal', ()=>{
    if(dupProceedResolver) dupProceedResolver(false);
  });

  function askSendAgain(last){
    dupLastAmountEl.textContent = last?.last_amount != null ? ('GHS ' + formatMoney(last.last_amount)) : '—';
    dupLastDateEl.textContent   = last?.last_date || '—';
    dupWarnModal.show();
    return new Promise((resolve)=> { dupProceedResolver = resolve; });
  }

  // Actual submit (AJAX-first, fallback to normal submit)
  async function doSubmit(fd){
    const action = form.getAttribute('action') || window.location.pathname;
    setSubmitting(true);
    try{
      const res = await fetch(action, { method:'POST', body: fd, headers: { 'Accept': 'application/json' } });
      const ct = res.headers.get('content-type') || '';
      if(res.ok && ct.includes('application/json')){
        const data = await res.json();
        if((data.status||'').toLowerCase()==='success' || res.status===200){
          const amount = fd.get('amount') || 0;
          const type   = fd.get('payment_type') || '';
          const bank   = fd.get('bank_name') || '';
          setSubmitting(false);
          openConfirmModal(amount, type, bank);
          form.reset();
          previewImage.classList.add('d-none');
          uploadStatus.textContent = '';
          proofUrlInput.value = '';
          return;
        } else if ((data.status||'').toLowerCase()==='warning' && data.reason==='duplicate_pending'){
          // optional: if backend returns explicit warning JSON
          setSubmitting(false);
          const go = await askSendAgain({ last_amount:data.last_amount, last_date:data.last_date });
          if(go){
            // append a hint for backend if you want (optional)
            fd.append('force_duplicate', '1');
            return doSubmit(fd);
          } else {
            return;
          }
        } else {
          throw new Error(data.message || 'Submission failed');
        }
      }
      // Fallback to full post if not JSON
      form.removeEventListener('submit', onSubmitHandler);
      form.submit();
    }catch(err){
      console.error(err);
      setSubmitting(false);
      showToast(err.message || 'Network error. Please try again.');
    }
  }

  // Main submit handler with duplicate pre-check
  async function onSubmitHandler(e){
    e.preventDefault();

    if(!proofUrlInput.value){
      showToast('Please upload your payment proof first.','warning');
      return;
    }

    const fd = new FormData(form);

    // Only pre-check duplicates for order payments
    const type = (fd.get('payment_type') || '').toLowerCase();
    const orderId = fd.get('order_id');

    if(type === 'order' && orderId){
      // Ask backend if there is a pending payment for this order
      const info = await checkPendingDuplicate(orderId);
      if(info.has_pending){
        // show confirm modal
        const go = await askSendAgain(info);
        if(!go) return; // user cancelled
      }
    }

    await doSubmit(fd);
  }

  form.addEventListener('submit', onSubmitHandler);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
