<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Approved Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
    .container-fluid { padding: 30px; }
    h2 { font-weight: 600; margin-bottom: 20px; }
    .table-responsive { margin-top: 20px; }
    th, td { vertical-align: middle; text-align: center; white-space: nowrap; }
    .dt-buttons .btn { margin-right: 8px; }
    #filtersRow .form-select { font-size: 0.875rem; }
    .header-bar { background: #0d6efd; color: white; padding: 10px 20px; border-radius: 6px; }
    .search-wrap { margin-top: 14px; }
    .modal .select2-container { width:100% !important; }
    .dimmed { opacity: .55; pointer-events: none; }
    @media (max-width: 576px){ .dt-buttons .btn { margin-bottom: 6px; } }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="header-bar d-flex align-items-center justify-content-between flex-wrap">
    <h2 class="mb-0"><i class="bi bi-check2-circle me-2"></i>Approved Orders</h2>
  </div>

  <!-- Quick Search -->
  <div class="row search-wrap">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="globalSearch" type="search" class="form-control"
               placeholder="Search by code, ID, client, vehicle, OMC, BDC, region, etc." value="{{ initial_q or '' }}">
        <button class="btn btn-outline-secondary" id="clearSearch" type="button">Clear</button>
      </div>
      <small class="text-muted">Tip: paste the 5-digit code (Order Code) or the Mongo ID to jump to a record.</small>
    </div>
  </div>

  <!-- Filters Row (per-column dropdowns) -->
  <div class="row mt-3 g-2" id="filtersRow"></div>

  <div class="table-responsive">
    <table id="approvedOrdersTable" class="table table-striped table-bordered w-100">
      <thead class="table-dark">
        <tr>
          <th>Order ID</th>
          <th><i class="bi bi-calendar3"></i><br>Date</th>
          <th><i class="bi bi-clock-history"></i><br>Approved At</th>
          <th><i class="bi bi-person-circle"></i><br>Client</th>
          <th><i class="bi bi-truck"></i><br>Vehicle #</th>
          <th><i class="bi bi-geo-alt"></i><br>Region</th>
          <th><i class="bi bi-fuel-pump"></i><br>Product</th>
          <th>Order Type</th>
          <th>OMC</th>
          <th>BDC</th>
          <th>DEPOT</th>
          <th>Qty</th>
          <th>P-BDC</th>
          <th>S-BDC</th>
          <th>P-Tax</th>
          <th>S-Tax</th>
          <th>S-Tax + S-BDC</th>
          <th><i class="bi bi-cash-coin"></i><br>Margin</th>
          <th>Returns</th>
          <th>Total Debt</th>
          <th>Paid</th>
          <th>Left</th>
          <th>Shareholder</th>
          <th>Delivery Status</th>
          <th class="no-export">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for order in orders %}
        {% set s_component_total = (order.s_tax or 0.0) + (order.s_bdc_omc or 0.0) %}
        {% set left_amt = (order.total_debt or 0.0) - (order.amount_paid or 0.0) %}
        {% set mode = (order.order_type or 'combo').replace('-','_') %}
        <tr>
          <td>{{ order.order_id or '-' }}</td>
          <td>{{ order.date.strftime('%d-%b-%Y') if order.date else '-' }}</td>
          <td>{% if order.approved_at %}{{ order.approved_at.strftime('%d-%b-%Y %H:%M') }} GMT{% else %}-{% endif %}</td>
          <td><a href="/admin/client/{{ order.client_mongo_id }}" class="text-decoration-none fw-semibold text-primary">{{ order.client_name }}</a></td>
          <td>{{ order.vehicle_number }}</td>
          <td>{{ order.region }}</td>
          <td>{{ order.product }}</td>
          <td>{{ (order.order_type or '-').upper() }}</td>
          <td>{{ order.omc or '-' }}</td>
          <td>{{ order.bdc_name or '-' }}</td>
          <td>{{ order.depot }}</td>
          <td>{{ "{:,}".format((order.quantity or 0)|int) }}</td>
          <td>{{ "{:,.2f}".format(order.p_bdc_omc or 0.0) }}</td>
          <td>{{ "{:,.2f}".format(order.s_bdc_omc or 0.0) }}</td>
          <td>{{ "{:,.2f}".format(order.p_tax or 0.0) }}</td>
          <td>{{ "{:,.2f}".format(order.s_tax or 0.0) }}</td>
          <td>{{ "{:,.2f}".format(s_component_total) }}</td>
          <td>{{ "{:,.2f}".format(order.margin or 0.0) }}</td>
          <td>{{ "{:,.2f}".format(order.returns or 0.0) }}</td>
          <td>{{ "{:,.2f}".format(order.total_debt or 0.0) }}</td>
          <td>{{ "{:,.2f}".format(order.amount_paid or 0.0) }}</td>
          <td>{{ "{:,.2f}".format(left_amt) }}</td>
          <td>
            {% if order.shareholder %}
              <span class="badge {% if order.shareholder == 'Neutral' %}bg-secondary{% else %}bg-primary{% endif %}">{{ order.shareholder }}</span>
            {% else %} — {% endif %}
          </td>
          <td>
            {% if order.delivery_status %}
              <span class="badge bg-{{ 'success' if order.delivery_status|lower == 'delivered' else 'warning' }}">{{ order.delivery_status }}</span>
            {% else %}
              <span class="badge bg-secondary">Pending</span>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal{{ order._id }}">
              <i class="bi bi-pencil-square me-1"></i> Edit
            </button>
          </td>
        </tr>

        <!-- Edit Modal -->
        <div class="modal fade" id="editModal{{ order._id }}" tabindex="-1" aria-labelledby="editModalLbl{{ order._id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editModalLbl{{ order._id }}">Edit Order – {{ order.order_id or order._id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <form class="edit-order-form" method="POST" action="/orders/update/{{ order._id }}" data-id="{{ order._id }}">
                <div class="modal-body">
                  <!-- Order type (read-only) -->
                  <div class="mb-3">
                    <label class="form-label">Order Type</label>
                    <div>
                      <span class="badge
                        {% if mode=='s_bdc' %} bg-primary
                        {% elif mode=='s_tax' %} bg-warning text-dark
                        {% else %} bg-success
                        {% endif %}">{{ (order.order_type or 'combo').upper() }}</span>
                    </div>
                    <input type="hidden" name="order_type" value="{{ mode }}">
                  </div>

                  <div class="row g-3">
                    <!-- Shareholder -->
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Shareholder</label>
                      <select name="shareholder" class="form-select">
                        <option value="">Select Shareholder</option>
                        <option value="Rex"    {% if order.shareholder == 'Rex' %}selected{% endif %}>Rex</option>
                        <option value="Simon"  {% if order.shareholder == 'Simon' %}selected{% endif %}>Simon</option>
                        <option value="Paul"   {% if order.shareholder == 'Paul' %}selected{% endif %}>Paul</option>
                        <option value="Neutral"{% if order.shareholder == 'Neutral' %}selected{% endif %}>Neutral</option>
                      </select>
                    </div>

                    <!-- OMC (Select2; string) -->
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">OMC</label>
                      <select name="omc" class="form-control omc-select">
                        <option value="">Select OMC</option>
                        {% for o in omcs %}
                          <option value="{{ o.name }}" data-rep-phone="{{ o.rep_phone or '' }}"
                                  {% if (order.omc or '') == (o.name or '') %}selected{% endif %}>
                            {{ o.name }}{% if o.rep_phone %} — {{ o.rep_phone }}{% endif %}
                          </option>
                        {% endfor %}
                      </select>
                    </div>

                    <!-- BDC (Select2; ObjectId value) -->
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">BDC</label>
                      <select name="bdc" class="form-control bdc-select">
                        <option value="">Select BDC</option>
                        {% for b in bdcs %}
                          <option value="{{ b._id }}" data-bdc-name="{{ b.name }}"
                                  data-rep-phone="{{ b.rep_phone or b.phone or '' }}"
                                  {% if (order.bdc_id|string) == (b._id|string) %}selected{% endif %}>
                            {{ b.name }}{% if b.rep_phone or b.phone %} — {{ b.rep_phone or b.phone }}{% endif %}
                          </option>
                        {% endfor %}
                      </select>
                    </div>

                    <!-- Depot -->
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">DEPOT</label>
                      <input type="text" name="depot" class="form-control" value="{{ order.depot or '' }}" required>
                    </div>

                    <!-- P/S Prices -->
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">P-BDC</label>
                      <input type="number" step="0.01" name="p_bdc_omc" class="form-control" value="{{ order.p_bdc_omc or '' }}">
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">S-BDC</label>
                      <input type="number" step="0.01" name="s_bdc_omc" class="form-control" value="{{ order.s_bdc_omc or '' }}">
                    </div>

                    <!-- Taxes -->
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">P-Tax</label>
                      <input type="number" step="0.01" name="p_tax" class="form-control" value="{{ order.p_tax or '' }}">
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">S-Tax</label>
                      <input type="number" step="0.01" name="s_tax" class="form-control" value="{{ order.s_tax or '' }}">
                    </div>

                    <!-- Optional payment hints (applies to S-BDC/combo server-side) -->
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Payment Type (BDC)</label>
                      <select class="form-select" name="payment_type">
                        <option value="">Select Payment Type</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit">Credit</option>
                        <option value="From Account">From Account</option>
                      </select>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Payment Amount (optional)</label>
                      <input type="number" step="0.01" name="payment_amount" class="form-control" placeholder="Auto: qty × P-BDC">
                    </div>

                    <!-- Due Date -->
                    <div class="col-12 col-sm-6 col-lg-4">
                      <label class="form-label">Due Date</label>
                      <input type="date" name="due_date" class="form-control"
                             value="{{ order.due_date.strftime('%Y-%m-%d') if order.due_date else '' }}">
                      <div class="form-text text-muted">Only today or future dates are allowed.</div>
                    </div>
                  </div>
                </div>

                <div class="modal-footer">
                  <div class="me-auto small text-muted">Quantity: {{ order.quantity or 0 }} L • Product: {{ order.product or '-' }}</div>
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
  // DataTable
  $(function () {
    const table = $('#approvedOrdersTable').DataTable({
      responsive: false,
      scrollX: true,
      ordering: true,
      pageLength: 50,
      order: [[2, 'desc']], // Approved At
      dom: 'Bfrtip',
      buttons: [
        { extend: 'excelHtml5', className: 'btn btn-success btn-sm', title: 'Approved Orders',
          exportOptions: { modifier: { page: 'all', search: 'applied' }, columns: ':visible:not(.no-export)' } },
        { extend: 'csvHtml5',   className: 'btn btn-info btn-sm',    title: 'Approved Orders',
          exportOptions: { modifier: { page: 'all', search: 'applied' }, columns: ':visible:not(.no-export)' } },
        { extend: 'pdfHtml5',   className: 'btn btn-danger btn-sm',  title: 'Approved Orders',
          orientation: 'landscape', pageSize: 'A3',
          exportOptions: {
            modifier: { page: 'all', search: 'applied' },
            columns: ':visible:not(.no-export)',
            stripHtml: true,
            format: { body: function (data) {
              const tmp = document.createElement('div');
              tmp.innerHTML = data;
              return (tmp.textContent || tmp.innerText || '').replace(/\s+/g, ' ').trim();
            }}
          },
          customize: function (doc) {
            doc.content[1].margin = [10, 10, 10, 10];
            doc.styles.tableHeader.alignment = 'center';
            doc.defaultStyle.fontSize = 9;
            doc.styles.tableHeader.fontSize = 10;
            const stamp = new Date().toLocaleString();
            doc.footer = function(currentPage, pageCount) {
              return {
                columns: [
                  { text: 'Generated: ' + stamp, alignment: 'left', margin: [10, 0, 10, 0] },
                  { text: currentPage.toString() + ' / ' + pageCount, alignment: 'right', margin: [10, 0, 10, 0] }
                ]
              };
            };
            const body = doc.content[1].table.body;
            doc.content[1].table.widths = Array(body[0].length).fill('auto');
          }
        },
        { extend: 'print', className: 'btn btn-secondary btn-sm', title: 'Approved Orders',
          exportOptions: { modifier: { page: 'all', search: 'applied' }, columns: ':visible:not(.no-export)' } }
      ],
      columnDefs: [{
        targets: '_all',
        render: function (data, type) {
          const htmlToText = (val) => {
            const tmp = document.createElement('div');
            tmp.innerHTML = val == null ? '' : String(val);
            return (tmp.textContent || tmp.innerText || '').trim();
          };
          if (type === 'sort') {
            const text = htmlToText(data).replace(/,/g, '');
            const num = parseFloat(text);
            return isNaN(num) ? text : num;
          }
          if (type === 'filter') return htmlToText(data);
          return data;
        }
      }]
    });

    // Global search
    const $gs = $('#globalSearch');
    const initialQ = ($gs.val() || '').trim();
    if (initialQ) table.search(initialQ).draw();
    $gs.on('keyup change', function () { table.search(this.value).draw(); });
    $('#clearSearch').on('click', function () { $gs.val(''); table.search('').draw(); });

    // Per-column filters
    $('#filtersRow').empty();
    table.columns().every(function () {
      const column = this;
      const header = $(column.header()).text().trim();
      const $wrap = $(`
        <div class="col-6 col-md-3 col-lg-2">
          <select class="form-select form-select-sm" title="${header}">
            <option value="">All ${header}</option>
          </select>
        </div>
      `).appendTo('#filtersRow');
      const $select = $wrap.find('select');

      $select.on('change', function () {
        const val = $.fn.dataTable.util.escapeRegex($(this).val());
        column.search(val ? '^' + val + '$' : '', true, false).draw();
      });

      column.data().unique().sort().each(function (d) {
        const tmp = document.createElement('div');
        tmp.innerHTML = (d || '').toString();
        const text = (tmp.textContent || tmp.innerText || '').trim();
        if (text !== '') $select.append(`<option value="${text}">${text}</option>`);
      });
    });
  });

  // Select2 inside modals
  $(document).on('shown.bs.modal', '.modal', function () {
    const $m = $(this);
    $m.find('.omc-select, .bdc-select').each(function () {
      $(this).select2({
        placeholder: "Select or search...",
        dropdownParent: $m,
        width: '100%'
      });
    });

    // Lock fields per mode (UI only; server enforces too)
    const $form = $m.find('form.edit-order-form');
    const mode = ($form.find('input[name="order_type"]').val() || 'combo').toLowerCase();
    const on  = ($el) => $el.prop('disabled', false).removeClass('dimmed');
    const off = ($el) => $el.prop('disabled', true).addClass('dimmed');

    const $p  = $form.find('input[name="p_bdc_omc"]');
    const $s  = $form.find('input[name="s_bdc_omc"]');
    const $pt = $form.find('input[name="p_tax"]');
    const $st = $form.find('input[name="s_tax"]');
    const $omc= $form.find('select[name="omc"]');
    const $bdc= $form.find('select[name="bdc"]');

    if (mode === 's_tax'){        // OMC (S-Tax) only
      off($p); off($s); on($pt); on($st); on($omc); off($bdc);
    } else if (mode === 's_bdc'){ // BDC (S-BDC) only
      on($p); on($s); off($pt); off($st); off($omc); on($bdc);
    } else {                      // combo
      on($p); on($s); on($pt); on($st); on($omc); on($bdc);
    }

    // Enforce due date >= today
    const today = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    const min = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
    const $due = $form.find('input[name="due_date"]');
    $due.attr('min', min);
    if ($due.val() && $due.val() < min) $due.val(min);
  });

  // Submit edits via AJAX → /orders/update/<id>
  $(document).on('submit', '.edit-order-form', function(e){
    e.preventDefault();
    const $form = $(this);
    const id = $form.data('id');

    // final due date check
    const $due = $form.find('input[name="due_date"]');
    if ($due.length){
      const today = new Date();
      const pad = (n)=>String(n).padStart(2,'0');
      const min = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
      const val = $due.val();
      if (val && val < min){
        $due[0].setCustomValidity('Due date cannot be in the past. Choose today or a future date.');
        $due[0].reportValidity();
        return;
      } else {
        $due[0].setCustomValidity('');
      }
    }

    $.post(`/orders/update/${id}`, $form.serialize())
      .done(function(){
        $('.modal.show').modal('hide');
        if (typeof loadContent === 'function') loadContent('/approved_orders', 'Approved Orders');
        else location.reload();
      })
      .fail(function(xhr){
        const err = xhr.responseJSON?.error || 'Failed to update order.';
        alert(err);
      });
  });
</script>
</body>
</html>
