<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Approved Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons & Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
    .container-fluid { padding: 30px; }
    h2 { font-weight: 600; margin-bottom: 20px; }
    .table-responsive { margin-top: 20px; position: relative; } /* relative for arrow positioning */
    th, td { vertical-align: middle; text-align: center; white-space: nowrap; }
    .dt-buttons .btn { margin-right: 8px; }
    #filtersRow .form-select { font-size: 0.875rem; }
    .header-bar { background: #0d6efd; color: white; padding: 10px 20px; border-radius: 6px; }
    .search-wrap { margin-top: 14px; }
    .modal .select2-container { width:100% !important; }
    .dimmed { opacity: .55; pointer-events: none; }
    .text-danger-soft { color:#842029; }
    .spin-inline { display: inline-flex; align-items: center; gap:.5rem; }
    @media (max-width: 576px){ .dt-buttons .btn { margin-bottom: 6px; } }

    /* ===== Full-page overlay spinner ===== */
    .page-spin-overlay{
      position: fixed; inset: 0; background: rgba(255,255,255,.65);
      display: none; align-items: center; justify-content: center; z-index: 2000;
      backdrop-filter: blur(1px);
    }
    .page-spin-overlay.show{ display: flex; }

    /* ===== Horizontal scroll arrows & edge fades ===== */
    .hscroll-btn{
      position:absolute; top: 50%; transform: translateY(-50%);
      width: 36px; height: 36px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      background: white; border: 1px solid #e2e8f0; box-shadow: 0 2px 10px rgba(0,0,0,.08);
      z-index: 105; cursor: pointer; opacity:.95;
      transition: transform .15s ease, opacity .15s ease;
    }
    .hscroll-btn:hover{ transform: translateY(-50%) scale(1.05); }
    .hscroll-btn:active{ transform: translateY(-50%) scale(0.98); }
    .hscroll-btn[disabled]{ opacity:.35; pointer-events:none; }
    .hscroll-left{ left: 8px; }
    .hscroll-right{ right: 8px; }

    .edge-fade{
      position:absolute; top:0; bottom:0; width: 40px; z-index: 100; pointer-events:none;
    }
    .edge-fade.left{ left:0; background: linear-gradient(90deg, rgba(248,249,250,1) 20%, rgba(248,249,250,0) 100%); }
    .edge-fade.right{ right:0; background: linear-gradient(270deg, rgba(248,249,250,1) 20%, rgba(248,249,250,0) 100%); }

    /* Slight lift so buttons sit above DataTables header area too */
    .dataTables_wrapper .dataTables_scroll{ position: relative; }
  </style>
</head>
<body>
<!-- Global page spinner overlay -->
<div id="pageSpinner" class="page-spin-overlay" aria-hidden="true">
  <div class="text-center">
    <div class="spinner-border" role="status" aria-label="Loading"></div>
    <div class="mt-2 fw-semibold">Processingâ€¦</div>
  </div>
</div>

<div class="container-fluid">
  <div class="header-bar d-flex align-items-center justify-content-between flex-wrap">
    <h2 class="mb-0"><i class="bi bi-check2-circle me-2"></i>Approved Orders</h2>
  </div>

  <!-- Quick Search -->
  <div class="row search-wrap">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="globalSearch" type="search" class="form-control"
               placeholder="Search by code, ID, client, vehicle, OMC, BDC, region, etc." value="{{ initial_q or '' }}">
        <button class="btn btn-outline-secondary" id="clearSearch" type="button">Clear</button>
      </div>
      <small class="text-muted">Tip: paste the 5-digit code (Order Code) or the Mongo ID to jump to a record.</small>
    </div>
  </div>

  <!-- Filters Row (per-column dropdowns) -->
  <div class="row mt-3 g-2" id="filtersRow"></div>

  <div class="row mt-2 align-items-center g-2">
    <div class="col-auto">
      <button id="reloadOrders" class="btn btn-outline-secondary btn-sm" type="button">
        <i class="bi bi-arrow-clockwise me-1"></i> Reload
      </button>
    </div>
    <div class="col-auto ms-auto d-flex align-items-center gap-2">
      <button id="prevPage" class="btn btn-outline-primary btn-sm" type="button">Prev</button>
      <span id="pageIndicator" class="small text-muted">Page 1 of 1</span>
      <button id="nextPage" class="btn btn-outline-primary btn-sm" type="button">Next</button>
    </div>
  </div>

  <div class="table-responsive" id="tableHost">
    <!-- Edge fades (auto hidden via JS if no overflow) -->
    <div class="edge-fade left d-none" aria-hidden="true"></div>
    <div class="edge-fade right d-none" aria-hidden="true"></div>

    <!-- Arrows (auto disabled/hidden via JS) -->
    <button type="button" class="hscroll-btn hscroll-left d-none" aria-label="Scroll left">
      <i class="bi bi-chevron-left"></i>
    </button>
    <button type="button" class="hscroll-btn hscroll-right d-none" aria-label="Scroll right">
      <i class="bi bi-chevron-right"></i>
    </button>

    <table id="approvedOrdersTable" class="table table-striped table-bordered w-100">
      <thead class="table-dark">
        <tr>
          <th>Order ID</th>
          <th><i class="bi bi-calendar3"></i><br>Date</th>
          <th><i class="bi bi-clock-history"></i><br>Approved At</th>
          <th><i class="bi bi-person-circle"></i><br>Client</th>
          <th><i class="bi bi-truck"></i><br>Vehicle #</th>
          <th><i class="bi bi-geo-alt"></i><br>Region</th>
          <th><i class="bi bi-fuel-pump"></i><br>Product</th>
          <th>Order Type</th>
          <th>OMC</th>
          <th>BDC</th>
          <th>DEPOT</th>
          <th>Qty</th>
          <th>P-BDC</th>
          <th>S-BDC</th>
          <th>P-Tax</th>
          <th>S-Tax</th>
          <th>S-Tax + S-BDC</th>
          <th><i class="bi bi-cash-coin"></i><br>Margin</th>
          <th>Returns</th>
          <th>Total Debt</th>
          <th>Paid</th>
          <th>Left</th>
          <th>Shareholder</th>
          <th>Delivery Status</th>
          <th class="no-export">Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTbody">
        <tr class="loading-row">
          <td colspan="25" class="text-muted">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Loading orders...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Modal (single instance) -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLbl" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLbl">Edit Order - <span class="edit-order-id"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form class="edit-order-form" method="POST" action="" data-id="">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Order Type</label>
            <div>
              <span class="badge order-type-badge"></span>
            </div>
            <input type="hidden" name="order_type" value="combo">
          </div>

          <div class="edit-error alert alert-danger d-none" role="alert"></div>

          <div class="row g-3">
            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">Shareholder</label>
              <select name="shareholder" class="form-select">
                <option value="">Select Shareholder</option>
                <option value="Rex">Rex</option>
                <option value="Simon">Simon</option>
                <option value="Paul">Paul</option>
                <option value="Neutral">Neutral</option>
              </select>
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">OMC</label>
              <select name="omc" class="form-control omc-select">
                <option value="">Select OMC</option>
                {% for o in omcs %}
                  <option value="{{ o.name }}" data-rep-phone="{{ o.rep_phone or '' }}">
                    {{ o.name }}{% if o.rep_phone %} - {{ o.rep_phone }}{% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">BDC</label>
              <select name="bdc" class="form-control bdc-select">
                <option value="">Select BDC</option>
                {% for b in bdcs %}
                  <option value="{{ b._id }}" data-bdc-name="{{ b.name }}"
                          data-rep-phone="{{ b.rep_phone or b.phone or '' }}">
                    {{ b.name }}{% if b.rep_phone or b.phone %} - {{ b.rep_phone or b.phone }}{% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">DEPOT</label>
              <input type="text" name="depot" class="form-control" value="" required>
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">P-BDC</label>
              <input type="number" step="0.01" name="p_bdc_omc" class="form-control" value="">
            </div>
            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">S-BDC</label>
              <input type="number" step="0.01" name="s_bdc_omc" class="form-control" value="">
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">P-Tax</label>
              <input type="number" step="0.01" name="p_tax" class="form-control" value="">
            </div>
            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">S-Tax</label>
              <input type="number" step="0.01" name="s_tax" class="form-control" value="">
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">Payment Type (BDC)</label>
              <select class="form-select" name="payment_type">
                <option value="">Select Payment Type</option>
                <option value="Cash">Cash</option>
                <option value="Credit">Credit</option>
                <option value="From Account">From Account</option>
              </select>
            </div>
            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">Payment Amount (optional)</label>
              <input type="number" step="0.01" name="payment_amount" class="form-control" placeholder="Auto: qty x P-BDC">
            </div>

            <div class="col-12 col-sm-6 col-lg-4">
              <label class="form-label">Due Date</label>
              <input type="date" name="due_date" class="form-control" value="">
              <div class="form-text text-muted">Only today or future dates are allowed.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <div class="me-auto small text-muted edit-order-summary"></div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">
            <span class="btn-label"><i class="bi bi-save me-1"></i> Save Changes</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Cancel Modal (single instance) -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLbl" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="cancelModalLbl"><i class="bi bi-x-octagon me-2"></i>Cancel Order - <span class="cancel-order-id"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form class="cancel-order-form" data-id="" data-left="">
        <div class="modal-body">
          <div class="alert alert-warning" role="alert">
            <div class="fw-semibold mb-1">This will:</div>
            <ul class="mb-0 text-start">
              <li>Delete BDC payable record(s) for this order.</li>
              <li>Delete OMC returns record(s) for this order.</li>
              <li>Set <code>status</code> to <strong>cancled</strong> or <strong>cancled - &lt;reason&gt;</strong>.</li>
              <li>Reset <code>returns</code>, <code>returns_total</code> (and related fields) to <strong>0.00</strong>.</li>
            </ul>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Reason for canceling (optional)</label>
            <textarea class="form-control" name="reason" rows="3" placeholder="Optional note for auditing..."></textarea>
            <div class="form-text text-danger-soft">Reason is stored on the order (status can become <em>cancled - reason</em>).</div>
          </div>
          <div class="cancel-error alert alert-danger d-none" role="alert"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-danger">
            <span class="btn-label">Confirm Cancel</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
  const $pageSpin = $('#pageSpinner');
  const showPageSpin = () => $pageSpin.addClass('show');
  const hidePageSpin = () => $pageSpin.removeClass('show');

  // ===== Horizontal scroll helpers =====
  function getScroller(){
    // Prefer DataTables scroll body when scrollX is enabled
    const dtBody = document.querySelector('#approvedOrdersTable').closest('.dataTables_wrapper')?.querySelector('.dataTables_scrollBody');
    if (dtBody) return dtBody;
    // Fallback: the .table-responsive wrapper
    return document.querySelector('#tableHost');
  }

  function updateHScrollUI(){
    const scroller = getScroller();
    if (!scroller) return;

    const maxScroll = scroller.scrollWidth - scroller.clientWidth;
    const hasOverflow = maxScroll > 2;

    const leftBtn  = document.querySelector('.hscroll-left');
    const rightBtn = document.querySelector('.hscroll-right');
    const fadeL    = document.querySelector('.edge-fade.left');
    const fadeR    = document.querySelector('.edge-fade.right');

    [leftBtn,rightBtn,fadeL,fadeR].forEach(el => { if (!el) return; el.classList.toggle('d-none', !hasOverflow); });

    if (!hasOverflow) return;

    const x = scroller.scrollLeft;
    const atStart = x <= 1;
    const atEnd   = x >= maxScroll - 1;

    if (leftBtn){ leftBtn.disabled = atStart; }
    if (rightBtn){ rightBtn.disabled = atEnd; }
    if (fadeL){ fadeL.style.opacity = atStart ? 0 : 1; }
    if (fadeR){ fadeR.style.opacity = atEnd ? 0 : 1; }
  }

  function attachHScrollControls(){
    const scroller = getScroller();
    if (!scroller) return;

    const leftBtn  = document.querySelector('.hscroll-left');
    const rightBtn = document.querySelector('.hscroll-right');

    const STEP = Math.max(240, Math.round(window.innerWidth * 0.45)); // step per click
    let rafId = null, dir = 0;

    function smoothStep(direction){
      const SPEED = Math.max(8, Math.round(scroller.clientWidth / 18)); // px/frame
      function tick(){
        scroller.scrollLeft += SPEED * direction;
        updateHScrollUI();
        const maxScroll = scroller.scrollWidth - scroller.clientWidth;
        if ((direction < 0 && scroller.scrollLeft <= 0) || (direction > 0 && scroller.scrollLeft >= maxScroll)){
          cancel();
          return;
        }
        rafId = requestAnimationFrame(tick);
      }
      rafId = requestAnimationFrame(tick);
    }
    function cancel(){ if (rafId){ cancelAnimationFrame(rafId); rafId = null; } dir = 0; }

    // Click step
    leftBtn?.addEventListener('click', () => { scroller.scrollLeft -= STEP; updateHScrollUI(); });
    rightBtn?.addEventListener('click', () => { scroller.scrollLeft += STEP; updateHScrollUI(); });

    // Press & hold continuous
    leftBtn?.addEventListener('mousedown', () => { dir = -1; smoothStep(-1); });
    rightBtn?.addEventListener('mousedown', () => { dir = 1;  smoothStep(1);  });
    ['mouseup','mouseleave','blur'].forEach(ev=>{
      leftBtn?.addEventListener(ev, cancel);
      rightBtn?.addEventListener(ev, cancel);
    });
    window.addEventListener('mouseup', cancel);

    // Sync on native scroll & resize
    scroller.addEventListener('scroll', updateHScrollUI, { passive: true });
    window.addEventListener('resize', () => setTimeout(updateHScrollUI, 50));

    // Shift + Wheel = horizontal scroll
    scroller.addEventListener('wheel', (e)=>{
      if (e.shiftKey){
        e.preventDefault();
        scroller.scrollLeft += e.deltaY; // natural
        updateHScrollUI();
      }
    }, { passive: false });

    // Initial
    setTimeout(updateHScrollUI, 0);
  }

  const orderCache = {};
  const pageSize = 10;
  let table = null;
  let currentPage = 1;
  let totalPages = 1;
  let currentQuery = ($('#globalSearch').val() || '').trim();
  let loading = false;

  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g, (c) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }
  function fmtNum(n, digits){
    const v = Number(n);
    if (!Number.isFinite(v)) return '-';
    return v.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits });
  }
  function fmtQty(n){ return fmtNum(n, 0); }

  function setLoadingRow(text){
    const msg = text || 'Loading orders...';
    const row = `
      <tr class="loading-row">
        <td colspan="25" class="text-muted">
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          ${escapeHtml(msg)}
        </td>
      </tr>`;
    $('#ordersTbody').html(row);
  }

  function modeBadgeClass(mode){
    if (mode === 's_bdc') return 'bg-primary';
    if (mode === 's_tax') return 'bg-warning text-dark';
    return 'bg-success';
  }
  function modeLabel(mode){
    if (mode === 's_bdc') return 'S-BDC';
    if (mode === 's_tax') return 'S-TAX';
    return 'COMBO';
  }

  function renderShareholder(shareholder){
    if (!shareholder) return '-';
    const cls = shareholder === 'Neutral' ? 'bg-secondary' : 'bg-primary';
    return `<span class="badge ${cls}">${escapeHtml(shareholder)}</span>`;
  }
  function renderDeliveryStatus(status){
    if (!status) return '<span class="badge bg-secondary">Pending</span>';
    const cls = String(status).toLowerCase() === 'delivered' ? 'success' : 'warning';
    return `<span class="badge bg-${cls}">${escapeHtml(status)}</span>`;
  }

  function renderRow(row){
    orderCache[row._id] = row;
    const leftAmt = Number(row.amount_left || 0);
    const sTotal = Number(row.s_tax || 0) + Number(row.s_bdc_omc || 0);
    const invoiceUrl = `/orders/invoice/${encodeURIComponent(row._id)}`;
    const clientUrl = row.client_mongo_id ? `/admin/client/${encodeURIComponent(row.client_mongo_id)}` : '#';

    return `
      <tr data-left="${leftAmt.toFixed(2)}">
        <td>${escapeHtml(row.order_id || '-')}</td>
        <td>${escapeHtml(row.date || '-')}</td>
        <td>${escapeHtml(row.approved_at || '-')}</td>
        <td><a href="${clientUrl}" class="text-decoration-none fw-semibold text-primary">${escapeHtml(row.client_name || 'Unknown')}</a></td>
        <td>${escapeHtml(row.vehicle_number || '')}</td>
        <td>${escapeHtml(row.region || '')}</td>
        <td>${escapeHtml(row.product || '')}</td>
        <td>${escapeHtml(row.order_type || '-')}</td>
        <td>${escapeHtml(row.omc || '-')}</td>
        <td>${escapeHtml(row.bdc_name || '-')}</td>
        <td>${escapeHtml(row.depot || '')}</td>
        <td>${fmtQty(row.quantity)}</td>
        <td>${fmtNum(row.p_bdc_omc, 2)}</td>
        <td>${fmtNum(row.s_bdc_omc, 2)}</td>
        <td>${fmtNum(row.p_tax, 2)}</td>
        <td>${fmtNum(row.s_tax, 2)}</td>
        <td>${fmtNum(sTotal, 2)}</td>
        <td>${fmtNum(row.margin, 2)}</td>
        <td>${fmtNum(row.returns, 2)}</td>
        <td>${fmtNum(row.total_debt, 2)}</td>
        <td>${fmtNum(row.amount_paid, 2)}</td>
        <td>${fmtNum(leftAmt, 2)}</td>
        <td>${renderShareholder(row.shareholder)}</td>
        <td>${renderDeliveryStatus(row.delivery_status)}</td>
        <td class="d-flex gap-1 justify-content-center">
          <button class="btn btn-sm btn-outline-primary edit-open-btn" data-id="${escapeHtml(row._id)}">
            <i class="bi bi-pencil-square me-1"></i> Edit
          </button>
          <button class="btn btn-sm btn-outline-danger cancel-open-btn" data-id="${escapeHtml(row._id)}" data-left="${leftAmt.toFixed(2)}">
            <i class="bi bi-x-octagon me-1"></i> Cancel
          </button>
          <a class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener" href="${invoiceUrl}">
            <i class="bi bi-receipt me-1"></i> Invoice
          </a>
        </td>
      </tr>`;
  }

  function initDataTable(){
    if (table) return;
    table = $('#approvedOrdersTable').DataTable({
      responsive: false,
      scrollX: true,
      ordering: false,
      paging: false,
      searching: false,
      info: false,
      lengthChange: false,
      dom: 'Bfrtip',
      buttons: [
        { extend: 'excelHtml5', className: 'btn btn-success btn-sm', title: 'Approved Orders',
          exportOptions: { modifier: { page: 'all', search: 'applied' }, columns: ':visible:not(.no-export)' } },
        { extend: 'csvHtml5',   className: 'btn btn-info btn-sm',    title: 'Approved Orders',
          exportOptions: { modifier: { page: 'all', search: 'applied' }, columns: ':visible:not(.no-export)' } },
        { extend: 'pdfHtml5',   className: 'btn btn-danger btn-sm',  title: 'Approved Orders',
          orientation: 'landscape', pageSize: 'A3',
          exportOptions: {
            modifier: { page: 'all', search: 'applied' },
            columns: ':visible:not(.no-export)',
            stripHtml: true,
            format: { body: function (data) {
              const tmp = document.createElement('div');
              tmp.innerHTML = data;
              return (tmp.textContent || tmp.innerText || '').replace(/\s+/g, ' ').trim();
            }}
          },
          customize: function (doc) {
            doc.content[1].margin = [10, 10, 10, 10];
            doc.styles.tableHeader.alignment = 'center';
            doc.defaultStyle.fontSize = 9;
            doc.styles.tableHeader.fontSize = 10;
            const stamp = new Date().toLocaleString();
            doc.footer = function(currentPage, pageCount) {
              return {
                columns: [
                  { text: 'Generated: ' + stamp, alignment: 'left', margin: [10, 0, 10, 0] },
                  { text: currentPage.toString() + ' / ' + pageCount, alignment: 'right', margin: [10, 0, 10, 0] }
                ]
              };
            };
            const body = doc.content[1].table.body;
            doc.content[1].table.widths = Array(body[0].length).fill('auto');
          }
        },
        { extend: 'print', className: 'btn btn-secondary btn-sm', title: 'Approved Orders',
          exportOptions: { modifier: { page: 'all', search: 'applied' }, columns: ':visible:not(.no-export)' } }
      ],
      language: { emptyTable: 'No orders found.' }
    });

    setTimeout(() => {
      attachHScrollControls();
      updateHScrollUI();
    }, 0);
  }

  function updatePaginationUI(){
    $('#pageIndicator').text(`Page ${currentPage} of ${totalPages}`);
    $('#prevPage').prop('disabled', currentPage <= 1);
    $('#nextPage').prop('disabled', currentPage >= totalPages);
  }

  function updateCancelButtons(){
    $('tr[data-left]').each(function(){
      const left = parseFloat($(this).data('left') || '0');
      const $btn = $(this).find('.cancel-open-btn');
      if (left <= 0){
        $btn.prop('disabled', true).attr('aria-disabled', 'true')
          .attr('title', 'Fully settled - nothing left to cancel')
          .attr('data-bs-toggle','tooltip').attr('data-bs-placement','top');
      } else {
        $btn.prop('disabled', false).removeAttr('aria-disabled').removeAttr('title')
          .removeAttr('data-bs-toggle').removeAttr('data-bs-placement');
      }
    });
  }

  function loadOrders(page){
    if (loading) return;
    loading = true;
    currentPage = page || 1;
    if (table) {
      table.clear().draw(false);
    } else {
      setLoadingRow('Loading orders...');
    }
    showPageSpin();

    $.get('/approved_orders/data', { page: currentPage, page_size: pageSize, q: currentQuery })
      .done(function(res){
        if (!res || res.success !== true){
          setLoadingRow(res?.error || 'Failed to load orders.');
          return;
        }

        totalPages = res.total_pages || 1;
        currentPage = res.page || currentPage;
        updatePaginationUI();

        const rows = res.rows || [];
        Object.keys(orderCache).forEach(k => delete orderCache[k]);

        const htmlRows = rows.map(renderRow).join('');
        if (!table){
          $('#ordersTbody').html(htmlRows || '');
          initDataTable();
        } else {
          table.clear();
          if (htmlRows){
            table.rows.add($(htmlRows));
          }
          table.draw(false);
        }

        if (!rows.length){
          if (table){
            table.clear().draw(false);
          } else {
            $('#ordersTbody').html('');
          }
        }

        updateCancelButtons();
        updateHScrollUI();
      })
      .fail(function(xhr){
        const err = xhr.responseJSON?.error || 'Failed to load orders.';
        setLoadingRow(err);
      })
      .always(function(){
        loading = false;
        hidePageSpin();
      });
  }

  // Search and pagination controls
  let searchTimer = null;
  $('#globalSearch').on('keyup change', function(){
    clearTimeout(searchTimer);
    const val = ($(this).val() || '').trim();
    searchTimer = setTimeout(function(){
      currentQuery = val;
      loadOrders(1);
    }, 300);
  });
  $('#clearSearch').on('click', function(){
    $('#globalSearch').val('');
    currentQuery = '';
    loadOrders(1);
  });
  $('#reloadOrders').on('click', function(){ loadOrders(currentPage); });
  $('#prevPage').on('click', function(){ if (currentPage > 1) loadOrders(currentPage - 1); });
  $('#nextPage').on('click', function(){ if (currentPage < totalPages) loadOrders(currentPage + 1); });

  // Select2 inside modals
  $(document).on('shown.bs.modal', '.modal', function () {
    const $m = $(this);
    $m.find('.omc-select, .bdc-select').each(function () {
      if (!$(this).hasClass('select2-hidden-accessible')) {
        $(this).select2({ placeholder: "Select or search...", dropdownParent: $m, width: '100%' });
      }
    });

    const $form = $m.find('form.edit-order-form');
    if ($form.length) {
      const today = new Date();
      const pad = (n)=>String(n).padStart(2,'0');
      const min = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
      const $due = $form.find('input[name="due_date"]');
      $due.attr('min', min);
      if ($due.val() && $due.val() < min) $due.val(min);
    }
  });

  function applyModeLock($form, mode){
    const on  = ($el) => $el.prop('disabled', false).removeClass('dimmed');
    const off = ($el) => $el.prop('disabled', true).addClass('dimmed');

    const $p  = $form.find('input[name="p_bdc_omc"]');
    const $s  = $form.find('input[name="s_bdc_omc"]');
    const $pt = $form.find('input[name="p_tax"]');
    const $st = $form.find('input[name="s_tax"]');
    const $omc= $form.find('select[name="omc"]');
    const $bdc= $form.find('select[name="bdc"]');

    if (mode === 's_tax'){
      off($p); off($s); on($pt); on($st); on($omc); off($bdc);
    } else if (mode === 's_bdc'){
      on($p); on($s); off($pt); off($st); off($omc); on($bdc);
    } else {
      on($p); on($s); on($pt); on($st); on($omc); on($bdc);
    }
  }

  // Open edit modal
  $(document).on('click', '.edit-open-btn', function(){
    const id = $(this).data('id');
    const row = orderCache[id];
    if (!row) return;

    const $modal = $('#editModal');
    const $form = $modal.find('form.edit-order-form');
    const mode = (row.order_type_raw || 'combo').toLowerCase();

    $modal.find('.edit-order-id').text(row.order_id || id);
    $modal.find('.edit-order-summary').text(`Quantity: ${fmtQty(row.quantity)} L | Product: ${row.product || '-'}`);
    $modal.find('.edit-error').addClass('d-none').text('');

    $form.attr('data-id', id);
    $form.attr('action', `/orders/update/${id}`);
    $form.find('input[name="order_type"]').val(mode);
    $modal.find('.order-type-badge').attr('class', `badge order-type-badge ${modeBadgeClass(mode)}`)
      .text(modeLabel(mode));

    $form.find('select[name="shareholder"]').val(row.shareholder || '');
    $form.find('select[name="omc"]').val(row.omc || '').trigger('change');
    $form.find('select[name="bdc"]').val(row.bdc_id || '').trigger('change');
    $form.find('input[name="depot"]').val(row.depot || '');
    $form.find('input[name="p_bdc_omc"]').val(row.p_bdc_omc ?? '');
    $form.find('input[name="s_bdc_omc"]').val(row.s_bdc_omc ?? '');
    $form.find('input[name="p_tax"]').val(row.p_tax ?? '');
    $form.find('input[name="s_tax"]').val(row.s_tax ?? '');
    $form.find('input[name="due_date"]').val(row.due_date || '');

    applyModeLock($form, mode);

    const modal = new bootstrap.Modal($modal[0]);
    modal.show();
  });

  // Prevent opening Cancel modal if Left <= 0 (client-side)
  $(document).on('click', '.cancel-open-btn', function(e){
    const left = parseFloat($(this).data('left') || '0');
    if (left <= 0){
      e.preventDefault();
      e.stopPropagation();
      const t = new bootstrap.Tooltip(this, { title: 'Fully settled - nothing left to cancel', placement: 'top' });
      t.show();
      setTimeout(()=>t.dispose(), 1500);
      return false;
    }

    const id = $(this).data('id');
    const row = orderCache[id] || {};
    const $modal = $('#cancelModal');
    $modal.find('.cancel-order-id').text(row.order_id || id);
    const $form = $modal.find('form.cancel-order-form');
    $form.attr('data-id', id);
    $form.attr('data-left', left.toFixed(2));
    $form.find('textarea[name="reason"]').val('');
    $form.find('.cancel-error').addClass('d-none').text('');
    const modal = new bootstrap.Modal($modal[0]);
    modal.show();
  });

  // Submit edits via AJAX -> /orders/update/<id> with page overlay spinner
  $(document).on('submit', '.edit-order-form', function(e){
    e.preventDefault();
    const $form = $(this);
    const id = $form.data('id');

    const $due = $form.find('input[name="due_date"]');
    if ($due.length){
      const today = new Date();
      const pad = (n)=>String(n).padStart(2,'0');
      const min = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
      const val = $due.val();
      if (val && val < min){
        $due[0].setCustomValidity('Due date cannot be in the past. Choose today or a future date.');
        $due[0].reportValidity();
        return;
      } else {
        $due[0].setCustomValidity('');
      }
    }

    const $btn = $form.find('button[type="submit"]');
    const $spin = $btn.find('.spinner-border');
    const $label = $btn.find('.btn-label');

    $btn.prop('disabled', true);
    $spin.removeClass('d-none');
    $label.text('Saving...');
    showPageSpin();

    $.post(`/orders/update/${id}`, $form.serialize())
      .done(function(){
        $('.modal.show').modal('hide');
        loadOrders(currentPage);
      })
      .fail(function(xhr){
        const err = xhr.responseJSON?.error || 'Failed to update order.';
        const $err = $form.find('.edit-error');
        $err.removeClass('d-none').text(err);
      })
      .always(function(){
        $btn.prop('disabled', false);
        $spin.addClass('d-none');
        $label.text('Save Changes');
        hidePageSpin();
      });
  });

  // Cancel order -> /approved_orders/cancel/<id> (POST { reason }) with page overlay spinner
  $(document).on('submit', '.cancel-order-form', function(e){
    e.preventDefault();
    const $form = $(this);
    const id = $form.data('id');
    const left = parseFloat($form.data('left') || '0');
    if (left <= 0){
      const $err = $form.find('.cancel-error');
      $err.removeClass('d-none').text('This order is fully settled. Cancelling is disabled.');
      return;
    }

    const reason = ($form.find('textarea[name="reason"]').val() || '').trim();

    const $btn = $form.find('button[type="submit"]');
    const $spin = $btn.find('.spinner-border');
    const $label = $btn.find('.btn-label');
    const $error = $form.find('.cancel-error');

    $error.addClass('d-none').text('');
    $btn.prop('disabled', true);
    $form.find('textarea, input, select, button:not([type="submit"])').prop('disabled', true);
    $spin.removeClass('d-none');
    $label.text('Cancelling...');
    showPageSpin();

    $.ajax({
      url: `/approved_orders/cancel/${id}`,
      method: 'POST',
      data: { reason: reason },
    })
    .done(function(){
      $('.modal.show').modal('hide');
      loadOrders(currentPage);
    })
    .fail(function(xhr){
      const err = xhr.responseJSON?.error || 'Failed to cancel order.';
      $error.removeClass('d-none').text(err);
    })
    .always(function(){
      $btn.prop('disabled', false);
      $form.find('textarea, input, select, button:not([type="submit"])').prop('disabled', false);
      $spin.addClass('d-none');
      $label.text('Confirm Cancel');
      hidePageSpin();
    });
  });

  // Initial load
  $(function(){
    $('#filtersRow').empty();
    loadOrders(1);
  });
</script>
</body>
</html>
