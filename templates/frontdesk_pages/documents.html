<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Documents</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap / jQuery / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png">

  <style>
    :root { --brand:#0d6efd; --brand-50:#e7f1ff; --ink:#0b2447; }
    .page-title{ color:#0b5ed7; }
    .card-doc{ border:1px solid rgba(13,110,253,.12); transition: box-shadow .2s; }
    .card-doc:hover{ box-shadow: 0 6px 18px rgba(13,110,253,.15); }
    .grid{ display:grid; gap:1rem; grid-template-columns: repeat( auto-fill, minmax(220px, 1fr) ); }

    /* Thumbs */
    .thumb{
      width:100%; height:160px; border-bottom:1px solid rgba(0,0,0,.06);
      display:flex; align-items:center; justify-content:center; background:#f5f8ff;
      overflow:hidden;
    }
    .thumb img{ max-height:100%; max-width:100%; object-fit:contain; }

    /* Letter tile for non-images */
    .letter-tile{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:3rem; color:#fff;
      background: linear-gradient(135deg, var(--lt-a), var(--lt-b));
    }

    /* Chips */
    .chip{ display:inline-flex; align-items:center; padding:.15rem .5rem; border-radius:999px; font-size:.75rem; background:var(--brand-50); color:#0b3c8a; }

    /* Upload dropzone */
    .dropzone{
      border:2px dashed rgba(13,110,253,.4); border-radius:.75rem; background:#f5f9ff;
      padding:1rem; text-align:center; transition: background .2s, border-color .2s;
    }
    .dropzone.dragover{ background:#e7f1ff; border-color:#0d6efd; }

    .btn-circle{ border-radius:999px; width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; padding:0; }

    /* Offcanvas width tweaks */
    @media (min-width: 992px){
      .offcanvas-end{ width: 520px; }
    }
  </style>
</head>
<body>
    {% include 'frontdesk_pages/front_desk_sidebar.html' %}
  <div class="container-fluid py-3">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <div class="d-flex align-items-center gap-2">
        <h3 class="m-0 page-title"><i class="bi bi-folder2-open me-2"></i>Documents</h3>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" data-bs-toggle="offcanvas" data-bs-target="#filtersCanvas">
          <i class="bi bi-funnel"></i> Filters
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
          <i class="bi bi-upload"></i> Upload
        </button>
      </div>
    </div>

    <!-- Results Grid -->
    <div class="grid" id="grid"></div>

    <!-- Pagination -->
    <div class="d-flex align-items-center justify-content-between mt-3">
      <div class="text-muted" id="meta"></div>
      <div class="btn-group">
        <button id="prev" class="btn btn-outline-primary btn-sm">Prev</button>
        <button id="next" class="btn btn-outline-primary btn-sm">Next</button>
      </div>
    </div>
  </div>

  <!-- Offcanvas Filters -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filtersCanvas" aria-labelledby="filtersLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="filtersLabel"><i class="bi bi-filter-circle me-2"></i>Filters</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">Search</label>
          <input id="q" class="form-control" placeholder="Title, filename, tag, note, uploader…" />
        </div>

        <div class="col-12">
          <label class="form-label">Category</label>
          <select id="category" class="form-select"><option value="">All</option></select>
        </div>
        <div class="col-12">
          <label class="form-label">Tag</label>
          <select id="tag" class="form-select"><option value="">All</option></select>
        </div>

        <div class="col-6">
          <label class="form-label">Type</label>
          <select id="type" class="form-select">
            <option value="">All</option>
            <option value="image">Images</option>
            <option value="pdf">PDF</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">Per page</label>
          <select id="per" class="form-select">
            <option>12</option><option selected>24</option><option>36</option><option>48</option><option>60</option>
          </select>
        </div>

        <div class="col-6">
          <label class="form-label">From</label>
          <input id="date_from" type="date" class="form-control"/>
        </div>
        <div class="col-6">
          <label class="form-label">To</label>
          <input id="date_to" type="date" class="form-control"/>
        </div>

        <div class="col-12">
          <label class="form-label">Sort</label>
          <select id="sort" class="form-select">
            <option value="-uploaded_at" selected>Newest</option>
            <option value="uploaded_at">Oldest</option>
            <option value="title">Title A→Z</option>
            <option value="-title">Title Z→A</option>
            <option value="size">Size Small→Large</option>
            <option value="-size">Size Large→Small</option>
          </select>
        </div>

        <div class="col-12 d-grid">
          <button id="btnFilter" class="btn btn-primary"><i class="bi bi-check2-circle"></i> Apply Filters</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header border-primary-subtle">
          <h5 class="modal-title">Upload Document</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="dropzone" class="dropzone">
            <div class="mb-2">
              <i class="bi bi-cloud-upload" style="font-size:2rem;"></i>
            </div>
            <div class="text-muted">Drag and drop files here or choose a file</div>
            <div class="mt-2">
              <input id="fileInput" type="file" class="form-control" />
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Title</label>
              <input id="title" class="form-control" placeholder="Optional – defaults to filename"/>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Category</label>
              <input id="category_up" class="form-control" placeholder="e.g., Contracts, IDs, Invoices"/>
            </div>
            <div class="col-12">
              <label class="form-label">Tags <span class="text-muted">(comma separated)</span></label>
              <input id="tags_up" class="form-control" placeholder="e.g., HR, Driver, Q3"/>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea id="notes_up" class="form-control" rows="2" placeholder="Optional notes"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="btnUpload" class="btn btn-primary">Upload</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const $  = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const fmtBytes = (n=0)=>{
      const k=1024, sizes=['B','KB','MB','GB','TB']; if(n===0) return '0 B';
      const i=Math.floor(Math.log(n)/Math.log(k)); return (n/Math.pow(k,i)).toFixed( i?1:0 )+' '+sizes[i];
    };
    const fmtDate = (s)=> s? new Date(s).toLocaleString() : '—';
    const debounce = (fn, ms=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    // Letter tile helpers
    function firstLetter(s){
      if(!s) return 'F';
      const m = String(s).match(/[A-Za-z0-9]/);
      return (m ? m[0] : s[0]).toUpperCase();
    }
    function colorPairFor(str){
      // simple hash -> pick from palette
      const palette = [
        ['#667eea','#764ba2'],
        ['#36d1dc','#5b86e5'],
        ['#11998e','#38ef7d'],
        ['#ff512f','#dd2476'],
        ['#f7971e','#ffd200'],
        ['#614385','#516395'],
        ['#02aab0','#00cdac']
      ];
      let h=0; for(let i=0;i<str.length;i++) h=(h*31 + str.charCodeAt(i))>>>0;
      return palette[h % palette.length];
    }

    // ---------- State ----------
    let CUR = { page:1, total:0, per:24 };

    function paramsFromUI(){
      const p = new URLSearchParams();
      const q = $('#q')?.value?.trim();
      if(q) p.set('q', q);
      ['category','tag','type','sort','per'].forEach(id=>{
        const el = $('#'+id); if(el && el.value) p.set(id, el.value);
      });
      const df = $('#date_from')?.value; if(df) p.set('date_from', df);
      const dt = $('#date_to')?.value; if(dt) p.set('date_to', dt);
      p.set('page', CUR.page);
      p.set('per', $('#per')?.value || 24);
      return p;
    }

    // ---------- Render ----------
    function docCard(it){
      const isImg = !!it.is_image;
      const downloadURL = `/frontdesk/api/docs/${it.id}/download`;
      const displayKey = it.title || it.filename || 'File';
      const [c1,c2] = colorPairFor(displayKey);

      return `
        <div class="card card-doc h-100">
          <div class="thumb" style="${!isImg ? `--lt-a:${c1};--lt-b:${c2};` : ''}">
            ${
              isImg
                ? `<img loading="lazy" src="/frontdesk/api/docs/${it.id}/preview" alt="${(it.title||'').replace(/"/g,'&quot;')}" />`
                : `<div class="letter-tile">${firstLetter(displayKey)}</div>`
            }
          </div>
          <div class="card-body d-flex flex-column">
            <div class="fw-semibold text-truncate" title="${it.title||''}">${it.title || '—'}</div>
            <div class="text-muted small text-truncate" title="${it.filename||''}">${it.filename || '—'}</div>
            <div class="text-muted small mt-1">${it.mimetype || ''} · ${fmtBytes(it.size)}</div>
            <div class="mt-2">
              ${(it.tags||[]).slice(0,3).map(t=>`<span class="chip me-1 mb-1">${t}</span>`).join('')}
              ${(it.tags||[]).length>3 ? `<span class="chip">+${(it.tags||[]).length-3}</span>`:''}
            </div>
            <div class="text-muted small mt-2">${fmtDate(it.uploaded_at)}</div>
            <div class="mt-auto d-flex gap-2 pt-2">
              <a href="${downloadURL}" class="btn btn-outline-primary btn-sm flex-fill"><i class="bi bi-download"></i> Download</a>
              <button class="btn btn-outline-success btn-sm flex-fill" data-share="${it.id}">
                <i class="bi bi-whatsapp"></i> WhatsApp
              </button>
              <button class="btn btn-outline-danger btn-sm btn-circle" title="Delete" data-del="${it.id}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderGrid(payload){
      const grid = $('#grid');
      grid.innerHTML = payload.items.map(docCard).join('') || `
        <div class="text-center text-muted py-5">No documents found.</div>
      `;

      // Actions
      $$('#grid [data-del]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-del');
          if(!confirm('Delete this document?')) return;
          const r = await fetch('/frontdesk/api/docs/'+id, {method:'DELETE'});
          if(r.ok) load();
        });
      });
      $$('#grid [data-share]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-share');
          const r = await fetch('/frontdesk/api/docs/'+id+'/share', {method:'POST'});
          if(!r.ok) return alert('Could not generate share link');
          const data = await r.json();
          window.open(data.whatsapp_url || data.share_url, '_blank');
        });
      });

      // Meta + pagination
      CUR.total = payload.total; CUR.per = payload.per;
      const first = (CUR.page-1)*CUR.per + 1;
      const last  = Math.min(CUR.page*CUR.per, CUR.total);
      $('#meta').textContent = payload.total ? `Showing ${first}-${last} of ${CUR.total}` : '—';
      $('#prev').disabled = (CUR.page<=1);
      $('#next').disabled = (CUR.page*CUR.per >= CUR.total);
    }

    // ---------- Load ----------
    async function loadTaxonomy(){
      const r = await fetch('/frontdesk/api/docs/taxonomy');
      const j = await r.json();
      $('#category').innerHTML = '<option value="">All</option>' + j.categories.map(c=>`<option>${c}</option>`).join('');
      $('#tag').innerHTML = '<option value="">All</option>' + j.tags.map(t=>`<option>${t}</option>`).join('');
    }

    async function load(){
      const p = paramsFromUI();
      const r = await fetch('/frontdesk/api/docs?'+p.toString());
      if(!r.ok) { alert('Failed to load'); return; }
      const j = await r.json();
      renderGrid(j);
    }

    // ---------- Upload ----------
    async function doUpload(file){
      if(!file) return;
      const fd = new FormData();
      fd.append('file', file);
      const t = $('#title').value.trim(); if(t) fd.append('title', t);
      const c = $('#category_up').value.trim(); if(c) fd.append('category', c);
      const tags = $('#tags_up').value.trim(); if(tags) fd.append('tags', tags);
      const notes = $('#notes_up').value.trim(); if(notes) fd.append('notes', notes);

      const r = await fetch('/frontdesk/api/docs', {method:'POST', body: fd});
      if(!r.ok) { alert('Upload failed'); return; }

      // Reset and close
      $('#fileInput').value = '';
      $('#title').value = '';
      $('#category_up').value = '';
      $('#tags_up').value = '';
      $('#notes_up').value = '';
      bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();

      await loadTaxonomy();
      load();
    }

    // Drag & drop
    function setupDropzone(){
      const dz = $('#dropzone');
      dz.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.classList.add('dragover'); });
      dz.addEventListener('dragleave', ()=> dz.classList.remove('dragover'));
      dz.addEventListener('drop', (e)=>{
        e.preventDefault(); dz.classList.remove('dragover');
        const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f) doUpload(f);
      });
    }

    // ---------- Wire up ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadTaxonomy();
      setupDropzone();
      load();

      // Apply filters and close drawer
      $('#btnFilter').addEventListener('click', ()=>{
        CUR.page=1; load();
        const el = document.getElementById('filtersCanvas');
        const oc = bootstrap.Offcanvas.getInstance(el) || new bootstrap.Offcanvas(el);
        oc.hide();
      });

      // Live search
      $('#q').addEventListener('input', debounce(()=>{ CUR.page=1; load(); }, 350));

      // Change reloads
      ['category','tag','type','sort','per','date_from','date_to'].forEach(id=>{
        $('#'+id).addEventListener('change', ()=>{ CUR.page=1; load(); });
      });
      $('#prev').addEventListener('click', ()=>{ if(CUR.page>1){ CUR.page--; load(); }});
      $('#next').addEventListener('click', ()=>{ if(CUR.page*CUR.per < CUR.total){ CUR.page++; load(); }});

      // File chooser in modal
      $('#btnUpload').addEventListener('click', ()=>{
        const f = $('#fileInput').files && $('#fileInput').files[0];
        if(!f) return alert('Choose a file');
        doUpload(f);
      });
      $('#fileInput').addEventListener('change', ()=>{
        const f = $('#fileInput').files && $('#fileInput').files[0];
        if(f && !$('#title').value) $('#title').value = f.name;
      });
    });
  </script>
</body>
</html>
