<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap / jQuery / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png">

  <style>
    :root { --brand: #0d6efd; --brand-600:#0b5ed7; --brand-50:#e7f1ff; }
    .subtle-card { border:1px solid rgba(13,110,253,.15); }
    .avatar{ width:80px; height:80px; object-fit:cover; border:3px solid var(--brand-50); }
    .doc-line{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .doc-meta{ color:#6b7280; font-size:.875rem; }
    .chip { display:inline-flex; align-items:center; gap:.25rem; padding:.15rem .55rem; border-radius:999px; background:var(--brand-50); color:#0b3c8a; font-size:.75rem; }
    .section-title { color: var(--brand-600); }
    @media (max-width: 576px){ .doc-line{ flex-direction:column; align-items:flex-start; } }
  </style>
</head>
<body>
  <div class="container py-3">
    <a href="/frontdesk/employees" class="btn btn-outline-primary mb-3"><i class="bi bi-arrow-left"></i> Back to directory</a>

    <!-- Header -->
    <div class="card subtle-card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div class="d-flex align-items-center gap-3">
            <img id="avatar" src="https://ui-avatars.com/api/?name=?" class="rounded-circle avatar" />
            <div>
              <h4 id="empName" class="mb-0"></h4>
              <div class="text-muted" id="empSub"></div>
              <div class="mt-1"><span id="statusBadge" class="badge text-bg-secondary">—</span></div>
            </div>
          </div>
          <div class="text-end">
            <div class="small text-muted">Probation ends</div>
            <div id="probationInfo" class="fw-semibold">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="row g-3">
      <div class="col-lg-7">
        <!-- Employment -->
        <div class="card subtle-card mb-3">
          <div class="card-header bg-white">
            <strong class="section-title"><i class="bi bi-briefcase me-2"></i>Employment Details</strong>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-6">
                <div class="text-muted small">Role Title</div>
                <div id="v_role">—</div>
              </div>
              <div class="col-md-6">
                <div class="text-muted small">Staff ID</div>
                <div id="v_staff">—</div>
              </div>
              <div class="col-md-6">
                <div class="text-muted small">Start Date</div>
                <div id="v_start">—</div>
              </div>
              <div class="col-md-6">
                <div class="text-muted small">Confirmation</div>
                <div id="v_confirm">—</div>
              </div>
            </div>
            <div class="mt-3">
              <div class="text-muted small">Location</div>
              <div id="v_location">—</div>
            </div>
            <div class="mt-3">
              <div class="text-muted small">Groups</div>
              <div id="v_groups">—</div>
            </div>
            <div class="mt-3">
              <div class="text-muted small">Notes</div>
              <div id="v_notes">—</div>
            </div>
          </div>
        </div>

        <!-- Custom fields -->
        <div class="card subtle-card">
          <div class="card-header bg-white">
            <strong class="section-title"><i class="bi bi-ui-checks-grid me-2"></i>Custom Fields</strong>
          </div>
          <div class="card-body" id="v_custom">
            <div class="text-muted">—</div>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <!-- Contact -->
        <div class="card subtle-card mb-3">
          <div class="card-header bg-white">
            <strong class="section-title"><i class="bi bi-person-lines-fill me-2"></i>Contact</strong>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-12 col-md-6">
                <div class="text-muted small">Email</div>
                <div id="v_email">—</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted small">Phone</div>
                <div id="v_phone">—</div>
              </div>
              <div class="col-12">
                <div class="text-muted small">Employment Type</div>
                <div id="v_type">—</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Documents -->
        <div class="card subtle-card">
          <div class="card-header bg-white d-flex align-items-center justify-content-between">
            <strong class="section-title"><i class="bi bi-folder2-open me-2"></i>Documents</strong>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
              <i class="bi bi-upload"></i> Upload
            </button>
          </div>
          <div class="card-body">
            <div id="filesList" class="list-group small"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload Document</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="uploadForm">
            <div class="mb-2">
              <label class="form-label">Title</label>
              <input class="form-control" name="title" placeholder="Contract, ID, Certificate..." />
            </div>
            <div class="mb-2">
              <label class="form-label">Type</label>
              <select class="form-select" name="doc_type">
                <option value="contract">Contract</option>
                <option value="id">ID</option>
                <option value="certification">Certification</option>
                <option value="letter">Letter</option>
                <option value="other" selected>Other</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">File</label>
              <input type="file" class="form-control" name="file" required />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="btnUpload" class="btn btn-primary">Upload</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const EMP_ID = "{{ emp_id }}";

    const $ = (sel, el=document) => el.querySelector(sel);
    const fmt = (s) => s ? new Date(s).toLocaleDateString() : "—";
    async function fetchJSON(url, opts){ const r=await fetch(url, opts); if(!r.ok) throw new Error('Request failed'); return r.json(); }

    function renderChips(arr){
      if(!arr || !arr.length) return '—';
      return arr.map(g=>`<span class="chip me-1 mb-1">${g}</span>`).join(' ');
    }
    function renderCustomFields(cfs){
      const wrap = $('#v_custom');
      if(!cfs || !cfs.length){ wrap.innerHTML = '<div class="text-muted">—</div>'; return; }
      wrap.innerHTML = cfs.map(cf => `
        <div class="row py-1 border-bottom">
          <div class="col-5 fw-semibold">${(cf.name||'—')}</div>
          <div class="col-7">${(cf.value||'—')}</div>
        </div>
      `).join('');
    }

    async function loadProfile(){
      const d = await fetchJSON('/frontdesk/api/employees/'+EMP_ID);
      const full = `${d.first_name||''} ${d.last_name||''}`.trim();

      $('#empName').textContent = full || '—';
      $('#empSub').textContent = d.role_title || '—';

      const badgeClass = d.status==='active' ? 'text-bg-success' : (d.status==='probation' ? 'text-bg-warning' : (d.status==='confirmed'?'text-bg-primary':'text-bg-secondary'));
      const sb = $('#statusBadge'); sb.className = 'badge '+badgeClass; sb.textContent = (d.status||'—').toUpperCase();

      $('#probationInfo').textContent = d.probation_end ? new Date(d.probation_end).toLocaleDateString() : '—';

      $('#v_role').textContent = d.role_title || '—';
      $('#v_staff').textContent = d.staff_id || '—';
      $('#v_start').textContent = fmt(d.start_date);
      $('#v_confirm').textContent = fmt(d.confirmation_date);
      $('#v_location').textContent = d.location || '—';
      $('#v_notes').textContent = d.notes || '—';
      $('#v_groups').innerHTML = renderChips(d.groups || []);

      $('#v_email').textContent = d.email || '—';
      $('#v_phone').textContent = d.phone || '—';
      $('#v_type').textContent = (d.employment_type || '—').replace('_',' ').replace(/\b\w/g, c=>c.toUpperCase());

      if(d.avatar_url){ $('#avatar').src = d.avatar_url; }
      else if(full){ $('#avatar').src = `https://ui-avatars.com/api/?background=0D6EFD&color=fff&name=${encodeURIComponent(full)}`; }

      renderCustomFields(d.custom_fields || []);

      loadFiles();
    }

    async function loadFiles(){
      const list = await fetchJSON(`/frontdesk/api/employees/${EMP_ID}/files`);
      const wrap = $('#filesList');
      wrap.innerHTML = list.map(f=>`
        <div class="list-group-item doc-line">
          <div>
            <div class="fw-semibold">${f.title||f.filename}</div>
            <div class="doc-meta">${f.doc_type} · ${f.mimetype} · ${(f.size||0)} bytes · ${new Date(f.uploaded_at).toLocaleString()}</div>
          </div>
          <div class="ms-2">
            <a class="btn btn-sm btn-outline-secondary" href="/frontdesk/api/files/${f.meta_id}/download"><i class="bi bi-download"></i></a>
            <button class="btn btn-sm btn-outline-danger" data-del="${f.meta_id}"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      `).join('');

      wrap.querySelectorAll('button[data-del]').forEach(b=>{
        b.addEventListener('click', async (e)=>{
          if(!confirm('Delete this file?')) return;
          const id = e.currentTarget.getAttribute('data-del');
          await fetch('/frontdesk/api/files/'+id, {method:'DELETE'});
          loadFiles();
        });
      });
    }

    async function doUpload(){
      const form = document.getElementById('uploadForm');
      const fd = new FormData(form);
      if(!fd.get('file') || !fd.get('file').name){ alert('Choose a file'); return; }
      const res = await fetch(`/frontdesk/api/employees/${EMP_ID}/files`, { method:'POST', body: fd });
      if(!res.ok){ alert('Upload failed'); return; }
      bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
      form.reset();
      loadFiles();
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      loadProfile();
      const btnU = document.getElementById('btnUpload');
      if(btnU) btnU.addEventListener('click', doUpload);
    });
  </script>
</body>
</html>
