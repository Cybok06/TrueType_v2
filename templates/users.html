<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Manage Admin Users</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .perm-grid { columns: 2; -webkit-columns: 2; -moz-columns: 2; }
    @media (min-width: 992px){ .perm-grid { columns: 3; } }
    .perm-item { break-inside: avoid; margin-bottom: .5rem; }
    .table thead th { white-space: nowrap; }
    .pw-meter { height: 6px; border-radius: 6px; background:#e9ecef; overflow:hidden }
    .pw-meter > div { height:100%; width:0%; background:#dc3545; transition:width .2s ease }
    .pw-strong   > div { background:#198754 }
    .pw-medium   > div { background:#fd7e14 }
    .form-text.small-danger{ color:#dc3545 }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <div class="d-flex align-items-center gap-2 mb-3">
      <a class="btn btn-outline-secondary btn-sm" href="/admin/dashboard"><i class="bi bi-arrow-left"></i> Back</a>
      <h4 class="mb-0">Users</h4>
    </div>

    <!-- Create Admin -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">Create Admin</div>
      <div class="card-body">
        <form id="createForm" class="row g-3" novalidate>
          <div class="col-md-4">
            <label class="form-label">Username</label>
            <input name="username" class="form-control" placeholder="e.g. john.doe" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Position</label>
            <input name="position" class="form-control" placeholder="e.g. Accounts Officer">
          </div>
          <div class="col-md-4">
            <label class="form-label">Password</label>
            <input name="password" id="createPassword" type="password" class="form-control" placeholder="Set initial password" required>
            <div class="pw-meter mt-2" id="createPwMeter"><div></div></div>
            <div class="form-text" id="createPwHelp">
              Must be at least 10 chars, include upper, lower, number, and symbol.
            </div>
          </div>

          <div class="col-12">
            <label class="form-label mb-2">Page Status (default: ON)</label>
            <div class="perm-grid">
              {% for p in PERMISSIONS %}
              <div class="form-check form-switch perm-item">
                <input class="form-check-input" type="checkbox" role="switch"
                       name="status_{{ p.slug }}" id="status_new_{{ loop.index }}" checked>
                <label class="form-check-label" for="status_new_{{ loop.index }}">{{ p.label }}</label>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary"><i class="bi bi-person-plus"></i> Create</button>
            <button class="btn btn-outline-secondary" type="reset">Clear</button>
          </div>
        </form>
        <div id="createMsg" class="mt-2 small"></div>
      </div>
    </div>

    <!-- Existing Admins -->
    <div class="card">
      <div class="card-header bg-light">Existing Admins</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-secondary">
              <tr>
                <th>Username</th>
                <th>Position</th>
                <th>Status</th>
                <th>Pages (# ON)</th>
                <th style="width: 280px;">Actions</th>
              </tr>
            </thead>
            <tbody id="adminsTbody">
              {% for a in admins %}
              <tr data-id="{{ a._id }}">
                <td><strong>{{ a.username }}</strong></td>
                <td>{{ a.position or '-' }}</td>
                <td>
                  {% if a.status == 'blocked' %}
                    <span class="badge text-bg-danger">Blocked</span>
                  {% else %}
                    <span class="badge text-bg-success">Active</span>
                  {% endif %}
                </td>
                <td>{{ a.count_on or 0 }}</td>
                <td class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-primary" onclick="openEdit('{{ a._id }}')">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  {% if a.status == 'blocked' %}
                  <button class="btn btn-sm btn-success" onclick="setStatus('{{ a._id }}','active')">
                    <i class="bi bi-unlock"></i> Unblock
                  </button>
                  {% else %}
                  <button class="btn btn-sm btn-outline-warning" onclick="setStatus('{{ a._id }}','blocked')">
                    <i class="bi bi-slash-circle"></i> Block
                  </button>
                  {% endif %}
                  <button class="btn btn-sm btn-outline-danger" onclick="removeUser('{{ a._id }}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="text-center text-muted py-4">No admin users yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="editForm" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Edit Admin</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editUid">

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Username</label>
                <input id="editUsername" class="form-control" disabled>
                <div class="form-text">Username cannot be changed.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Position</label>
                <input name="position" id="editPosition" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Reset Password (optional)</label>
                <input name="password" id="editPassword" type="password" class="form-control" placeholder="Leave blank to keep current">
                <div class="pw-meter mt-2" id="editPwMeter"><div></div></div>
                <div class="form-text" id="editPwHelp">
                  Strong passwords only (min 10, upper, lower, number, symbol).
                </div>
              </div>

              <div class="col-12">
                <label class="form-label mb-2">Page Status</label>
                <div class="perm-grid">
                  {% for p in PERMISSIONS %}
                  <div class="form-check form-switch perm-item">
                    <input class="form-check-input" type="checkbox" role="switch"
                           name="status_{{ p.slug }}" id="status_edit_{{ loop.index }}">
                    <label class="form-check-label" for="status_edit_{{ loop.index }}">{{ p.label }}</label>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button class="btn btn-primary"><i class="bi bi-save"></i> Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </form>
        <div id="editMsg" class="px-3 pb-3 small"></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---- Password strength (client) ----
    function scorePassword(pw){
      if(!pw) return 0;
      let score = 0;
      if(pw.length >= 10) score += 1;
      if(/[a-z]/.test(pw)) score += 1;
      if(/[A-Z]/.test(pw)) score += 1;
      if(/\d/.test(pw)) score += 1;
      if(/[^A-Za-z0-9]/.test(pw)) score += 1;
      return score; // 0..5
    }
    function bindPwMeter(inputId, meterId, helpId){
      const $inp = document.getElementById(inputId);
      const $meter = document.getElementById(meterId);
      const $bar = $meter?.firstElementChild;
      const $help = document.getElementById(helpId);
      if(!$inp || !$bar) return;
      function update(){
        const s = scorePassword($inp.value);
        const pct = Math.min(100, s*20);
        $meter.classList.remove('pw-medium','pw-strong');
        if(s >= 4) $meter.classList.add('pw-strong');
        else if(s >= 3) $meter.classList.add('pw-medium');
        $bar.style.width = pct + '%';
      }
      $inp.addEventListener('input', update);
      update();
    }
    bindPwMeter('createPassword','createPwMeter','createPwHelp');
    bindPwMeter('editPassword','editPwMeter','editPwHelp');

    function isStrongPassword(pw){
      return pw.length >= 10 &&
             /[a-z]/.test(pw) &&
             /[A-Z]/.test(pw) &&
             /\d/.test(pw) &&
             /[^A-Za-z0-9]/.test(pw);
    }

    // --- Create ---
    document.getElementById('createForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const fm = e.currentTarget;
      const fd = new FormData(fm);
      const msg = document.getElementById('createMsg');

      const pw = fd.get('password') || '';
      if(!isStrongPassword(pw)){
        msg.className = 'mt-2 small text-danger';
        msg.textContent = 'Password is not strong. Use at least 10 chars incl. upper, lower, number & symbol.';
        return;
      }

      try {
        const res = await fetch('/users/create', { method: 'POST', body: fd });
        const out = await res.json();
        if (out.ok) {
          msg.className = 'mt-2 small text-success';
          msg.textContent = 'Admin created.';
          fm.reset();
          location.reload();
        } else {
          msg.className = 'mt-2 small text-danger';
          msg.textContent = out.error || 'Failed to create.';
        }
      } catch(err){
        msg.className = 'mt-2 small text-danger';
        msg.textContent = 'Network error.';
      }
    });

    // --- Edit open ---
    async function openEdit(uid){
      try{
        const res = await fetch('/users/' + encodeURIComponent(uid) + '/json');
        const out = await res.json();
        if (!out.ok) { alert(out.error || 'Not found'); return; }
        const u = out.user;

        document.getElementById('editUid').value = u._id;
        document.getElementById('editUsername').value  = u.username || '';
        document.getElementById('editPosition').value  = u.position || '';
        document.getElementById('editPassword').value  = '';

        const access = u.access || {};
        document.querySelectorAll('#editForm input[type="checkbox"][name^="status_"]').forEach(function(sw){
          const slug = sw.name.replace('status_', '');
          sw.checked = !!access[slug];
        });

        new bootstrap.Modal(document.getElementById('editModal')).show();
      }catch(_e){
        alert('Failed to load user.');
      }
    }
    window.openEdit = openEdit;

    // --- Edit save ---
    document.getElementById('editForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const fm = e.currentTarget;
      const uid = document.getElementById('editUid').value;
      const fd = new FormData(fm);
      const pw = (fd.get('password') || '').trim();

      if(pw && !isStrongPassword(pw)){
        const msg = document.getElementById('editMsg');
        msg.className = 'px-3 pb-3 small text-danger';
        msg.textContent = 'Password is not strong. Use at least 10 chars incl. upper, lower, number & symbol.';
        return;
      }

      try{
        const res = await fetch('/users/' + encodeURIComponent(uid) + '/update', { method: 'POST', body: fd });
        const out = await res.json();
        const msg = document.getElementById('editMsg');
        if (out.ok) {
          msg.className = 'px-3 pb-3 small text-success';
          msg.textContent = 'Saved.';
          setTimeout(function(){ location.reload(); }, 500);
        } else {
          msg.className = 'px-3 pb-3 small text-danger';
          msg.textContent = out.error || 'Failed to save.';
        }
      }catch(_e){
        alert('Network error.');
      }
    });

    // --- Block / Unblock ---
    async function setStatus(uid, status){
      if(status === 'blocked' && !confirm('Block this user? They will be denied access.')) return;
      try{
        const res = await fetch('/users/' + encodeURIComponent(uid) + '/status', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ status })
        });
        const out = await res.json();
        if(out.ok){ location.reload(); }
        else { alert(out.error || 'Failed to update status.'); }
      }catch(_e){
        alert('Network error.');
      }
    }
    window.setStatus = setStatus;

    // --- Delete ---
    async function removeUser(uid){
      if (!confirm('Delete this admin user?')) return;
      try{
        const res = await fetch('/users/' + encodeURIComponent(uid) + '/delete', { method: 'POST' });
        const out = await res.json();
        if (out.ok) {
          const row = document.querySelector('tr[data-id="'+uid+'"]');
          if (row) row.remove();
        } else {
          alert(out.error || 'Failed to delete.');
        }
      }catch(_e){
        alert('Network error.');
      }
    }
    window.removeUser = removeUser;
  </script>
</body>
</html>
