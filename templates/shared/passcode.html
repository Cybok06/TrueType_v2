<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unlock | {{ bdc_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root {
      --ring: #3b82f6;
      --bg: #f6f8fb;
      --card: #ffffff;
      --muted: #64748b;
      --brand: #0b1320;
    }
    body { background: var(--bg); }
    .navbar-brand img { height: 36px; }
    .card {
      border: none; border-radius: 16px;
      box-shadow: 0 12px 32px rgba(2, 6, 23, .08);
      background: var(--card);
    }
    .title { font-weight: 700; color: var(--brand); }
    .subtitle { color: var(--muted); }

    /* Passcode cells */
    .code-row { display:flex; gap: .75rem; justify-content: center; }
    .code-input {
      width: 56px; height: 64px; border-radius: 14px;
      border: 1px solid #e2e8f0; background: #fff;
      text-align: center; font-size: 1.6rem; font-weight: 700;
      transition: box-shadow .15s, border-color .15s, transform .06s;
      -webkit-text-security: disc; /* mask like iOS */
    }
    .code-input:focus {
      outline: none;
      border-color: var(--ring);
      box-shadow: 0 0 0 .25rem rgba(59,130,246,.15);
      transform: translateY(-1px);
    }
    .code-input.show { -webkit-text-security: none; }
    @media (max-width: 420px) {
      .code-input { width: 50px; height: 60px; font-size: 1.4rem; }
    }

    .toggle-visibility {
      appearance: none; border: 1px solid #e2e8f0; background:#fff;
      border-radius: 999px; padding: .4rem .75rem; font-size:.875rem;
      color:#0f172a; cursor:pointer;
    }
    .toggle-visibility:focus { outline: 2px solid rgba(59,130,246,.3); }

    .error-box { border-radius: 10px; }
    footer { color:#94a3b8; font-size:.85rem; }
    .scope-pill { background:#0b1320; color:#fff; border-radius:999px; padding:.2rem .6rem; font-size:.85rem; }
    noscript .noscript-input { display:block; }
    .noscript-input { display:none; }
  </style>
</head>
<body>

<!-- Top Bar -->
<nav class="navbar navbar-light bg-white shadow-sm mb-4">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2 mx-auto" href="#">
      <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Company Logo">
      <span class="fw-semibold d-none d-sm-inline">TrueType Services</span>
    </a>
  </div>
</nav>

<!-- Main -->
<div class="container">
  <div class="row justify-content-center">
    <div class="col-12" style="max-width: 480px;">
      <div class="card p-4 p-sm-5">
        <div class="text-center mb-3">
          <h4 class="title mb-1">Shared Deliveries</h4>
          <!-- Scope label (can be “OMC: …”, “3 BDCs”, or a single BDC name) -->
          <div class="subtitle">Scope: <span class="scope-pill" title="Share scope">{{ bdc_name }}</span></div>
        </div>

        <p class="subtitle text-center mb-4">Enter the 5‑digit passcode to continue.</p>

        {% if error %}
          <div class="alert alert-danger error-box py-2 mb-3" role="alert" aria-live="assertive">{{ error }}</div>
        {% endif %}

        <!-- Form -->
        <form id="codeForm" method="post" action="{{ url_for('shared_links.shared_landing', token=token) }}" autocomplete="one-time-code" novalidate>
          <!-- Hidden field that receives the combined code before submit -->
          <input type="hidden" name="passcode" id="passcode" />

          <!-- Apple-like code inputs -->
          <div class="code-row mb-3" role="group" aria-label="Enter 5-digit passcode">
            <input class="code-input" id="d1" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" autocomplete="one-time-code" aria-label="Digit 1" required>
            <input class="code-input" id="d2" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 2" required>
            <input class="code-input" id="d3" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 3" required>
            <input class="code-input" id="d4" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 4" required>
            <input class="code-input" id="d5" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="Digit 5" required>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <small class="subtitle">Exactly 5 digits.</small>
            <button type="button" id="toggleMask" class="toggle-visibility" aria-pressed="false" aria-controls="d1 d2 d3 d4 d5">Show</button>
          </div>

          <!-- No-JS fallback field -->
          <div class="noscript-input">
            <label class="form-label">Passcode</label>
            <input type="password" name="passcode_noscript" class="form-control" pattern="\d{5}" maxlength="5" minlength="5" inputmode="numeric" placeholder="*****">
            <div class="form-text">If JavaScript is disabled, enter all 5 digits here.</div>
          </div>

          <button type="submit" class="btn btn-primary w-100" aria-label="Unlock shared deliveries">Unlock</button>
        </form>
      </div>

      <div class="text-center text-muted mt-3 small">
        © {{ (now() if now else None) or '' }} Oil ERP · Powered by CYTECH
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  (function () {
    const inputs = Array.from(document.querySelectorAll('.code-input'));
    const hidden = document.getElementById('passcode');
    const form = document.getElementById('codeForm');
    const toggle = document.getElementById('toggleMask');

    // focus first on load when JS is enabled
    if (inputs.length) inputs[0].focus();

    // Enforce digits only, auto-advance, and backspace behavior
    inputs.forEach((inp, idx) => {
      inp.addEventListener('input', () => {
        inp.value = (inp.value || '').replace(/\D/g, '').slice(0,1);
        if (inp.value && idx < inputs.length - 1) inputs[idx + 1].focus();
        maybeSubmit();
      });

      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus();
        if (e.key === 'ArrowLeft' && idx > 0) inputs[idx - 1].focus();
        if (e.key === 'ArrowRight' && idx < inputs.length - 1) inputs[idx + 1].focus();
      });

      // Handle paste of all 5 digits at once
      inp.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text') || '';
        const digits = text.replace(/\D/g, '').slice(0, 5).split('');
        if (!digits.length) return;
        inputs.forEach((el, i) => el.value = digits[i] || '');
        (digits.length < 5 ? inputs[digits.length] : inputs[inputs.length - 1]).focus();
        maybeSubmit();
      });
    });

    // Show/Hide toggle for all cells
    toggle.addEventListener('click', () => {
      const showing = inputs[0].classList.toggle('show');
      for (let i = 1; i < inputs.length; i++) inputs[i].classList.toggle('show', showing);
      toggle.textContent = showing ? 'Hide' : 'Show';
      toggle.setAttribute('aria-pressed', showing ? 'true' : 'false');
    });

    // Build hidden value and submit when all 5 filled
    function maybeSubmit() {
      const code = inputs.map(i => i.value).join('');
      hidden.value = code;
      if (code.length === 5) {
        // small delay gives visual confirmation of last digit
        setTimeout(() => form.requestSubmit(), 80);
      }
    }

    // On manual submit, ensure hidden is set; fallback if JS-only cells are empty
    form.addEventListener('submit', (e) => {
      const code = inputs.map(i => i.value).join('');
      const noscript = document.querySelector('input[name="passcode_noscript"]');
      if (code.length === 5) {
        hidden.value = code;
      } else if (noscript && noscript.value && /^\d{5}$/.test(noscript.value)) {
        hidden.value = noscript.value;
      } else {
        e.preventDefault();
      }
    });
  })();
</script>
</body>
</html>
