<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Share Link Created | Oil ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon + Brand -->
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body { background:#f6f8fb; }
    .navbar-brand img { height: 36px; }
    .page-wrap { max-width: 960px; margin-inline: auto; }
    .card { border: none; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    .muted { color:#64748b; }
    .chip { background:#eef2ff; color:#3b82f6; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; }
    .copy-group .form-control { background:#fff; }
    .btn-icon { display:inline-flex; align-items:center; gap:.5rem; }
    .scope-pill { background:#0b1320; color:#fff; border-radius:999px; padding:.2rem .5rem; font-size:.8rem; }
    .note { font-size:.925rem; }
  </style>
</head>
<body>

<!-- Top Bar -->
<nav class="navbar navbar-light bg-white shadow-sm">
  <div class="container-fluid page-wrap">
    <a class="navbar-brand d-flex align-items-center gap-2" href="#">
      <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Company Logo">
      <span class="fw-semibold d-none d-sm-inline">TrueType Services</span>
    </a>
    <span class="chip">Admin • Share Link</span>
  </div>
</nav>

<!-- Content -->
<main class="page-wrap py-4 px-3 px-sm-2">
  <div class="row justify-content-center">
    <div class="col-lg-9">
      <div class="card">
        <div class="card-body p-4 p-sm-5">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <h4 class="mb-0">Share Link Created</h4>
            <small class="muted">Send the URL + 5‑digit passcode privately</small>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-12 col-md-4">
              <div class="small muted">Scope</div>
              <!-- bdc_name is a friendly scope label (e.g., "OMC: Total", "3 BDCs", or "BCD One") -->
              <div class="fs-6 fw-semibold">
                <span class="scope-pill" title="Scope label">{{ bdc_name }}</span>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="small muted">Passcode</div>
              <div class="d-flex align-items-center gap-2">
                <code class="fs-6">{{ passcode }}</code>
                <button class="btn btn-sm btn-outline-secondary btn-icon" type="button" id="copyPass">
                  Copy
                </button>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="small muted">Expires</div>
              <div class="fs-6">{{ expires_at.strftime('%Y-%m-%d %H:%M UTC') }}</div>
            </div>
          </div>

          <!-- URL Copy -->
          <div class="copy-group mb-3">
            <label class="form-label fw-semibold">Shared URL</label>
            <div class="input-group">
              <input id="shareUrl" type="text" class="form-control" value="{{ shared_url }}" readonly>
              <button class="btn btn-outline-primary btn-icon" type="button" id="copyUrl">Copy URL</button>
            </div>
            <div class="form-text note">
              Anyone with this link can unlock with the passcode and update deliveries within: <strong>{{ bdc_name }}</strong>.
            </div>
          </div>

          <!-- Actions -->
          <div class="d-flex flex-wrap gap-2">
            <a href="{{ shared_url }}" class="btn btn-success btn-icon" target="_blank" rel="noopener">Open Shared Page</a>

            <!-- Revoke: expects 'token' provided by backend -->
            <form method="post" action="{{ url_for('shared_links.revoke_share_link', token=token) }}"
                  onsubmit="return confirm('Revoke this link? This cannot be undone.');">
              <button type="submit" class="btn btn-outline-danger btn-icon">Revoke Link</button>
            </form>

            <button class="btn btn-outline-secondary btn-icon" type="button" id="copyBoth">Copy URL + Passcode</button>
            <a href="{{ url_for('shared_links.new_share_link_form') }}" class="btn btn-secondary btn-icon">Create Another</a>
          </div>

          <hr class="my-4">
          <p class="muted mb-0">
            <strong>Tip:</strong> Share the URL and passcode via a secure channel (e.g., SMS or WhatsApp DM). You can revoke the link anytime from this page.
          </p>
        </div>
      </div>

      <div class="text-center text-muted mt-3 small">
        © {{ (now() if now else None) or '' }} Oil ERP · Powered by CYTECH
      </div>
    </div>
  </div>
</main>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Copied!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function showToast(msg, success = true) {
    const toastEl = document.getElementById('copyToast');
    const body = document.getElementById('toastBody');
    body.textContent = msg;
    toastEl.classList.remove('text-bg-success','text-bg-danger');
    toastEl.classList.add(success ? 'text-bg-success' : 'text-bg-danger');
    new bootstrap.Toast(toastEl, { delay: 2200 }).show();
  }

  async function copyText(text) {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch (_) {}
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    let ok = false;
    try { ok = document.execCommand('copy'); } catch(_) { ok = false; }
    document.body.removeChild(ta);
    return ok;
  }

  // Copy URL
  document.getElementById('copyUrl').addEventListener('click', async () => {
    const url = document.getElementById('shareUrl').value;
    const ok = await copyText(url);
    showToast(ok ? 'URL copied to clipboard' : 'Copy failed', ok);
  });

  // Copy Passcode
  document.getElementById('copyPass').addEventListener('click', async () => {
    const ok = await copyText('{{ passcode }}');
    showToast(ok ? 'Passcode copied' : 'Copy failed', ok);
  });

  // Copy both URL + Passcode (formatted)
  document.getElementById('copyBoth').addEventListener('click', async () => {
    const text = `Scope: {{ bdc_name }}\nURL: {{ shared_url }}\nPasscode: {{ passcode }}\nExpires: {{ expires_at.strftime('%Y-%m-%d %H:%M UTC') }}`;
    const ok = await copyText(text);
    showToast(ok ? 'URL + Passcode copied' : 'Copy failed', ok);
  });
</script>
</body>
</html>
