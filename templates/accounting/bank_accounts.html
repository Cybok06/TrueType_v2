<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bank &amp; Cash Accounts - TRUEtype Services</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#0f172a",
            "accent": "#16a34a",
            "background-light": "#f9fafb",
            "background-dark": "#111827",
            "neutral-border": "#e5e7eb",
            "neutral-text-dark": "#111827",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.5rem",
            "lg": "1rem",
            "xl": "18px",
            "full": "9999px"
          },
          boxShadow: {
            card: "0 10px 30px rgba(15,23,42,0.08)"
          }
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24;
    }
  </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-neutral-text-dark dark:text-gray-200">
  {% include 'accounting/sidebar.html' %}

  <main class="min-h-screen p-6 lg:p-10">
    <div class="max-w-7xl mx-auto">
      <!-- PageHeading & ButtonGroup -->
      <header class="flex flex-col sm:flex-row flex-wrap justify-between items-start gap-4 mb-8">
        <div class="space-y-1">
          <h1 class="text-primary dark:text-white text-4xl font-black tracking-[-0.033em]">
            Bank &amp; Cash Accounts
          </h1>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Live balances from confirmed payments, P-Tax and BDC movements.
          </p>
        </div>

        <div class="flex flex-wrap gap-3 justify-center sm:justify-end">
          <div class="hidden sm:flex flex-col items-end text-sm text-gray-600 dark:text-gray-300">
            <span class="font-medium">Total live balance:</span>
            <span class="text-lg font-bold text-primary dark:text-white">
              {{ total_display or '' }}
            </span>
          </div>

          <a
            href="{{ export_url if export_url is defined else '#' }}"
            class="flex items-center justify-center gap-2 min-w-[84px] cursor-pointer overflow-hidden rounded-xl h-11 px-4 bg-transparent text-primary dark:text-gray-200 border-2 border-primary dark:border-gray-200 text-sm font-bold hover:bg-primary/5 dark:hover:bg-white/10 transition-colors"
          >
            <span class="material-symbols-outlined text-xl">description</span>
            <span class="truncate">Export CSV</span>
          </a>

          <button
            type="button"
            id="btnAddBankAccount"
            class="flex items-center justify-center gap-2 min-w-[84px] cursor-pointer overflow-hidden rounded-xl h-11 px-5 bg-accent text-white text-sm font-bold shadow-sm hover:bg-accent/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent transition-colors"
          >
            <span class="material-symbols-outlined text-xl">add</span>
            <span class="truncate">Add Bank Account</span>
          </button>
        </div>
      </header>

      <!-- Summary strip for mobile total -->
      <div class="sm:hidden mb-4">
        <div class="rounded-xl border border-neutral-border bg-white/80 backdrop-blur shadow-sm px-4 py-3 flex items-center justify-between">
          <span class="text-xs font-medium text-gray-500">Total live balance</span>
          <span class="text-base font-bold text-primary">
            {{ total_display or '' }}
          </span>
        </div>
      </div>

      <!-- Account Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 @container">
        {% for acc in accounts %}
          <article class="flex flex-col rounded-xl shadow-card bg-white dark:bg-primary/10 border border-transparent dark:border-white/10 p-5">
            <header class="flex items-start justify-between gap-3">
              <div>
                <p class="text-primary dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">
                  {{ acc.account_name or 'Unnamed Account' }}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  {{ acc.bank_name or '—' }}{% if acc.account_no_masked or acc.account_no %}
                    • {{ acc.account_no_masked or acc.account_no }}
                  {% endif %}
                </p>
              </div>
              <span class="inline-flex items-center rounded-full bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-200 px-3 py-1 text-[11px] font-medium">
                {{ acc.currency or 'GHS' }}
              </span>
            </header>

            <!-- Main balance -->
            <div class="mt-4 flex items-end justify-between gap-3">
              <div class="flex flex-col gap-1">
                <p class="text-primary dark:text-gray-100 text-2xl font-bold leading-normal">
                  {{ acc.currency_symbol or '' }}{{ "%.2f"|format(acc.balance or 0) }}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400">
                  Last reconciled:
                  {% if acc.last_reconciled %}
                    {{ acc.last_reconciled.strftime('%d %b, %Y') if acc.last_reconciled.__class__.__name__ == 'datetime' else acc.last_reconciled }}
                  {% else %}
                    <span class="italic">Not yet reconciled</span>
                  {% endif %}
                </p>
              </div>

              <div class="flex flex-col gap-2 items-end">
                <a
                  href="{{ url_for('bank_recon.view', account_id=acc.id) }}"
                  class="flex items-center justify-center min-w-[84px] cursor-pointer overflow-hidden rounded-xl h-9 px-4 bg-accent text-white text-xs sm:text-sm font-medium hover:bg-accent/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent transition-colors"
                >
                  Reconcile
                </a>
                <a
                  href="{{ url_for('bank_profile.bank_profile', bank_id=acc.id) }}"
                  class="flex items-center justify-center min-w-[84px] cursor-pointer overflow-hidden rounded-xl h-8 px-3 bg-slate-50 text-slate-700 dark:bg-slate-800 dark:text-slate-200 text-[11px] font-medium hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                >
                  <span class="material-symbols-outlined text-sm">insights</span>
                  <span class="ml-1 hidden sm:inline">View Profile</span>
                </a>
              </div>
            </div>

            <!-- Metrics row -->
            <div class="mt-4 grid grid-cols-3 gap-2 border-t border-dashed border-neutral-border/80 pt-3">
              <div class="flex flex-col">
                <span class="text-[10px] uppercase tracking-wide text-gray-400">Confirmed In</span>
                <span class="text-sm font-semibold text-emerald-700 dark:text-emerald-300">
                  {{ acc.currency_symbol or '' }}
                  {{ "%.2f"|format(acc.metrics.total_in if acc.metrics is defined else 0) }}
                </span>
              </div>
              <div class="flex flex-col">
                <span class="text-[10px] uppercase tracking-wide text-gray-400">P-Tax Out</span>
                <span class="text-sm font-semibold text-amber-700 dark:text-amber-300">
                  {{ acc.currency_symbol or '' }}
                  {{ "%.2f"|format(acc.metrics.ptax_out if acc.metrics is defined else 0) }}
                </span>
              </div>
              <div class="flex flex-col">
                <span class="text-[10px] uppercase tracking-wide text-gray-400">BDC Out</span>
                <span class="text-sm font-semibold text-rose-700 dark:text-rose-300">
                  {{ acc.currency_symbol or '' }}
                  {{ "%.2f"|format(acc.metrics.bdc_out if acc.metrics is defined else 0) }}
                </span>
              </div>
            </div>
          </article>
        {% else %}
          <div class="col-span-full">
            <div class="rounded-2xl border border-dashed border-neutral-border bg-white/60 dark:bg-slate-900/40 px-6 py-10 text-center">
              <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                No bank or cash accounts added yet.
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">
                Create your first bank account to start tracking balances and reconcile statements.
              </p>
              <button
                type="button"
                id="btnAddBankAccountEmpty"
                class="inline-flex items-center justify-center gap-2 min-w-[120px] rounded-full h-10 px-6 bg-accent text-white text-sm font-semibold shadow-sm hover:bg-accent/90 transition-colors"
              >
                <span class="material-symbols-outlined text-base">add</span>
                <span>Add Bank Account</span>
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </main>

  <!-- Add Bank Account Modal -->
  <div
    id="bankModalBackdrop"
    class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden"
  >
    <div class="bg-white dark:bg-primary w-full max-w-lg rounded-xl shadow-2xl p-6 sm:p-8 relative">
      <div class="flex justify-between items-start mb-6 gap-3">
        <div>
          <h2 class="text-xl sm:text-2xl font-bold text-primary dark:text-white">
            Add New Bank Account
          </h2>
          <p class="text-xs text-gray-500 dark:text-gray-300 mt-1">
            Store bank details and opening balance for reconciliation.
          </p>
        </div>
        <button
          type="button"
          id="bankModalClose"
          class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
        >
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <form id="bankAccountForm" class="space-y-5">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="account-name">
              Account Name
            </label>
            <input
              class="w-full h-11 px-4 rounded-xl border-neutral-border dark:border-white/20 bg-transparent dark:text-white focus:ring-accent focus:border-accent text-sm"
              id="account-name"
              name="account_name"
              placeholder="e.g., Main Checking Account"
              type="text"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="bank-name">
              Bank Name
            </label>
            <input
              class="w-full h-11 px-4 rounded-xl border-neutral-border dark:border-white/20 bg-transparent dark:text-white focus:ring-accent focus:border-accent text-sm"
              id="bank-name"
              name="bank_name"
              placeholder="e.g., Stanbic Bank"
              type="text"
              required
            />
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="account-number">
              Account Number
            </label>
            <input
              class="w-full h-11 px-4 rounded-xl border-neutral-border dark:border-white/20 bg-transparent dark:text-white focus:ring-accent focus:border-accent text-sm"
              id="account-number"
              name="account_no"
              placeholder="Enter account number"
              type="text"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="currency">
              Currency
            </label>
            <select
              class="w-full h-11 px-3 rounded-xl border-neutral-border dark:border-white/20 bg-transparent dark:text-white dark:[color-scheme:dark] focus:ring-accent focus:border-accent text-sm"
              id="currency"
              name="currency"
            >
              <option value="GHS" selected>GHS - Ghana Cedi</option>
              <option value="USD">USD - US Dollar</option>
              <option value="EUR">EUR - Euro</option>
              <option value="GBP">GBP - British Pound</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="opening-balance">
              Opening Balance
            </label>
            <input
              class="w-full h-11 px-4 rounded-xl border-neutral-border dark:border-white/20 bg-transparent dark:text-white focus:ring-accent focus:border-accent text-sm"
              id="opening-balance"
              name="opening_balance"
              placeholder="0.00"
              type="number"
              step="0.01"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="as-of-date">
              As of Date
            </label>
            <input
              class="w-full h-11 px-4 rounded-xl border-neutral-border dark:border-white/20 bg-transparent dark:text-white focus:ring-accent focus:border-accent text-sm"
              id="as-of-date"
              name="as_of_date"
              type="date"
              value="{{ today or '' }}"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="notes">
            Notes (optional)
          </label>
          <textarea
            id="notes"
            name="notes"
            rows="3"
            class="w-full px-4 py-2 rounded-xl border-neutral-border dark:border-white/20 bg-transparent dark:text-white focus:ring-accent focus:border-accent text-sm"
            placeholder="Any details about this bank account…"
          ></textarea>
        </div>

        <div class="flex justify-between items-center pt-2">
          <span class="flex items-center gap-1 text-xs text-accent cursor-pointer">
            <span>Link to GL account later in Settings</span>
          </span>
          <div class="flex justify-end gap-3">
            <button
              type="button"
              id="bankModalCancel"
              class="min-w-[84px] rounded-xl h-10 px-6 bg-transparent text-primary dark:text-gray-200 border-2 border-primary dark:border-gray-200 text-sm font-bold hover:bg-primary/5 dark:hover:bg-white/10 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              id="bankFormSubmit"
              class="min-w-[110px] rounded-xl h-10 px-6 bg-accent text-white text-sm font-bold shadow-sm hover:bg-accent/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent transition-colors inline-flex items-center justify-center gap-2"
            >
              <span class="material-symbols-outlined text-base hidden" id="bankFormSpinner">sync</span>
              <span>Save Account</span>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const openBtns = [
        document.getElementById('btnAddBankAccount'),
        document.getElementById('btnAddBankAccountEmpty')
      ].filter(Boolean);
      const backdrop = document.getElementById('bankModalBackdrop');
      const closeBtn = document.getElementById('bankModalClose');
      const cancelBtn = document.getElementById('bankModalCancel');
      const form     = document.getElementById('bankAccountForm');
      const submitBtn = document.getElementById('bankFormSubmit');
      const spinner   = document.getElementById('bankFormSpinner');

      function openModal(){
        backdrop.classList.remove('hidden');
      }
      function closeModal(){
        backdrop.classList.add('hidden');
        if (form) form.reset();
      }

      openBtns.forEach(btn => btn.addEventListener('click', openModal));
      closeBtn?.addEventListener('click', closeModal);
      cancelBtn?.addEventListener('click', closeModal);
      backdrop?.addEventListener('click', (e)=>{
        if(e.target === backdrop) closeModal();
      });
      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') closeModal();
      });

      form?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        submitBtn.disabled = true;
        if (spinner) spinner.classList.remove('hidden');

        const fd = new FormData(form);

        try{
          const resp = await fetch("{{ url_for('acc_bank_accounts.quick_create') }}", {
            method: "POST",
            body: fd
          });
          const data = await resp.json().catch(()=>({}));

          if(!resp.ok || !data.ok){
            alert(data.message || "Failed to save bank account.");
          }else{
            closeModal();
            window.location.reload();
          }
        }catch(err){
          console.error(err);
          alert("An error occurred while saving the bank account.");
        }finally{
          submitBtn.disabled = false;
          if (spinner) spinner.classList.add('hidden');
        }
      });
    })();
  </script>

</body>
</html>
