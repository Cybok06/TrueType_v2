<!-- templates/prices/board.html -->
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BDC Price Board</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Chart.js + date adapter for time axis -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png">

  <style>
    :root{
      /* Light */
      --bg:#f6f8fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --pms:#2563eb; --ago:#16a34a; --accent:#0ea5e9; --up:#22c55e; --down:#ef4444;
      --badge:#0f172a; --chip-border:rgba(0,0,0,.08);
      --shadow:0 2px 10px rgba(0,0,0,.06);
      --modal-bg:#ffffff; --spinner:#0f172a; --footer-text:#334155;
      --select-bg:#fff; --select-text:#0f172a; --select-border:#cbd5e1;
      --skeleton:#e5e7eb;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --pms:#3b82f6; --ago:#22c55e; --accent:#06b6d4; --up:#22c55e; --down:#ef4444;
      --badge:#e5e7eb; --chip-border:rgba(255,255,255,.12);
      --shadow:0 6px 24px rgba(0,0,0,.35);
      --modal-bg:#0f172a; --spinner:#e5e7eb; --footer-text:#94a3b8;
      --select-bg:#0b1220; --select-text:#e5e7eb; --select-border:#334155;
      --skeleton:#1f2937;
    }

    *{ box-sizing:border-box }
    body{ background:var(--bg); color:var(--ink); }

    .page-head{ display:flex; gap:1rem; align-items:center; justify-content:space-between; flex-wrap:wrap }
    .toolbar{ gap:.5rem; display:flex; flex-wrap:wrap }

    .theme-toggle{ border:1px solid var(--line); background:var(--card); color:var(--ink); }
    .form-select, .form-control{
      background:var(--select-bg); color:var(--select-text); border-color:var(--select-border);
    }

    /* Top charts row */
    .top-charts{ margin-bottom:1rem; }
    .chart-card{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:16px;
      padding:0.75rem 0.75rem 0.5rem;
      box-shadow:var(--shadow);
      min-height: 260px;
      display:flex; flex-direction:column;
    }
    .chart-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:0 .25rem .25rem; color:var(--muted);
      font-size:.9rem; font-weight:600;
      gap:.75rem; flex-wrap:wrap;
    }
    .chart-wrap{ position:relative; flex:1; min-height:180px; }

    /* Cards */
    .bdc-card{
      border:1px solid var(--line); background:var(--card);
      border-radius:16px; padding:1rem; height:100%;
      box-shadow:var(--shadow);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .bdc-card:hover{ transform:translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,.15); }
    [data-theme="dark"] .bdc-card:hover{ box-shadow:0 10px 30px rgba(0,0,0,.45); }

    .bdc-top{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:.5rem; }
    .bdc-id{ display:flex; align-items:center; gap:.6rem; font-weight:700; letter-spacing:.2px; }
    .bdc-avatar{
      width:34px; height:34px; border-radius:10px;
      display:grid; place-items:center; font-weight:800;
      color:var(--badge); background:linear-gradient(135deg, #e2e8f0, var(--accent));
      border:1px solid var(--line);
      flex:0 0 auto;
    }
    [data-theme="dark"] .bdc-avatar{ color:#e5e7eb; background:linear-gradient(135deg, #1e293b, var(--accent)); }
    .stamp{ color:var(--muted); font-size:.82rem; white-space:nowrap }

    .row-price{
      display:grid; grid-template-columns: auto 1fr auto; align-items:center; gap:.5rem; margin:.15rem 0 .2rem;
    }
    .product-chip{
      font-size:.72rem; font-weight:800; padding:.18rem .55rem; border-radius:8px; border:1px solid var(--chip-border)
    }
    .chip-pms{ background:color-mix(in srgb, var(--pms) 14%, transparent); color:color-mix(in srgb, var(--pms) 40%, #fff); }
    .chip-ago{ background:color-mix(in srgb, var(--ago) 14%, transparent); color:color-mix(in srgb, var(--ago) 40%, #fff); }

    .price-xl{ text-align:right; font-size:1.9rem; font-weight:900; letter-spacing:.2px; }
    .price-xl .ccy{ font-size:.95rem; font-weight:800; color:var(--muted); margin-right:.25rem; }

    .delta{ font-size:.82rem; font-weight:700; padding:.15rem .45rem; border-radius:8px; border:1px solid var(--chip-border) }
    .delta.up{ color:var(--up); background:color-mix(in srgb, var(--up) 12%, transparent) }
    .delta.down{ color:var(--down); background:color-mix(in srgb, var(--down) 12%, transparent) }
    .delta.flat{ color:var(--pms); background:color-mix(in srgb, var(--pms) 10%, transparent) }
    .delta.na{ color:var(--muted); background:transparent; border-style:dashed }

    .meta{ color:var(--muted); font-size:.82rem; display:flex; gap:.6rem; flex-wrap:wrap; margin:.1rem 0 .35rem; }
    .meta .dot{ opacity:.5 }

    .spark-wrap{ height:60px; margin-top:.25rem; }
    canvas.spark{ width:100% !important; height:60px !important; display:block; }

    .last3{ display:flex; gap:.35rem; flex-wrap:wrap; margin-top:.35rem; }
    .pill{
      border:1px solid var(--chip-border); border-radius:999px; padding:.15rem .45rem; font-size:.75rem; font-weight:700;
      background:var(--card); color:var(--ink);
    }
    .pill time{ color:var(--muted); font-weight:600; margin-left:.25rem; }

    .empty{
      border:1px dashed var(--line); border-radius:12px; background:var(--card);
      padding:2rem; text-align:center; color:var(--muted);
    }

    /* Spinner overlay */
    .spinner-overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.08); z-index:2000
    }
    [data-theme="dark"] .spinner-overlay{ background:rgba(11,18,32,.65) }
    .spinner-overlay.show{ display:flex }
    .spinner-border{ color:var(--spinner) }

    /* Footer */
    .app-footer{
      margin-top: 22px; padding: 12px 8px; text-align:center; color: var(--footer-text);
      display:flex; align-items:center; justify-content:center; gap:.6rem; flex-wrap:wrap;
    }
    .app-footer img{ height:22px; width:auto; border-radius:6px; border:1px solid var(--line); background:#fff; }

    /* Skeletons */
    .skeleton{ position:relative; overflow:hidden; background:var(--card); border:1px solid var(--line); border-radius:16px; min-height:120px; }
    .skeleton::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, transparent, color-mix(in srgb, var(--skeleton) 40%, transparent), transparent);
      animation: shimmer 1.2s infinite;
    }
    @media (prefers-reduced-motion: reduce){ .skeleton::after{ animation: none; } }
    @keyframes shimmer{ to { transform:translateX(100%); } }

    /* Responsive tweaks */
    @media (max-width: 575.98px){
      .price-xl{ font-size:1.6rem; }
    }
  </style>
</head>
<body class="p-2 p-sm-3" data-token="{{ token or '' }}" data-shared="{{ '1' if shared_view else '0' }}">
  <div class="page-head mb-2">
    <div>
      <h4 class="mb-1">BDC Price Board</h4>
      <div class="text-muted">
        {% if shared_view and shared_bdc_name %}
          Shared view for <strong>{{ shared_bdc_name }}</strong>
        {% else %}
          Live PMS/AGO prices from participating BDCs
        {% endif %}
      </div>
    </div>
    <div class="toolbar">
      <button id="themeToggle" class="btn btn-sm theme-toggle">Toggle Theme</button>

      <!-- NEW: free text search -->
      <input id="searchBox" type="search" class="form-control form-control-sm" placeholder="Search BDC, location, note‚Ä¶" style="min-width:220px" />

      <!-- Existing product filter -->
      <select id="productFilter" class="form-select form-select-sm">
        <option value="ALL" selected>All Products</option>
        <option value="PMS">PMS</option>
        <option value="AGO">AGO</option>
      </select>

      <!-- NEW: location filter (populated dynamically) -->
      <select id="locationFilter" class="form-select form-select-sm">
        <option value="__ALL__" selected>All Locations</option>
      </select>

      <select id="sortBy" class="form-select form-select-sm">
        <option value="updated_desc" selected>Newest update</option>
        <option value="price_desc">Highest price</option>
        <option value="price_asc">Lowest price</option>
      </select>

      {% if not shared_view %}
      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#shareModal">Share</button>
      {% endif %}
    </div>
  </div>

  <!-- TOP CHARTS -->
  <div class="top-charts row g-3">
    <div class="col-12 col-lg-6">
      <div class="chart-card">
        <div class="chart-head">
          <span>Prices ‚Ä¢ <strong>PMS</strong> (ranked high ‚Üí low)</span>
          <span id="pmsInfo" class="small"></span>
        </div>
        <div class="chart-wrap">
          <canvas id="topPMS"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="chart-card">
        <div class="chart-head">
          <span>Prices ‚Ä¢ <strong>AGO</strong> (ranked high ‚Üí low)</span>
          <span id="agoInfo" class="small"></span>
        </div>
        <div class="chart-wrap">
          <canvas id="topAGO"></canvas>
        </div>
      </div>
    </div>
  </div>

  {% if not shared_view %}
  <!-- Share Modal -->
  <div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="background:var(--modal-bg); color:var(--ink); border:1px solid var(--line)">
        <div class="modal-header">
          <h5 class="modal-title">Share posting link to a BDC</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Select BDC</label>
            <select id="shareBdc" class="form-select">
              <option value="">Choose‚Ä¶</option>
              {% for b in bdcs %}
                <option value="{{ b._id }}">{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div id="shareResult" class="small text-muted"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="genShareBtn" class="btn btn-primary">Generate & Share</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div id="alertBox" class="mb-2"></div>

  <!-- GRID -->
  <div id="grid" class="row g-3">
    <div class="col-12 col-md-6 col-lg-4"><div class="skeleton"></div></div>
    <div class="col-12 col-md-6 col-lg-4"><div class="skeleton"></div></div>
    <div class="col-12 col-md-6 col-lg-4"><div class="skeleton"></div></div>
  </div>

  <div class="app-footer">
    Powered by Truetype Services
    <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Truetype Services Logo">
  </div>

  <div class="spinner-overlay" id="pageSpinner"><div class="spinner-border"></div></div>

<script>
(() => {
  const POLL_MS = 10000;
  const HISTORY_POINTS = 60;
  const qsToken = document.body.dataset.token || "";
  const sharedFlag = document.body.dataset.shared === "1";
  const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;

  // THEME
  const themeToggle = document.getElementById('themeToggle');
  let lastData = null;

  function setTheme(mode){
    document.documentElement.setAttribute('data-theme', mode);
    try{ localStorage.setItem('tt_theme', mode); }catch(e){}
    drawTopCharts(lastData);
  }
  (function initTheme(){
    const saved = (localStorage.getItem('tt_theme') || '').toLowerCase();
    if(saved === 'light' || saved === 'dark'){ setTheme(saved); }
  })();
  themeToggle?.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    setTheme(cur === 'dark' ? 'light' : 'dark');
  });

  // DOM
  const $grid = document.getElementById('grid');
  const $alert = document.getElementById('alertBox');
  const $spinner = document.getElementById('pageSpinner');
  const $pmsInfo = document.getElementById('pmsInfo');
  const $agoInfo = document.getElementById('agoInfo');
  const $searchBox = document.getElementById('searchBox');
  const $locFilter = document.getElementById('locationFilter');
  const $prodFilter = document.getElementById('productFilter');
  const $sortBy = document.getElementById('sortBy');

  // Charts
  let pollTimer = null;
  let fetchController = null;
  const charts = new Map();
  let topPMSChart = null;
  let topAGOChart = null;

  function showSpinner(v=true){ $spinner.classList.toggle('show', v); }
  function alertMsg(msg, type='info'){
    $alert.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${msg}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
  }
  function initials(name){
    if(!name) return 'BD';
    const parts = String(name).trim().split(/\s+/).slice(0,2);
    return parts.map(p=>p[0]?.toUpperCase()||'').join('') || 'BD';
  }
  function fmt(n){ n = Number(n); return Number.isFinite(n)
    ? n.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:3}) : '0.00'; }
  function fmt4(n){ n = Number(n); return Number.isFinite(n)
    ? n.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:4}) : '0.00'; }
  function pct(n){
    if(n === null || n === undefined || Number.isNaN(Number(n))) return '‚Äî';
    const sign = n>0?'+':''; return `${sign}${Number(n).toFixed(2)}%`;
  }
  function timeAgo(iso){
    try{
      const t = new Date(iso); const s = (Date.now()-t.getTime())/1000;
      if(s<60) return 'just now';
      if(s<3600) return Math.floor(s/60)+'m ago';
      if(s<86400) return Math.floor(s/3600)+'h ago';
      return t.toLocaleString();
    }catch(e){ return '‚Äî'; }
  }
  function changeBadge(change){
    if(!change || change.abs === null || change.pct === null) return `<span class="delta na">‚Äî</span>`;
    const dir = change.dir || (change.abs>0?'up':(change.abs<0?'down':'flat'));
    const cls = (dir==='up')?'up':(dir==='down')?'down':(dir==='flat')?'flat':'na';
    const arrow = (dir==='up')?'‚Üë':(dir==='down')?'‚Üì':'‚Ä¢';
    return `<span class="delta ${cls}">${arrow} ${pct(change.pct)}</span>`;
  }
  function lastThreePills(recent3){
    if(!recent3 || !recent3.length) return '';
    return `<div class="last3">${
      recent3.map(p => `<span class="pill">GHS ${fmt4(p.price)} <time>${timeAgo(p.time)}</time></span>`).join('')
    }</div>`;
  }

  // ---- Filters helpers
  function currentProductsParam(){
    const pf = $prodFilter.value;
    if (pf === 'ALL') return 'PMS,AGO';
    return pf;
  }
  function normalizeLoc(v){ return (v || '').trim(); }
  function getActiveLocation(){ return $locFilter.value || '__ALL__'; }
  function getSearchTerm(){ return ($searchBox.value || '').toLowerCase().trim(); }

  // ---- Populate location filter from data (unique list of current locations)
  function populateLocations(data){
    const prev = $locFilter.value || '__ALL__';
    const set = new Set();
    let hasUnspecified = false;

    (data?.bdcs || []).forEach(b => {
      ['PMS','AGO'].forEach(prod => {
        const cur = b?.prices?.[prod]?.current;
        if(!cur) return;
        const loc = normalizeLoc(cur.location);
        if(loc) set.add(loc); else hasUnspecified = true;
      });
    });

    const opts = [`<option value="__ALL__">All Locations</option>`];
    if (hasUnspecified) opts.push(`<option value="__UNSPEC__">(Unspecified)</option>`);
    Array.from(set).sort((a,b)=>a.localeCompare(b)).forEach(loc => {
      opts.push(`<option value="${loc.replace(/"/g,'&quot;')}">${loc}</option>`);
    });

    $locFilter.innerHTML = opts.join('');
    // restore selection if still present
    const stillThere = Array.from($locFilter.options).some(o => o.value === prev);
    $locFilter.value = stillThere ? prev : '__ALL__';
  }

  // ---- Card template with location/description lines
  function productBlock(item, prod, chipClass){
    const cur = item?.prices?.[prod]?.current;
    if(!cur) return '';

    const chg = item.prices[prod].change;
    const r3  = item.prices[prod].recent3 || [];

    const loc = normalizeLoc(cur.location) || '(Unspecified)';
    const desc = (cur.description || '').trim();

    return `
      <div class="row-price">
        <span class="product-chip ${chipClass}">${prod}</span>
        <div class="price-xl"><span class="ccy">GHS</span>${fmt(cur.price)}</div>
        <div>${changeBadge(chg)}</div>
      </div>
      <div class="meta">
        <span>üìç ${loc}</span>
        ${desc ? `<span class="dot">‚Ä¢</span><span title="${desc}">üìù ${desc}</span>` : ``}
      </div>
      ${lastThreePills(r3)}
      <div class="spark-wrap"><canvas class="spark" data-key="${item._id}-${prod}"></canvas></div>
    `;
  }

  function cardTemplate(item){
    const pf = $prodFilter.value;
    const activeLoc = getActiveLocation();
    const q = getSearchTerm();

    // Per-product visibility based on product filter + location + search
    function match(prod){
      if (pf !== 'ALL' && pf !== prod) return false;
      const cur = item?.prices?.[prod]?.current; if(!cur) return false;

      // location filter
      const loc = normalizeLoc(cur.location);
      if (activeLoc !== '__ALL__') {
        if (activeLoc === '__UNSPEC__' && loc) return false;
        if (activeLoc !== '__UNSPEC__' && loc !== activeLoc) return false;
      }

      // search filter (BDC name, location, description)
      if (q) {
        const hay = [
          String(item?.name || '').toLowerCase(),
          String(loc || '').toLowerCase(),
          String(cur?.description || '').toLowerCase()
        ].join(' ');
        if (!hay.includes(q)) return false;
      }
      return true;
    }

    const showPMS = match('PMS');
    const showAGO = match('AGO');
    if (!showPMS && !showAGO) return '';

    // last updated stamp (max across shown products)
    const times = [];
    if (showPMS) times.push(item?.prices?.PMS?.current?.time);
    if (showAGO) times.push(item?.prices?.AGO?.current?.time);
    const lastISO = times.filter(Boolean).map(t=>new Date(t).getTime()).reduce((a,b)=>Math.max(a,b),0);

    return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="bdc-card">
          <div class="bdc-top">
            <div class="bdc-id">
              <div class="bdc-avatar">${initials(item.name)}</div>
              <div>${item.name || 'BDC'}</div>
            </div>
            <div class="stamp">${lastISO ? timeAgo(lastISO) : '‚Äî'}</div>
          </div>
          ${showPMS ? productBlock(item, 'PMS', 'chip-pms') : ''}
          ${showAGO ? productBlock(item, 'AGO', 'chip-ago') : ''}
        </div>
      </div>
    `;
  }

  function destroyMiniCharts(){ charts.forEach(ch => { try { ch.destroy(); } catch(e){} }); charts.clear(); }
  function destroyTopCharts(){ if(topPMSChart){ try{ topPMSChart.destroy(); }catch(e){} topPMSChart=null; } if(topAGOChart){ try{ topAGOChart.destroy(); }catch(e){} topAGOChart=null; } }

  function observeAndDrawMini(canvas, series, lineColor){
    const draw = () => {
      const key = canvas.dataset.key;
      if (charts.has(key)) return;
      const data = series.map(p=>({ x: p.t, y: p.y }));
      const ch = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: { datasets: [{ data, tension:.35, pointRadius:0, borderWidth:2, borderColor: lineColor }]},
        options: {
          responsive: true, maintainAspectRatio: false, animation: !prefersReduced,
          parsing: false,
          plugins: { legend: { display:false }, tooltip:{ enabled:true } },
          scales: { x:{ display:false, type:'time' }, y:{ display:false } }
        }
      });
      charts.set(key, ch);
    };
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry=>{ if (entry.isIntersecting){ draw(); obs.unobserve(entry.target); } });
    }, { root: null, threshold: 0.1 });
    io.observe(canvas);
  }

  function drawTopCharts(data){
    if(!data || !data.top_lists) return;
    destroyTopCharts();

    const ctxP = document.getElementById('topPMS').getContext('2d');
    const ctxA = document.getElementById('topAGO').getContext('2d');

    const palette = [
      '#22c55e','#3b82f6','#eab308','#ef4444','#a855f7',
      '#14b8a6','#f97316','#06b6d4','#84cc16','#8b5cf6',
      '#10b981','#f59e0b','#0ea5e9'
    ];

    const seriesFor = (bid, product) => {
      const card = data.bdcs?.find(x => x._id === bid);
      return card?.prices?.[product]?.series || [];
    };

    function buildDatasets(product, infoEl){
      const list = data.top_lists?.[product] || [];
      if (list.length === 0){ if(infoEl) infoEl.textContent = ''; return []; }
      const mostRecentTs = list.find(x=>x.time)?.time;
      if(infoEl) infoEl.textContent = mostRecentTs ? `Updated ${timeAgo(mostRecentTs)}` : '';

      return list.map((r, i) => ({
        label: `${r.name} ‚Äî GHS ${Number(r.price).toFixed(3)}${(r.change_pct!==undefined && r.change_pct!==null)?` (${(r.change_pct>0?'+':'')+Number(r.change_pct).toFixed(2)}%)`:''}`,
        data: seriesFor(r._id, product).map(p => ({ x: p.t, y: p.y })),
        borderWidth: 2, borderColor: palette[i % palette.length], pointRadius: 0, tension: .35
      }));
    }

    const gridColor = (getComputedStyle(document.documentElement).getPropertyValue('--line') || '#e2e8f0').trim();
    const commonOpts = {
      responsive:true, maintainAspectRatio:false, animation: !prefersReduced, parsing:false, interaction:{ mode:'nearest', intersect:false },
      plugins:{ legend:{ display:true, position:'bottom', labels:{ boxWidth:10, usePointStyle:true } },
                tooltip:{ callbacks:{ label: (ctx)=> ` ${ctx.dataset.label} ‚Ä¢ ${fmt(ctx.parsed.y)}` } } },
      scales:{ x:{ type:'time', time:{ tooltipFormat:'MMM d, HH:mm' }, grid:{ display:false } },
               y:{ grid:{ color: gridColor }, ticks:{ callback:(v)=>`GHS ${fmt(v)}` } } }
    };

    const dsP = buildDatasets('PMS', $pmsInfo);
    const dsA = buildDatasets('AGO', $agoInfo);

    topPMSChart = new Chart(ctxP, { type:'line', data:{ datasets: dsP }, options: commonOpts });
    topAGOChart = new Chart(ctxA, { type:'line', data:{ datasets: dsA }, options: commonOpts });
  }

  function renderBoard(data){
    lastData = data;

    // keep the location list fresh (based on latest fetch result)
    populateLocations(data);

    // clone and compute sort keys
    const pf = $prodFilter.value;
    const sorted = [...(data.bdcs || [])];
    sorted.forEach(d=>{
      const tP = d.prices?.PMS?.current?.time;
      const tA = d.prices?.AGO?.current?.time;
      const lastT = [tP,tA].filter(Boolean).map(x=>new Date(x).getTime());
      d._lastUpdated = lastT.length ? Math.max(...lastT) : 0;

      if(pf === 'PMS') d._price = d.prices?.PMS?.current?.price ?? -Infinity;
      else if(pf === 'AGO') d._price = d.prices?.AGO?.current?.price ?? -Infinity;
      else d._price = Math.max(
        d.prices?.PMS?.current?.price ?? -Infinity,
        d.prices?.AGO?.current?.price ?? -Infinity
      );
    });

    const sortBy = $sortBy.value;
    if(sortBy === 'updated_desc') sorted.sort((a,b)=>b._lastUpdated - a._lastUpdated);
    if(sortBy === 'price_desc')   sorted.sort((a,b)=>(b._price - a._price));
    if(sortBy === 'price_asc')    sorted.sort((a,b)=>(a._price - b._price));

    const html = sorted.map(cardTemplate).filter(Boolean).join('').trim();
    $grid.innerHTML = html || `<div class="col-12"><div class="empty">No prices match the current filters.</div></div>`;

    // mini-charts
    const canvases = Array.from(document.querySelectorAll('canvas.spark'));
    destroyMiniCharts();
    canvases.forEach(cv=>{
      const key = cv.dataset.key;  // "<bdcId>-PMS" or "<bdcId>-AGO"
      const [bdcId, prod] = key.split('-');
      const card = (data.bdcs || []).find(x => x._id === bdcId);
      const series = card?.prices?.[prod]?.series || [];
      const color = (prod === 'PMS')
          ? getComputedStyle(document.documentElement).getPropertyValue('--pms')
          : getComputedStyle(document.documentElement).getPropertyValue('--ago');
      observeAndDrawMini(cv, series, (color||'#22c55e').trim());
    });

    // top charts
    drawTopCharts(data);
  }

  let inflightFetchId = 0;
  async function fetchBoard(){
    try{ fetchController?.abort(); }catch(e){}
    fetchController = new AbortController();
    const reqId = ++inflightFetchId;

    const params = new URLSearchParams();
    params.set('history_points', HISTORY_POINTS);
    params.set('products', currentProductsParam());
    if (qsToken) params.set('token', qsToken);

    const url = `/prices/api/board_data?${params.toString()}`;
    try{
      showSpinner(true);
      const res = await fetch(url, { signal: fetchController.signal, cache:'no-store' });
      if(!res.ok) throw new Error('Network error');
      const j = await res.json();
      if(j && j.ok !== true){ throw new Error(j?.error || 'Failed loading data'); }
      if (reqId !== inflightFetchId) return; // drop stale response

      $alert.innerHTML = '';
      (window.requestIdleCallback || window.requestAnimationFrame)(() => renderBoard(j));
    }catch(err){
      if(!$grid.querySelector('.bdc-card')){
        $grid.innerHTML = `<div class="col-12"><div class="empty">Couldn‚Äôt load board. Check your connection.</div></div>`;
      }
      alertMsg('Trouble refreshing prices. Retrying‚Ä¶', 'warning');
    } finally {
      showSpinner(false);
    }
  }

  // Filters & search events
  $prodFilter?.addEventListener('change', fetchBoard);
  $sortBy?.addEventListener('change', fetchBoard);
  $locFilter?.addEventListener('change', () => renderBoard(lastData));

  let searchTimer = null;
  $searchBox?.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => renderBoard(lastData), 200);
  });

  // Share flow (only if Share exists)
  const genBtn = document.getElementById('genShareBtn');
  if(genBtn){
    genBtn.addEventListener('click', async ()=>{
      const idSel = document.getElementById('shareBdc');
      const id = idSel?.value || '';
      const box = document.getElementById('shareResult');
      box.textContent = '';
      if(!id){ box.textContent = 'Please choose a BDC.'; return; }
      try{
        showSpinner(true);
        const fd = new FormData(); fd.append('bdc_id', id);
        const res = await fetch('/prices/share_link', {
          method:'POST', body: fd, headers: { 'Accept': 'application/json' }
        });
        let j; try { j = await res.json(); } catch(e){ throw new Error('Unexpected response'); }
        if(!j.ok){ box.textContent = j.error || 'Failed.'; return; }
        box.innerHTML = `Link: <a href="${j.share_url}" target="_blank" rel="noopener">${j.share_url}</a><br>
          <a class="btn btn-sm btn-success mt-2" href="${j.wa_url}" target="_blank" rel="noopener">Share via WhatsApp</a>`;
      }catch(e){
        box.textContent = (e && e.message) ? e.message : 'Error generating link.';
      } finally{
        showSpinner(false);
      }
    });
  }

  // Initial + polling
  (async function init(){
    await fetchBoard();
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(fetchBoard, POLL_MS);
  })();
})();
</script>
</body>
</html>
