<!-- templates/prices/post.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Post Price – {{ bdc_name }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="icon" href="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" type="image/png">

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937;
      --accent:#06b6d4; --ok:#22c55e; --err:#ef4444;
    }
    *{ box-sizing:border-box }
    body{ background:var(--bg); color:var(--ink); min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:24px; }

    .panel{
      width:min(680px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,.45);
      padding:20px 18px;
    }
    .brand{ display:flex; align-items:center; gap:.6rem; }
    .brand-badge{
      width:36px; height:36px; border-radius:10px; display:grid; place-items:center;
      font-weight:900; color:#0b1220; background:linear-gradient(135deg,#e2e8f0,var(--accent));
      border:1px solid var(--line);
    }
    .hint{ color:var(--muted); font-size:.95rem }

    .prod-group{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .prod-chip input{ display:none }
    .prod-chip label{
      cursor:pointer; padding:.5rem .9rem; border-radius:999px; border:1px solid var(--line);
      font-weight:800; letter-spacing:.2px; color:var(--ink); background:#0c1627;
      user-select:none;
    }
    .prod-chip input:checked + label{ background:#e5e7eb; color:#111827; border-color:#cbd5e1; }

    .input-dark{ background:#0c1627; color:var(--ink); border-color:#334155; }
    .input-dark:focus{ background:#0c1627; color:var(--ink); border-color:var(--accent); box-shadow:0 0 0 0.2rem rgba(6,182,212,.15) }

    .btn-primary{ background:var(--accent); border-color:var(--accent); font-weight:700 }
    .btn-primary:disabled{ opacity:.6 }

    .spinner-inline{
      display:inline-block; width:1rem; height:1rem; border:.2rem solid rgba(255,255,255,.35);
      border-top-color:#fff; border-radius:50%; animation:spin .9s linear infinite; vertical-align:middle;
    }
    @keyframes spin{ to { transform:rotate(360deg) } }

    .footer{
      margin-top:14px; color:var(--muted); text-align:center; font-size:.9rem;
      display:flex; gap:.5rem; align-items:center; justify-content:center; flex-wrap:wrap;
    }
    .footer img{ height:20px; width:auto; border-radius:6px; border:1px solid var(--line); background:#fff; }
  </style>
</head>
<body>
  <div class="panel">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div class="brand">
        <div class="brand-badge">BD</div>
        <div>
          <h5 class="mb-0">Post Price</h5>
          <div class="hint">Posting as <strong>{{ bdc_name }}</strong>. Select a product and enter your <em>current</em> price (GHS/L).</div>
        </div>
      </div>
      <a class="btn btn-sm btn-outline-light" href="/prices?token={{ token }}">View Board</a>
    </div>

    <form id="priceForm" class="row g-3" novalidate>
      <input type="hidden" name="token" value="{{ token }}" />

      <div class="col-12">
        <label class="form-label fw-bold">Product</label>
        <div class="prod-group">
          {% for p in products %}
            <div class="prod-chip">
              <input id="p-{{ p }}" type="radio" name="product" value="{{ p }}" {% if loop.first %}checked{% endif %}/>
              <label for="p-{{ p }}">{{ p }}</label>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="col-12">
        <label class="form-label fw-bold">Price (GHS/L)</label>
        <input
          type="number"
          step="0.001"
          min="0.010"
          inputmode="decimal"
          name="price"
          class="form-control input-dark"
          placeholder="e.g. 8.450"
          required
        />
        <div class="form-text text-secondary">Use a decimal point. Example: <code>8.450</code></div>
      </div>

      <!-- NEW: Product Location -->
      <div class="col-12">
        <label class="form-label fw-bold">Product Location</label>
        <input
          type="text"
          name="location"
          class="form-control input-dark"
          placeholder="e.g. Tema Depot, Takoradi, Kumasi"
          maxlength="120"
          required
        />
        <div class="form-text text-secondary">Where this price applies (city/depot/region).</div>
      </div>

      <!-- NEW: Description (optional) -->
      <div class="col-12">
        <label class="form-label fw-bold">Description <span class="text-secondary">(optional)</span></label>
        <textarea
          name="description"
          rows="3"
          class="form-control input-dark"
          placeholder="Short note, e.g. 'Bulk only, valid today' or 'Includes loading fees'."
          maxlength="300"
        ></textarea>
      </div>

      <div class="col-12 d-flex gap-2">
        <button id="submitBtn" type="submit" class="btn btn-primary">
          <span class="btn-label">Submit</span>
        </button>
        <button id="resetBtn" type="button" class="btn btn-outline-light">Reset</button>
      </div>
    </form>

    <div id="result" class="mt-3"></div>

    <div class="footer">
      Powered by Truetype Services • <span id="year"></span>
      <img src="https://res.cloudinary.com/dl2ipzxyk/image/upload/v1751107241/logo_ijmteg.avif" alt="Truetype Services Logo"/>
    </div>
  </div>

<script>
(function(){
  const form = document.getElementById('priceForm');
  const result = document.getElementById('result');
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const btnLabel = submitBtn.querySelector('.btn-label');

  document.getElementById('year').textContent = new Date().getFullYear();

  function fmt(n){
    n = Number(n);
    return Number.isFinite(n) ? n.toLocaleString(undefined,{ minimumFractionDigits:2, maximumFractionDigits:4 }) : '0.00';
  }

  function setBusy(isBusy){
    if(isBusy){
      submitBtn.disabled = true;
      btnLabel.innerHTML = '<span class="spinner-inline" aria-hidden="true"></span> Submitting…';
    }else{
      submitBtn.disabled = false;
      btnLabel.textContent = 'Submit';
    }
  }

  resetBtn.addEventListener('click', () => {
    form.reset();
    result.innerHTML = '';
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    result.innerHTML = '';

    const data = new FormData(form);
    const token = data.get('token');
    const product = (data.get('product') || '').toUpperCase().trim();
    const price = parseFloat(data.get('price'));
    const location = (data.get('location') || '').trim();
    const description = (data.get('description') || '').trim();

    if(!token){
      result.innerHTML = '<div class="alert alert-danger">Missing token. Open the link again.</div>';
      return;
    }
    if(!product || (product !== 'PMS' && product !== 'AGO')){
      result.innerHTML = '<div class="alert alert-danger">Please select a valid product (PMS or AGO).</div>';
      return;
    }
    if(!Number.isFinite(price) || price <= 0){
      result.innerHTML = '<div class="alert alert-danger">Enter a valid price.</div>';
      return;
    }
    if(!location){
      result.innerHTML = '<div class="alert alert-danger">Please enter the product location.</div>';
      return;
    }
    if(description.length > 300){
      result.innerHTML = '<div class="alert alert-danger">Description is too long (max 300 characters).</div>';
      return;
    }

    setBusy(true);
    try{
      const res = await fetch('/prices/post', {
        method: 'POST',
        body: data,
        headers: { 'Accept': 'application/json' }
      });

      let j;
      try { j = await res.json(); }
      catch(_){ throw new Error('Unexpected response from server'); }

      if(!res.ok || !j.ok){
        const msg = (j && (j.error || j.message)) ? j.error || j.message : 'Failed to submit.';
        result.innerHTML = `<div class="alert alert-danger">${msg}</div>`;
        return;
      }

      result.innerHTML = `
        <div class="alert alert-success">
          Submitted: <strong>${j.product}</strong> at <strong>GHS ${fmt(j.price)}</strong>
          for <strong>${j.location || '—'}</strong>${j.description ? ` — <em>${j.description}</em>` : ''}.
          <a href="/prices?token={{ token }}" class="alert-link">Go to board</a>.
        </div>
      `;
      form.reset();
    }catch(err){
      result.innerHTML = `<div class="alert alert-danger">${err?.message || 'Network error. Try again.'}</div>`;
    }finally{
      setBusy(false);
    }
  });
})();
</script>
</body>
</html>
