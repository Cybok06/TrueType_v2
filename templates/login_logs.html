<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Login Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .table thead th { white-space: nowrap; }
    .log-json { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .85rem; }
.text-truncate-2{
  display: -webkit-box;
  -webkit-line-clamp: 2; /* WebKit prefix */
  line-clamp: 2;         /* Standard property (fixes the warning) */
  -webkit-box-orient: vertical;
  overflow: hidden;
}
    .badge-reason { text-transform: capitalize; }
  </style>
</head>
<body class="p-3">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/admin/dashboard"><i class="bi bi-arrow-left"></i> Back</a>
        <h4 class="mb-0">Login Logs</h4>
      </div>
      <form method="post" action="{{ url_for('login_logs_bp.purge_login_logs') }}" class="m-0">
        <button class="btn btn-outline-danger btn-sm" title="Delete logs older than 30 days">
          <i class="bi bi-trash3"></i> Purge 30+ days
        </button>
      </form>
    </div>

    <!-- Filters -->
    <form class="card mb-3 p-3">
      <div class="row g-2">
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Username</label>
          <input type="text" class="form-control" name="username" value="{{ q_username }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label mb-1">IP</label>
          <input type="text" class="form-control" name="ip" value="{{ q_ip }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label mb-1">Success</label>
          <select class="form-select" name="success">
            <option value="" {{ 'selected' if not q_success }}>Any</option>
            <option value="true"  {{ 'selected' if q_success=='true'  }}>Success</option>
            <option value="false" {{ 'selected' if q_success=='false' }}>Failure</option>
          </select>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">Reason</label>
          <input type="text" class="form-control" name="reason" placeholder="ok / blocked / bad_password ..." value="{{ q_reason }}">
        </div>
        <div class="col-6 col-md-1">
          <label class="form-label mb-1">Per page</label>
          <input type="number" min="10" max="200" class="form-control" name="per_page" value="{{ per_page }}">
        </div>
        <div class="col-6 col-md-1 d-flex align-items-end">
          <button class="btn btn-primary w-100"><i class="bi bi-search"></i></button>
        </div>
      </div>
    </form>

    <!-- Table -->
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-secondary">
            <tr>
              <th>Time (UTC)</th>
              <th>User / Kind</th>
              <th>Status</th>
              <th>IP / Location</th>
              <th>User-Agent</th>
              <th>Ref</th>
              <th style="width: 80px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td><small>{{ r.ts.strftime('%Y-%m-%d %H:%M:%S %Z') if r.ts.tzinfo else r.ts.strftime('%Y-%m-%d %H:%M:%S') }}</small></td>
              <td>
                <div><strong>{{ (r.who or {}).get('username','-') }}</strong></div>
                <div><span class="badge text-bg-light">{{ (r.who or {}).get('kind','unknown') }}</span></div>
              </td>
              <td>
                {% if (r.result or {}).get('success') %}
                  <span class="badge text-bg-success">Success</span>
                {% else %}
                  <span class="badge text-bg-danger">Failure</span>
                {% endif %}
                <div class="badge bg-secondary-subtle text-dark badge-reason mt-1">
                  {{ (r.result or {}).get('reason','') }}
                </div>
              </td>
              <td>
                <div><code>{{ (r.req or {}).get('ip','-') }}</code></div>
                {% set geo = r.get('geo') or {} %}
                {% if geo.get('ok') %}
                  <small class="text-muted">
                    {{ geo.get('city') or '-' }}, {{ geo.get('region') or '-' }}, {{ geo.get('country') or '-' }}
                  </small>
                {% else %}
                  <small class="text-muted">-</small>
                {% endif %}
              </td>
              <td><small class="text-truncate-2" style="max-width:340px">{{ (r.req or {}).get('ua','') }}</small></td>
              <td><small class="text-truncate" style="max-width:220px; display:inline-block">{{ (r.req or {}).get('ref','') }}</small></td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-secondary" onclick="viewLog('{{ r._id }}')">
                  <i class="bi bi-eye"></i>
                </button>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center text-muted py-4">No logs.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pager -->
      <div class="card-footer d-flex justify-content-between">
        <div>
          <form method="get" class="d-inline">
            <input type="hidden" name="username" value="{{ q_username }}">
            <input type="hidden" name="ip" value="{{ q_ip }}">
            <input type="hidden" name="success" value="{{ q_success }}">
            <input type="hidden" name="reason" value="{{ q_reason }}">
            <input type="hidden" name="per_page" value="{{ per_page }}">
            <input type="hidden" name="page" value="{{ page-1 }}">
            <button class="btn btn-outline-secondary btn-sm" {% if page<=1 %}disabled{% endif %}>
              <i class="bi bi-chevron-left"></i> Prev
            </button>
          </form>
        </div>
        <div><small>Page {{ page }}</small></div>
        <div>
          <form method="get" class="d-inline">
            <input type="hidden" name="username" value="{{ q_username }}">
            <input type="hidden" name="ip" value="{{ q_ip }}">
            <input type="hidden" name="success" value="{{ q_success }}">
            <input type="hidden" name="reason" value="{{ q_reason }}">
            <input type="hidden" name="per_page" value="{{ per_page }}">
            <input type="hidden" name="page" value="{{ page+1 }}">
            <button class="btn btn-outline-secondary btn-sm" {% if not has_next %}disabled{% endif %}>
              Next <i class="bi bi-chevron-right"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">Log details</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <pre class="log-json" id="logJson">{}</pre>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function viewLog(id){
      try{
        const res = await fetch(`/logs/login/${encodeURIComponent(id)}/json`);
        const out = await res.json();
        if(!out.ok){ alert(out.error || 'Failed to load.'); return; }
        document.getElementById('logJson').textContent = JSON.stringify(out.log, null, 2);
        new bootstrap.Modal(document.getElementById('logModal')).show();
      }catch(e){
        alert('Network error.');
      }
    }
    window.viewLog = viewLog;
  </script>
</body>
</html>
